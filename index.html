<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zn">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="notifyのblog">
<meta property="og:url" content="http://notify-bibi.github.io/index.html">
<meta property="og:site_name" content="notifyのblog">
<meta property="og:locale">
<meta property="article:author" content="notify">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://notify-bibi.github.io/"/>





  <title>notifyのblog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zn">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">notifyのblog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2021/03/01/ARM%E6%8C%87%E4%BB%A4%E5%B8%B8%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/01/ARM%E6%8C%87%E4%BB%A4%E5%B8%B8%E8%AF%86/" itemprop="url">ARM指令 常识</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-01T22:55:09+08:00">
                2021-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ARM/" itemprop="url" rel="index">
                    <span itemprop="name">ARM</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="arm"><a href="#arm" class="headerlink" title="arm"></a>arm</h1><p>ARM属于RISC架构</p>
<p> ARM指令集是（32　）位宽，Thumb指令集是（16　）位宽的。</p>
<p>复位后，ARM处理器处于（SVC）模式，（ARM） 状态</p>
<p> ARM处理器总共（ 37个）个寄存器，System模式下使用（17个）个寄存器，SVC模式下使用（18个）个寄存器。</p>
<p>ARM处理器中优先级别最高的异常为（RESET），（ FIQ、IRQ）异常可以用来相应中断</p>
<p> ATPCS规定中，推荐子函数参数最大为（4） 个</p>
<p> ATPCS规定中，栈是（满减）</p>
<p>在用ARM汇编编程是，其寄存器有多个别名，通常PC是指（R15），LR是指（ R14 ），SP是指（R13）</p>
<p>CPSR寄存器中反映处理器状态的位是（T位）</p>
<p>下面属于ARM子程序调用指令的是（BL）</p>
<p>ARM7属于（冯.诺依曼）结构，ARM9属于（哈佛）结构。</p>
<p>ARM7是（3）级流水线，ARM9是（5）级流水线。</p>
<p> ARM中可以访问状态寄存器的指令是（MRS），能够访问内存的指令是（LDR，非MOV）</p>
<p>异步串口中数据位可以是（5,6,7,8）</p>
<p> I2C协议中有几根线（2）</p>
<p> I2C协议中设备地址模式有（7位地址模式\10位地址模式）</p>
<p>S3C2410采用的是（ARM920T）核心</p>
<p>在串行异步通讯中，发送端串口的TxD要和接收端串口的（RxD）相连接</p>
<h3 id="1-简述ARM发生异常时，ARM核心会自动做哪些事情？从异常返回时，我们要做哪些事情？"><a href="#1-简述ARM发生异常时，ARM核心会自动做哪些事情？从异常返回时，我们要做哪些事情？" class="headerlink" title="1.简述ARM发生异常时，ARM核心会自动做哪些事情？从异常返回时，我们要做哪些事情？"></a>1.简述ARM发生异常时，ARM核心会自动做哪些事情？从异常返回时，我们要做哪些事情？</h3><p>1） 当异常产生时, ARM core:</p>
<p>拷贝CPSR到SPSR_<mode><br>设置适当的CPSR位：<br>改变处理器状态进入ARM状态<br>改变处理器模式进入相应的异常模式<br>设置中断禁止位禁止相应中断(如果需要)<br>保存返回地址到LR_<mode><br>设置PC为相应的异常向量</mode></mode></p>
<p>2） 返回时,异常处理需要:</p>
<p>从SPSR_<mode>恢复CPSR<br>从LR_<mode>恢复PC<br>Note:这些操作只能在ARM态执行.</mode></mode></p>
<h3 id="2-用ARM汇编指令写出实现64位加法和64位减法的代码段，使用的寄存器请自行分配。"><a href="#2-用ARM汇编指令写出实现64位加法和64位减法的代码段，使用的寄存器请自行分配。" class="headerlink" title="2.用ARM汇编指令写出实现64位加法和64位减法的代码段，使用的寄存器请自行分配。"></a>2.用ARM汇编指令写出实现64位加法和64位减法的代码段，使用的寄存器请自行分配。</h3><p>假定低32位数存放在r0和r1里面，高32位数存放在r2和r3里面。<br>加法：<br>ADDS r0, r0, r1 //加S是因为要让这个操作影响标志位<br>ADC r2, r2, r3 //ADC是带进位的加法，如果上一条指令产生进位则一起加进来<br>减法：<br>SUBS r0, r0, r1 //加S是因为要让这个操作影响标志位<br>SBC r2, r2, r3 // SBC是带进位的减法指令</p>
<h3 id="3-ARM处理器的模式-各个发生异常时ARM处理器所处的模式"><a href="#3-ARM处理器的模式-各个发生异常时ARM处理器所处的模式" class="headerlink" title="3.ARM处理器的模式:  各个发生异常时ARM处理器所处的模式"></a>3.ARM处理器的模式:  各个发生异常时ARM处理器所处的模式</h3><ul>
<li>User :非特权模式，大部分任务执行在这种模式}</li>
<li>FIQ : 当一个高优先级（fast)}中断产生时将会进入这种模式</li>
<li>IRQ : 当一个低优先级（normal)中断产生时将会进入这种模式}</li>
<li>Supervisor}:当复位或软中断指令执行时将会进入这种模式</li>
<li>Abort :当存取异常时将会进入这种模式}</li>
<li>Undef :}当执行未定义指令时会进入这种模式</li>
<li>System :使用和User模式相同寄存器集的特权模式}</li>
<li>SVC:?</li>
</ul>
<p>ARM处理器的异常:</p>
<ul>
<li>Reset</li>
<li>Data Abort</li>
<li>FIQ</li>
<li>IRQ</li>
<li>Prefetch Abort</li>
<li>SWI</li>
<li>Undefined instruction</li>
</ul>
<h3 id="4-FIQ的什么特点使得它处理的速度比IRQ快？"><a href="#4-FIQ的什么特点使得它处理的速度比IRQ快？" class="headerlink" title="4. FIQ的什么特点使得它处理的速度比IRQ快？"></a>4. FIQ的什么特点使得它处理的速度比IRQ快？</h3><p>1）FIQ优先级比IRQ高，不会被中断<br>2）FIQ有自己的专属寄存器：r8~r12，不用对通用寄存器入栈保护，可以加快速度<br>3）FIQ位于异常向量表的末尾0x1c，故无需跳转，可以在这里直接放置异常处理函数</p>
<h3 id="5-什么指令可以放在中断向量表？"><a href="#5-什么指令可以放在中断向量表？" class="headerlink" title="5.什么指令可以放在中断向量表？"></a>5.什么指令可以放在中断向量表？</h3><p>跳转指令，给PC赋值的指令<br>B，LDR，MOV</p>
<h3 id="6-ARM处理器-中断向量表位于存储器的什么位置？"><a href="#6-ARM处理器-中断向量表位于存储器的什么位置？" class="headerlink" title="6. ARM处理器 中断向量表位于存储器的什么位置？"></a>6. ARM处理器 中断向量表位于存储器的什么位置？</h3><p>默认：0x0<br>也可以配置成：0Xffff0000</p>
<h3 id="7-下列ARM指令将做什么"><a href="#7-下列ARM指令将做什么" class="headerlink" title="7.下列ARM指令将做什么?"></a>7.下列ARM指令将做什么?</h3><p>a) LDRH r0,[r1,#6]<br>b) LDR r0, =0x999<br>a：将r1寄存器的值加上6，然后把以这个值为地址的内存单元里的值取半字（低16位）赋给r0<br>b：将立即数0x999赋给r0，注意这是一个伪指令</p>
<h3 id="8-SWP指令的优势是什么-用来实现什么功能？"><a href="#8-SWP指令的优势是什么-用来实现什么功能？" class="headerlink" title="8. SWP指令的优势是什么?用来实现什么功能？"></a>8. SWP指令的优势是什么?用来实现什么功能？</h3><p>功能：在寄存器和存储器之间，由一次存储器读和一次存储器写组成的原子操作。完成一个字节或字的交换。<br>可以用来实现信号量</p>
<h3 id="9-S3C2410支持几种引导方式（或者说是内存映射方式）？简述Nand引导方式S3C2410硬件做的事情。"><a href="#9-S3C2410支持几种引导方式（或者说是内存映射方式）？简述Nand引导方式S3C2410硬件做的事情。" class="headerlink" title="9. S3C2410支持几种引导方式（或者说是内存映射方式）？简述Nand引导方式S3C2410硬件做的事情。"></a>9. S3C2410支持几种引导方式（或者说是内存映射方式）？简述Nand引导方式S3C2410硬件做的事情。</h3><p>1）nor flash启动方式。<br>2）nand flash启动方式。<br>从Nand flash启动时，S3C2410首先会执行固化在片上ROM中的一段小程序，这段程序负责将nand flash前2K的代码搬移到片上RAM，然后将PC指针指向0x0地址（注意这个时候片上RAM被映射到0x0的起始地址）</p>
<h3 id="10-简述static和volatile关键字的含义和作用。"><a href="#10-简述static和volatile关键字的含义和作用。" class="headerlink" title="10.简述static和volatile关键字的含义和作用。"></a>10.简述static和volatile关键字的含义和作用。</h3><p>c语言中static关键字有两个作用，一是文件作用域，二是函数作用域。<br>文件作用域关键字static的作用是，以static申明的全局变量、函数不得被其他文件所引用<br>static另外一个用途是函数内部静态变量，只会被初始化一次，而且变量存储在全局数据段中而不是函数栈中，所以其生命期会一直持续到程序退出<br>一个定义为volatile的变量是说这变量可能会被意想不到地改变，这样，编译器就不会去假设这个变量的值了。精确地说就是，优化器在用到这个变量时必须每次都小心地重新读取这个变量的值，而不是使用保存在寄存器里的备份</p>
<h1 id="ARM指令集"><a href="#ARM指令集" class="headerlink" title="ARM指令集"></a>ARM指令集</h1><p> ARM处理器的指令集可以分为跳转指令、数据处理指令、程序状态寄存器（PSR）处理指令、加载/存储指令、协处理器指令和异常产生指令6大指令。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2021/03/01/winafl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/01/winafl/" itemprop="url">winafl</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-01T22:55:09+08:00">
                2021-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/FUZZ/" itemprop="url" rel="index">
                    <span itemprop="name">FUZZ</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="WINAFL"><a href="#WINAFL" class="headerlink" title="WINAFL"></a>WINAFL</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz</span><br><span class="line">afl-fuzz [afl options] -- [instrumentation options] -- target_cmd_line</span><br><span class="line">其中[afl options]常用的参数包括（这些参数由afl-fuzz.exe处理）：</span><br><span class="line">-i    input directory with test cases</span><br><span class="line">-o  output directory for fuzzer findings</span><br><span class="line">-D  directory with DynamoRIO binaries (drrun, drconfig)</span><br><span class="line">-t    timeout for each run</span><br><span class="line">-f    location read by the fuzzed program (stdin)</span><br><span class="line">-x   optional fuzzer dictionary (see README)  字典文件</span><br><span class="line">[instrumentation options]常用的参数包括:</span><br><span class="line">-coverage_module 	– fuzzing对象程序会调用到的模块,设置要记录的模块，支持多个模块的记录</span><br><span class="line">-target_module 		– fuzzing对象模块，也就是-target_offset所在的模块</span><br><span class="line">-target_offset 		– fuzzing的偏移地址，也就是会被instrumentation的偏移</span><br><span class="line">-target_method       	– 只有有符号表的情况下才能用的方法，根据符号名去设置偏移</span><br><span class="line">-fuzz_iterations 		– 再fuzzing对象程序重新启动一次内运行目标函数的最大迭代数</span><br><span class="line">-debug 			– debug模式</span><br><span class="line">target_cmd_line参数就是你要fuzzing对象的启动程序。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Winafl是一个开源的优秀半自动化fuzz测试工具，相比较其他的公开fuzz测试工具还是有很大的优势的</span><br><span class="line">daɪnəməʊ RIO</span><br><span class="line">DynamoRIO应该算是winafl的核心部分，它主要实现的是指令动态插桩，其实就是之前我提到的指令扩展，对函数输入输出进行一定的检查。关于DynamoRIO的原理以及介绍在网上有很多描述，这里不做过多介绍了。</span><br><span class="line"> </span><br><span class="line">用DynamoRIO测试过程</span><br><span class="line">这里我们要用到的是DynamoRIO的ddrun.exe工具，</span><br><span class="line">afl-fuzz.exe通过-i参数指向的目录读取用户提供的测试文件，并通过各种变形存储到out&#x2F;.cur_input文件，供被fuzzing的应用程序调用打开，查看afl_fuzz.c可以发现其对测试用例都做过哪些变形。</span><br><span class="line"></span><br><span class="line">-i   测试用例存放目录, 测试样本的输入目录</span><br><span class="line">-o  fuzzing过程和fuzz结果的输出目录</span><br><span class="line">-D  DynamoRIO所处的目录</span><br><span class="line">-t   每次的运行时间</span><br><span class="line">-f   被fuzz的进程要读取的文件</span><br><span class="line">-x  可选fuzzer目录</span><br><span class="line"></span><br><span class="line">使用说明</span><br><span class="line">首先找出要fuzz的函数基于模块的地址偏移</span><br><span class="line">要保证程序可以正常的跑在DynamoRIO下面，可以通过WinAFL的独立调试模式来测试这一点。独立调试模式不会使用fuzz部分(使用-debug选项)</span><br><span class="line">要想正常运行，必须要保证afl-fuzz.exe和winafl.dll在同一目录下</span><br><span class="line">afl-fuzz [afl options] -- [instrumentation options] -- target_cmd_line</span><br><span class="line"></span><br><span class="line">-D选项是必须启用的，用于指定DynamoRIO所处的目录</span><br><span class="line">-t 选项也是必须启用的，由于不同的选项导致的执行效率不同。所以-t的时间应该灵活设置。</span><br><span class="line">默认是支持多线程的程序记录的。如果是单线程程序可以使用-covtype edge选项</span><br><span class="line">instrumentation options</span><br><span class="line">-covtype                  设置记录方式，为多线程和单线程程序所使用。bb&#x2F;edge</span><br><span class="line">-coverage_module  设置要记录的模块，支持多个模块的记录</span><br><span class="line">-target_module       fuzz目标函数所处的模块，必须要设置-target_method或-target_offset</span><br><span class="line">-target_method       只有有符号表的情况下才能用的方法，根据符号名去搞</span><br><span class="line">-target_offset          要fuzz函数的相对模块头的偏移</span><br><span class="line">-fuzz_iterations       目标函数的最大迭代次数</span><br><span class="line">-nargs                     被fuzz的函数有几个参数？</span><br><span class="line">-debug                    不会连接fuzzer部分，只会输出一个日志文件。包含加载的模块、打开的文件和输出报告。</span><br><span class="line">-logdir                     只在-debug下可用，输出的log文件的位置</span><br><span class="line">coverage_module可以有多个，target_module只有一个</span><br><span class="line"></span><br><span class="line">.\afl-fuzz.exe -i in -o out -t 200000000+ -D .\ -- -coverage_module gdiplus.dll -fuzz_iterations 5000 -target_module test_gdiplus.exe -target_method main -nargs 2 -- test_gdiplus.exe not_kitty.bmp @@</span><br><span class="line">其中 “@@” 表示待 fuzzing 的测试用例文件在 in 目录下</span><br><span class="line">drrun.exe -pidfile childpid_38a0fc9cc4272ad6.txt -no_follow_children -c winafl.dll -coverage_module gdiplus.dll -coverage_module WindowsCodecs.dll -fuzz_iterations 5000 -target_module test_gdiplus.exe -target_method main -nargs 2 -fuzzer_id 38a0fc9cc4272ad6 -- test_gdiplus.exe out\.cur_input</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id><a href="#" class="headerlink" title></a></h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2021/03/01/test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/01/test/" itemprop="url">test</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-01T22:55:09+08:00">
                2021-03-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2021/03/01/test/%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC%E5%9B%BE.jpg" alt="df"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/" itemprop="url">源码审计工具调研</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-01T22:55:09+08:00">
                2021-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/source-code-review/" itemprop="url" rel="index">
                    <span itemprop="name">source code-review</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><p>​    C/C++语言的语法拥有其它语言所没有的灵活性，这种灵活性带来了代码效 率的提升，但相应也使得代码编写具有很大的随意性，另外 C/C++编译器不进 行强制类型检查，也不做任何边界检查，这就增加了代码中存在隐患的可能性。 如果能够在代码提交测试之前发现这些潜在的错误，就能够极大地减轻测试人员 的压力，减少软件项目的除错成本，可是传统的 C/C++编译器对此已经无能为力，这个任务只能由专用的代码检查工具完成。</p>
<p>​    </p>
<h1 id="llvm-amp-clang"><a href="#llvm-amp-clang" class="headerlink" title="llvm &amp; clang"></a>llvm &amp; clang</h1><ul>
<li>LLVM 是个很大很大的项目群，几乎把从编译到调试的各个构建环节都重新实现了一遍，目的：一是尽可能地模块化现有代码以方便在此基础上进行二次开发、一是提供比传统构建工具链更好的用户体验。clang是LLVM的子项目，是一款非常优秀的C++ 编译器，前端 clang + 后端 LLVM（后简称 LLVM/clang）就是一款可替代 GCC 的优秀编译</li>
<li>GCC 配套的标准库涉及 libstdc++ 和 libsupc++ 两个子库，前者是接口层（即，上层的封装），后者是实现层（即，底层的具体实现），对应到clang，则libc++（接口层）和 libc++abi（实现层）</li>
</ul>
<p>-&gt;IR-&gt;x86,arm,ppc,mips,amd64</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>:</span><br><span class="line"><span class="number">2</span>: <span class="function"><span class="keyword">char</span> *<span class="title">test</span><span class="params">( <span class="keyword">int</span> m, <span class="keyword">int</span> n, <span class="keyword">char</span> *p )</span></span></span><br><span class="line">3：&#123;</span><br><span class="line"><span class="number">4</span>： <span class="keyword">int</span> result;</span><br><span class="line"><span class="number">5</span>： <span class="keyword">char</span> *temp;</span><br><span class="line"><span class="number">6</span>： <span class="keyword">long</span> nm;</span><br><span class="line"><span class="number">7</span>： <span class="keyword">int</span> i, k, kk;</span><br><span class="line"><span class="number">8</span>： <span class="keyword">char</span> name[<span class="number">11</span>] = <span class="string">&quot;Joe Jakeson&quot;</span>;</span><br><span class="line"><span class="number">9</span>：</span><br><span class="line"><span class="number">10</span>： nm = n * m;</span><br><span class="line"><span class="number">11</span>： temp = p == <span class="string">&quot;&quot;</span> ? <span class="string">&quot;null&quot;</span> : p;</span><br><span class="line"><span class="number">12</span>： <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; m; I++ ) &#123;</span><br><span class="line"><span class="number">14</span>： 	k++;</span><br><span class="line"><span class="number">15</span>： 	kk = i;</span><br><span class="line"><span class="number">16</span>： &#125;</span><br><span class="line"><span class="number">17</span>：</span><br><span class="line"><span class="number">18</span>： <span class="keyword">if</span>( k== <span class="number">1</span> ) </span><br><span class="line">  			result = nm;</span><br><span class="line"><span class="number">19</span>： <span class="keyword">else</span> <span class="keyword">if</span>( kk &gt; <span class="number">0</span> ) </span><br><span class="line">  			result = <span class="number">1</span>;</span><br><span class="line"><span class="number">20</span>： <span class="keyword">else</span> <span class="keyword">if</span>( kk &lt; <span class="number">0</span> ) </span><br><span class="line">  			result = <span class="number">-1</span>;</span><br><span class="line"><span class="number">21</span>：</span><br><span class="line"><span class="number">22</span>： <span class="keyword">if</span> (m == result) </span><br><span class="line">  			<span class="keyword">return</span> temp;</span><br><span class="line"><span class="number">23</span>： <span class="keyword">else</span> </span><br><span class="line">  			<span class="keyword">return</span> name;</span><br><span class="line"><span class="number">24</span>：&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>第   8 行向 name 数组赋值时丢掉了结尾的 nul 字符</li>
<li>第 10 行的乘法精度会失准，即使考虑到 long 比 int 的字长更长，由 于符号位的原因仍然会造成精度失准</li>
<li>第 11 行的比较有问题</li>
<li>第 14 行的变量 k 没有初始化</li>
<li>第 15 行的 kk 可能没有被初始化</li>
<li>第 22 行的 result 也有可能 没有被初始化</li>
<li>第 23 行返回的是一个局部对象的地址。</li>
</ul>
<h1 id="TscanCode"><a href="#TscanCode" class="headerlink" title="TscanCode"></a>TscanCode</h1><h2 id="Description"><a href="#Description" class="headerlink" title="Description:"></a>Description:</h2><ul>
<li>TscanCode是鹅厂<strong>静态分析</strong>团队开发的一款开源免费的C/C++静态分析工具。</li>
<li>扫描C/C++代码不需要进行编译， 操作简单。</li>
<li>速度快，平均扫描速度10W行/分钟。误报较多</li>
<li>项目不再维护</li>
<li>结果以图形化或者xml显示</li>
</ul>
<h2 id="Download-："><a href="#Download-：" class="headerlink" title="Download ："></a>Download ：</h2><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/TscanCode">github</a></p>
<h2 id="测试集"><a href="#测试集" class="headerlink" title="测试集"></a>测试集</h2><p><a target="_blank" rel="noopener" href="https://github.com/Tencent/TscanCode/tree/master/samples/cpp">samples/cpp</a></p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage:"></a>Usage:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tscancode --xml func.cpp 2&gt;result.xml</span><br></pre></td></tr></table></figure>

<h1 id="scan-build"><a href="#scan-build" class="headerlink" title="scan-build *****"></a>scan-build *****</h1><h2 id="description"><a href="#description" class="headerlink" title="description"></a>description</h2><ul>
<li>scan-build 是一个命令行工具，它是一款<strong>静态分析</strong>器，是clang-tools的一款工具。</li>
<li>需要编译项目，通过重写cc和cxx环境变量来改变你的编译环境，<code>scan-build</code>将编译器gcc设置为<code>analyze-cc</code>。<code>analyze-cc</code>作为一个<code>伪编译器</code>，转发命令行参数给<code>gcc</code>和<code>clang</code>来执行静态分析。不会分析没有参与编译的源码</li>
<li>精准度非常之高。特别是逻辑上的漏洞很多都可以探查出来。</li>
<li>项目构建完毕后，以html web页面显示代码缺陷报告</li>
</ul>
<p>当一个项目在构建中，源文件在编译时同时也被静态分析器有序的检查着。当构建完成时，结构将会作为一个web网页的形式呈现给使用者。</p>
<h2 id="insall"><a href="#insall" class="headerlink" title="insall"></a>insall</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install clang-8 clang-tools-8</span><br><span class="line">$ la /usr/bin/ | grep scan-build</span><br><span class="line">lrwxrwxrwx 1 root   root      42 Dec 10  2019 scan-build-8 -&gt; ../share/clang/scan-build-8/bin/scan-build</span><br><span class="line">lrwxrwxrwx 1 root   root      45 Dec 10  2019 scan-build-py-8 -&gt; ../share/clang/scan-build-py-8/bin/scan-build</span><br></pre></td></tr></table></figure>



<h2 id="Usage-1"><a href="#Usage-1" class="headerlink" title="Usage"></a>Usage</h2><blockquote>
<p>-h 显示scan-build的所有参数<br>-o html 报告文件的存放目录。默认将报告文件保存在/tmp目录里。<br>-k 增加一个继续运行的参数到具体的命令中<br>-v 冗余输出结果。可以选择2个或3个”-v”增加冗余度。<br>-V 当命令完成后，在浏览器中查看运行结果。</p>
</blockquote>
<p>automake项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scan-build .&#x2F;configure</span><br></pre></td></tr></table></figure>

<p>Cmake</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir build &amp;&amp; cd build </span><br><span class="line">scan-build .&#x2F;cmake ..</span><br></pre></td></tr></table></figure>

<p>Make</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scan-build --use-analyzer &#96;which clang&#96; make -j8</span><br></pre></td></tr></table></figure>



<p>结果请到<code>/tmp/scan-build-xxxxxxxxxxxxxxx/failures</code> 查看。它是 html 的。</p>
<p>比如capstone项目的编译展示    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;aquynh&#x2F;capstone.git &amp;&amp; cd capstone &amp;&amp; git checkout next </span><br><span class="line">mkdir build &amp;&amp; cd build </span><br><span class="line">scan-build-8 --use-analyzer &#96;which clang-8&#96; ..&#x2F;cmake.sh</span><br><span class="line"># 顺带安装下，后面课程需要用到</span><br><span class="line">cd bindings&#x2F;python</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200914233000688-0236398.png" alt="image-20200914233000688"></p>
<h1 id="Cppcheck"><a href="#Cppcheck" class="headerlink" title="Cppcheck***"></a>Cppcheck***</h1><p><a target="_blank" rel="noopener" href="http://cppcheck.net/">官方网站</a></p>
<h2 id="Description-1"><a href="#Description-1" class="headerlink" title="Description"></a>Description</h2><p>CppCheck是一个C/C++代码缺陷静态检查工具。不同于C/C++编译器及其它分析工具，CppCheck只检查编译器检查不出来的bug，不检查语法错误。所谓静态代码检查就是使用一个工具检查我们写的代码是否安全和健壮，是否有隐藏的问题。</p>
<ul>
<li>检出多，有效检出少</li>
<li>无须编译配置项目</li>
<li></li>
</ul>
<h2 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h2><ul>
<li>安装windows包管理器 <a target="_blank" rel="noopener" href="https://chocolatey.org/">https://chocolatey.org/</a></li>
<li><code>choco install cppcheck</code></li>
</ul>
<p>Debian:</p>
<ul>
<li><code>sudo apt-get install cppcheck</code></li>
</ul>
<h2 id="Usage-2"><a href="#Usage-2" class="headerlink" title="Usage"></a>Usage</h2><p>Visual stdio </p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200915131408641.png" alt="image-20200915131408641"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cppcheck . -j 3 --enable&#x3D;all --xml 2&gt;result.xml</span><br></pre></td></tr></table></figure>

<p>multi threads</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cppcheck -j 4 &lt;path&gt;</span><br></pre></td></tr></table></figure>

<p>Visual studio</p>
<p>在整个解决方案上运行 cppcheck：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cppcheck --project&#x3D;&lt;proj&gt;.sln</span><br></pre></td></tr></table></figure>

<p>在单个项目文件上运行 cppcheck：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cppcheck --project=&lt;proj&gt;.vcxproj</span><br></pre></td></tr></table></figure>

<p>其他参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cppcheck --enable&#x3D;warning,performance &lt;path&gt;</span><br><span class="line"># warning,performance 启用警告和性能消息：</span><br><span class="line"># all    启用所有消息</span><br><span class="line"># style  可以启用警告、性能、可移植性和样式信息</span><br><span class="line"># information 启用信息消息</span><br></pre></td></tr></table></figure>

<p>不确定消息： 默认情况下，如果确定，Cppcheck 只显示错误消息。如果使用 <code>--inconclusive</code>，当分析不确定时，也会写错误消息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cppcheck --inconclusive &lt;path&gt;</span><br></pre></td></tr></table></figure>

<p>输出格式：template</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cppcheck --template&#x3D;gcc gui&#x2F;test.cpp</span><br><span class="line"># vs, gcc 编译器输出风格</span><br><span class="line"># &quot;&#123;file&#125;,&#123;line&#125;,&#123;severity&#125;,&#123;id&#125;,&#123;message&#125;&quot; 自定义</span><br></pre></td></tr></table></figure>





<h1 id="PC-lint"><a href="#PC-lint" class="headerlink" title="PC-lint"></a>PC-lint</h1><p><a target="_blank" rel="noopener" href="https://gimpel.com/pclp.html">官网</a></p>
<h2 id="Description-2"><a href="#Description-2" class="headerlink" title="Description"></a>Description</h2><ul>
<li>PC-lint for C/C++是由Gimpel软件公司于1985年开发的代码静态分析工具</li>
<li>它能有效地发现程序语法错误、潜在的错误隐患、不合理的编程习惯等。</li>
<li>PC-lint是资格最老，最强力的代码检查工具</li>
<li>收费软件, 有30天体验</li>
<li>需要完整的项目环境，如头文件等，并且配置起来有一点点麻烦。</li>
<li>PC-Lint 则偏重于代码的逻辑分析，它能够发现代码中潜在的错误，比如数组访 问越界、内存泄漏、使用未初始化变量等</li>
</ul>
<h2 id="Usage-3"><a href="#Usage-3" class="headerlink" title="Usage"></a>Usage</h2><p>PC-Lint能够检查出很多语法错误和语法上正确的逻辑错误，PC-Lint为大部分错误消息都分配了一个错误号，编号小于1000的错误号是分配给C语言的，编号大于1000的错误号则用来说明C++的错误消息。</p>
<ol>
<li>在doc/manual.pdf中给出了错误号</li>
</ol>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200915150904327.png" alt="image-20200915150904327"></p>
<p>以C语言为例，其中的<br>编号 001-199 指的是一般编译器也会产生的语法错误；<br>编号 200-299 是PC-Lint程序内部的错误，这类错误不会出现在代码中的；<br>编号 300-399 指的是由于内存限制等导致的系统致命错误。<br>编号 400-999 中出现的提示信息，是根据隐藏代码问题的可能性进行分类的：<br>编号 400-699 指的是被检查代码中很可能存在问题而产生的告警信息；<br>编号 700-899 中出现的信息，产生错误的可能性相比告警信息来说级别要低，但仍然可能是因为代码问题导致的问题。<br>编号 900-999 是可选信息，他们不会被默认检查，除非你在选项中指定检查他们。</p>
<ol start="2">
<li>PC-Lint/FelexLint 提供了和许多编译器类似的告警级别设置选项 </li>
</ol>
<ul>
<li>-wLevel，它的告警级别分为以下几个级别，缺省告警级别为 3 级： </li>
<li>-w0 不产生信息（除了遇到致命的错误） </li>
<li>-w1 只生成错误信息 – 没有告警信息和其它提示信息 </li>
<li>-w2 只有错误和告警信息 </li>
<li>-w3 生成错误、告警和其它提示信息（这是默认设置） </li>
<li>-w4 生成所有信息</li>
</ul>
<ol start="3">
<li><p>PC-Lint/FelexLint 还提供了用于处理函数库的头文件的告警级别设置选项 </p>
<p>-wlib(Level)，这个选项不会影响处理 C/C++源代码模块的告警级别。<br>它有和 -wLevel 相同的告警级别，缺省告警级别为 3 级：</p>
<ul>
<li>-wlib(0) 不生成任何库信息 </li>
<li>-wlib(1) 只生成错误信息（当处理库的源代码时） </li>
<li>-wlib(2) 生成错误和告警信息 </li>
<li>-wlib(3) 生成错误、告警和其它信息（这是默认设置） </li>
<li>-wlib(4) 产生所有信息</li>
</ul>
</li>
<li><p>PC-Lint 的检查分很多种类，有:</p>
<ul>
<li>强类型检查</li>
<li>变量值跟踪</li>
<li>语义信息</li>
<li>赋值顺序检查</li>
<li>弱定义检查</li>
<li>格式检查</li>
<li>缩进检查</li>
<li>const 变量检查</li>
<li>volatile 变量检查等等。</li>
</ul>
<p>对每一种检查类型，PC-Lint 都有很多详细的选项，用以控制 PC-Lint 的检查效果。</p>
<p>PC-Lint 的选项有 300 多种，这些选项可以放在注释中（以注释 的形式插入代码中）</p>
<p>例如：</p>
<p>​    <code>/*lint option1 option2 ... optional commentary */</code>选项可以有多行     </p>
<p>​    <code>//lint option1 option2 ... optional commentary </code>选项仅为一行（适 用于 C++）</p>
<p> 选项间要以空格分开，lint 命令一定要小写，并且紧跟在/<em>或//后面，不能有空格。</em></p>
<p>如果选项由类似于操作符和操作数的部分组成，例如-esym(534, printf, scanf, operator new)，其中最后一个选项是 operator new，那么在 operator 和 new 中间只能有一个空格。</p>
<p>PC-Lint 的选项还可以放在宏定义中，当宏被展 开时选项才生效。</p>
<p>例如：</p>
<p>​    <code>#define DIVZERO(x) /*lint -save -e54 */ ((x) /0) /*lint -restore */ </code> 允许除数为 0 而不告警</p>
</li>
</ol>
<p>需要把发到邮箱的许可证eval-license.lic文件放到主程序pclp64路径</p>
<p>运行config/pclp_config来自动生成内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ pip install regex pyyaml</span><br><span class="line">$ python3 pclp_config.py --compiler&#x3D;gcc --compiler-bin&#x3D;&#96;which gcc&#96; --config-output-lnt-file&#x3D;co-gcc.lnt --config-output-header-file&#x3D;co-gcc.h --generate-compiler-config</span><br><span class="line">$ python3 pclp_config.py --compiler&#x3D;clang --compiler-bin&#x3D;&#96;which clang-8&#96; --config-output-lnt-file&#x3D;co-clang.lnt --config-output-header-file&#x3D;co-clang.h --generate-compiler-config</span><br><span class="line"></span><br><span class="line">#生成</span><br><span class="line">-rw-rw-r-- 1 u16s u16s  17K Sep 15 17:58 co-gcc.h</span><br><span class="line">-rw-rw-r-- 1 u16s u16s 2.0K Sep 15 17:58 co-gcc.lnt</span><br></pre></td></tr></table></figure>

<p>适当添加 <code>--compiler-options=&quot;--std=c++11&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pclp co.lnt source-files</span><br><span class="line">$ pclp co.lnt -w1 +e900 source-files</span><br></pre></td></tr></table></figure>

<p>windows visual studio</p>
<p>管理员启动 config\pclpvscfg.exe</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\gencfg.bat</span><br></pre></td></tr></table></figure>



<p>大型项目：</p>
<p>On Linux or macOS this can be done with:</p>
<p><strong>export IMPOSTER_LOG=<proj>.commands</proj></strong> </p>
<p>and on Windows:</p>
<p><strong>set IMPOSTER_LOG=<proj>.commands</proj></strong> </p>
<p>编译 imposter</p>
<p>clang-8 config/imposter.c -o imposter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ make -e CC&#x3D;&#x2F;path&#x2F;to&#x2F;imposter </span><br><span class="line"># 生成了 &lt;proj&gt;.commands</span><br><span class="line">$ python3 pclp_config.py\</span><br><span class="line">--compiler&#x3D;gcc\</span><br><span class="line">--imposter-file&#x3D;&lt;proj&gt;.commands\</span><br><span class="line">--config-output-lnt-file&#x3D;project.lnt\</span><br><span class="line">--generate-project-config\</span><br><span class="line">#生成了hello.lnt</span><br><span class="line"></span><br><span class="line">$ pclp64_linux co-gcc.lnt project.lnt 1&gt;output.txt</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>#capstone项目太大， 内存不足炸了</p>
<p>![image-20200915190426990](/Users/notify/Library/Application Support/typora-user-images/image-20200915190426990.png)结果如下，不是很直观</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200915190052759.png" alt="image-20200915190052759"></p>
<h1 id="Coverity"><a href="#Coverity" class="headerlink" title="Coverity"></a>Coverity</h1><h2 id="Coverity概述"><a href="#Coverity概述" class="headerlink" title="Coverity概述"></a>Coverity概述</h2><p>COVERITY是被Gartner、Forrester、 IDC和 VDC权威机构评定为最领先的应用安全测试解决方案(超大规模分布式静态代码检查工具)。世界上几乎所有超大型软件企业都在使用(包括谷歌,亚马逊,洛克希德马丁,空中客车,华为等)。</p>
<p>Coverity公司是由一流的斯坦福大学的科学家于2002年成立的，产品核心技术是1998年至2002年在斯坦福大学计算机系统实验室开发的，用于解决一个计算机科学领域最困难的问题，在2003年发布了第一个能够帮助Linux、FreeBSD等开源项目检测大量关键缺陷的系统。Coverity公司推出的综合开发测试平台，基于新一代的不做代码规则检查、只专注检测代码中的Bug静态分析技术，可以更好地帮助开发人员在写代码的时候就能发现并修复安全缺陷，缩短产品上市时间和降低风险。Coverity是唯一位列IDC前10名软件质量工具供应商的静态分析工具厂商，被VDC评为静态源代码分析领域的领导者。</p>
<h3 id="Coverity支持的语言和"><a href="#Coverity支持的语言和" class="headerlink" title="Coverity支持的语言和"></a>Coverity支持的语言和</h3><p>C/C++ C# Java JavaScript PHP Python ASP.NET Objective-C JSP Node.js Ruby  </p>
<h3 id="支持检测的主要缺陷类型列表："><a href="#支持检测的主要缺陷类型列表：" class="headerlink" title="支持检测的主要缺陷类型列表："></a>支持检测的主要缺陷类型列表：</h3><ul>
<li>API usage errors</li>
<li>Best practice coding errors</li>
<li>Build system issues</li>
<li>Buffer overflows</li>
<li>Class hierarchy inconsistencies</li>
<li>Code maintainability issues</li>
<li>Concurrent data access violations</li>
<li>Control flow issues</li>
<li>Cross-site scripting (XSS)</li>
<li>Cross-site request forgery (CSRF)</li>
<li>Deadlocks</li>
<li>Error handling issues</li>
<li>Hard-coded credentials</li>
<li>Incorrect expression</li>
<li>Insecure data handling</li>
<li>Integer handling issues</li>
<li>Integer overflows</li>
<li>Memory – corruptions</li>
<li>Memory – illegal accesses</li>
<li>Null pointer dereferences</li>
<li>Path manipulation</li>
<li>Performance inefficiencies</li>
<li>Program hangs</li>
<li>Race conditions</li>
<li>Resource leaks</li>
<li>Rule violations</li>
<li>Security best practices violations</li>
<li>Security misconfigurations</li>
<li>SQL Injection</li>
<li>Uninitialized members</li>
</ul>
<p>使用<a target="_blank" rel="noopener" href="https://scan.coverity.com对仓库代码进行coverity静态检查,如果检测到coverity/">https://scan.coverity.com对仓库代码进行coverity静态检查，如果检测到coverity</a> issues会通过邮件通知相关patcher作者或者maintainer进行修改，但是邮件中无法看到issues的详细细节。需要登陆<a target="_blank" rel="noopener" href="https://scan.coverity.com网站去查看详细细节,另外我们需要有方法在向社区提交修复patch之前检查修改后的代码是否能通过coverity检测.本文简述查看issue及对修复代码进行检测的方法./">https://scan.coverity.com网站去查看详细细节，另外我们需要有方法在向社区提交修复patch之前检查修改后的代码是否能通过coverity检测。本文简述查看issue及对修复代码进行检测的方法。</a></p>
<p>有小伙伴说，用公司内部的coverity检查不就行了？不好意思，coverity是商业软件，公司内部使用的版本的和社区使用的版本大概率不同，另外2边检查范围和告警屏蔽配置的不同，导致最终检查出来的结果很可能有差异。</p>
<p><a target="_blank" rel="noopener" href="https://scan.coverity.com/download?tab=cxx">download</a></p>
<h2 id="Usage-4"><a href="#Usage-4" class="headerlink" title="Usage"></a>Usage</h2><h3 id><a href="#" class="headerlink" title></a></h3><h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910171309584.png" alt="image-20200910171309584"></p>
<h3 id="关联Github账户"><a href="#关联Github账户" class="headerlink" title="关联Github账户"></a>关联Github账户</h3><p>在My Account -&gt; Github中 关联自己的Github账户，</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910171600312.png" alt="image-20200910171600312"></p>
<p>去github检查相关项目访问权限<img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910172815718.png" alt="image-20200910172815718"></p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910171901007.png" alt="image-20200910171901007"></p>
<h2 id="添加项目"><a href="#添加项目" class="headerlink" title="添加项目"></a>添加项目</h2><p>来到DashBoard-&gt;Add Projects</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910171942696.png" alt="image-20200910171942696"></p>
<p>开始创建目标分析项目（误将闭源源码泄漏与我无关）</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910172341892.png" alt="image-20200910172341892"></p>
<h3 id="填好项目摘要信息"><a href="#填好项目摘要信息" class="headerlink" title="填好项目摘要信息"></a>填好项目摘要信息</h3><p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910174644153.png" alt="image-20200910174644153"></p>
<p>注意选择缺陷报告访问权限，分别为</p>
<p>1: 公开项目摘要信息和缺陷（只读）</p>
<p>2: 只公开项目摘要信息</p>
<p>3: 需要维护人员授权才可访问项目摘要和缺陷</p>
<h2 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h2><p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910173408953.png" alt="image-20200910173408953"></p>
<p>先使用coverity二进制工具构建好项目并打包再上传即可开始分析</p>
<p>最下侧下载对应系统平台的二进制工具包</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200910195410865.png" alt="image-20200910195410865"></p>
<ol>
<li>下载</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https:&#x2F;&#x2F;scan.coverity.com&#x2F;download&#x2F;linux64 --post-data &quot;token&#x3D;&lt;token&gt;&amp;project&#x3D;&lt;ProjName&gt;&quot; -O coverity_tool.tgz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>解压</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf cov-analysis-linux64-2019.03.tar.gz</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>初始化编译器</li>
</ol>
<p>查看所有编译器配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cov-configure --list-configured-compilers json</span><br></pre></td></tr></table></figure>



<p>gcc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cov-configure --comptype gcc --compiler &#96;which gcc&#96;</span><br></pre></td></tr></table></figure>

<p>clang</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf CMakeCache.txt CMakeFiles</span><br><span class="line">$ cov-configure --comptype clangcxx --compiler &#96;which clang++&#96;</span><br><span class="line">$ export CC&#x3D;&#96;which clang&#96; &amp;&amp; export CXX&#x3D;&#96;which clang++&#96;</span><br></pre></td></tr></table></figure>



<ol start="4">
<li>开始编译项目</li>
</ol>
<p>cd到项目</p>
<p>采用cmake的项目构建框架</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ export CC&#x3D;&#96;which clang++&#96; 可选</span><br><span class="line">$ export CXX&#x3D;&#96;which clang++&#96; 可选</span><br><span class="line">$ cmake ..</span><br><span class="line"># 对代码进行coverity清除和重编：</span><br><span class="line">$ cov-build --dir cov-int bash -c &#39;make clean &amp;&amp; make -j 8&#39; </span><br></pre></td></tr></table></figure>



<p>采用automake的项目构建框架</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ export CXXFLAGS&#x3D;&quot;-O2 -fno-omit-frame-pointer -g&quot;</span><br><span class="line">$ CXX&#x3D;&quot;clang++ $CXXFLAGS&quot; CC&#x3D;&quot;clang $CXXFLAGS&quot; CCLD&#x3D;&quot;clang++ $CXXFLAGS&quot; .&#x2F;configure</span><br><span class="line"># 对代码进行coverity清除和重编：</span><br><span class="line">$ cov-build --dir cov-int bash -c &#39;make clean &amp;&amp; make -j 8&#39;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure</span><br><span class="line"># 对代码进行coverity清除和重编：</span><br><span class="line">$ CXX&#x3D;&#x2F;opt&#x2F;local&#x2F;bin&#x2F;clang++ COVERITY_UNSUPPORTED&#x3D;1 CXXFLAGS&#x3D;&quot;-DNDEBUG -g3 -O2 -std&#x3D;c++11&quot; cov-build --dir cov-int bash -c &#39;make clean &amp;&amp; make -j 8&#39;</span><br></pre></td></tr></table></figure>





<p>企业完整版才能有的如下功能</p>
<p>获取权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cov-analyze --dir coverity --all --wait-for-license</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cov-analyze --dir coverity @@rule.txt</span><br></pre></td></tr></table></figure>



<p>生成检测报告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cov-format-errors --dir coverity --html-output coverity_html</span><br></pre></td></tr></table></figure>



<p>检测报告web前端展示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cov-commit-defects --dir cov --host 127.0.0.1 --user x x x x x x x x --password xxxxx projname --stream STRAM-NAME</span><br></pre></td></tr></table></figure>



<p>打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar czvf coverity.tgz cov-int</span><br></pre></td></tr></table></figure>



<p>开始上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --form token&#x3D;&lt;token&gt; \</span><br><span class="line">  --form email&#x3D;&lt;email&gt; \</span><br><span class="line">  --form file&#x3D;@&#96;pwd&#96;&#x2F;coverity.tgz \</span><br><span class="line">  --form version&#x3D;&quot;&lt;Version&gt;&quot; \</span><br><span class="line">  --form description&#x3D;&quot;&lt;Description&gt;&quot; \</span><br><span class="line">  https:&#x2F;&#x2F;scan.coverity.com&#x2F;builds\?project\&#x3D;&lt;ProjName&gt;</span><br></pre></td></tr></table></figure>



<h2 id="排除-添加扫描组件"><a href="#排除-添加扫描组件" class="headerlink" title="排除/添加扫描组件"></a>排除/添加扫描组件</h2><p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200911150915054.png" alt="image-20200911150915054"></p>
<h2 id="创建模型文件"><a href="#创建模型文件" class="headerlink" title="创建模型文件"></a>创建模型文件</h2><p><a target="_blank" rel="noopener" href="https://scan.coverity.com/tune">https://scan.coverity.com/tune</a></p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200911113248265.png" alt="image-20200911113248265"></p>
<h2 id="查看缺陷"><a href="#查看缺陷" class="headerlink" title="查看缺陷"></a>查看缺陷</h2><p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200911165935460.png" alt="image-20200911165935460"></p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/image-20200911171202562.png" alt="image-20200911171202562"></p>
<p>1、空指针引用（Null pointer dereferences）<br>描述：程序调用值为null的指针的任何方法，会引发空指针异<br>可能的后果：程序Crash，exit, restart,执行未授权代码或命令<br>Checker：FORWARD_NULL</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/85e6c9d6-2c9d-3f89-8989-0e41acfa02df.png" alt="img"></p>
<p> Checker: NULL_RETURNS</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/2171904d-6461-3a11-9ef9-e244db0bb9d3.png" alt="img"></p>
<p>2、资源泄漏（Resource leaks）<br>描述：程序未释放资源，或程序错误地释放了资源<br>可能的后果：Dos攻击，敏感数据泄漏，资源消耗<br>Checker: RESOURCE_LEAK</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/618d2e61-d258-311a-8f36-2a65e335deb8.png" alt="img"></p>
<p>3、内存破坏（Memory - corruptions）<br>描述：</p>
<ul>
<li>读写预期边界以外的内存缓冲区</li>
<li>使用未初始化的变量</li>
<li>函数/功能调用过程中使用了错误的参数取值</li>
<li>重复使用释放后的内存</li>
</ul>
<p> 可能的后果：程序Crash，exit, restart,执行未授权代码或命令</p>
<p>Checker: OVERRUN</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/bbb43acb-8440-36c1-af52-58809ae50842.png" alt="img"></p>
<p>4、内存非法访问（Memory - illegal accesses）<br>描述：</p>
<ul>
<li><p>使用未初始化的变量</p>
</li>
<li><p>使用释放后的资源(CPU、内存、Socket、文件等) </p>
</li>
<li><p>函数返回堆栈变量的地址 </p>
</li>
</ul>
<p>可能的后果：程序Crash，exit, restart,资源消耗等</p>
<p>Checker: OVERRUN</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/5df84a06-5efd-3ab6-a3db-3573e05e1372.png" alt="img"></p>
<p> Checker:  USE_AFTER_FREE</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/2525de25-af24-341a-94cc-3e5e84abba9f.png" alt="img"></p>
<p>Checker:  RETURN_LOCAL</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/605a436e-b2a2-3b3e-8862-d783b4f8f5f5.png" alt="img"></p>
<p>5、错误的表达式（Incorrect expression）<br>描述：使用错误的变量，不正确的类型转换<br>可能的后果：不符合预期的输出值，程序逻辑错误，运行时错误</p>
<p>Checker: COPY_PASTE_ERROR</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/79275885-4b61-37cd-8889-f2a2f48cf8bb.png" alt="img"></p>
<p>6、未初始化变量（Uninitialized variables）<br>描述：变量使用前未初始化<br>可能的后果：程序逻辑不正确，产生错误的数据，程序Crash</p>
<p>Checker: UNINIT</p>
<p><img src="/2021/03/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/1be52be6-4364-3f48-9124-3fb81a4ad613.png" alt="img"></p>
<h1 id="Fortify"><a href="#Fortify" class="headerlink" title="Fortify"></a>Fortify</h1><p>HP Fortify Source Code Analysis-Premium</p>
<p>Fortify更聚焦于产品代码的安全方面，被hp收购；</p>
<p><a target="_blank" rel="noopener" href="http://www8.hp.com/us/en/software-solutions/static-code-analysis-sast/">http://www8.hp.com/us/en/software-solutions/static-code-analysis-sast/</a></p>
<h1 id="审计工具对比"><a href="#审计工具对比" class="headerlink" title="审计工具对比"></a>审计工具对比</h1><p>检出数量： pclint &gt;&gt; cppcheck &gt; TSC &gt; coverity &gt;  scan-build</p>
<p>准确率： scan-build &gt; coverity ≈ TSC  &gt;&gt; cppcheck &gt; pclint</p>
<p>综合评分：coverity &gt; scan-build  &gt;  TSC  &gt; cppcheck &gt; pclint</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2021/03/01/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/01/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-01T20:51:18+08:00">
                2021-03-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br><span class="line">npm install hexo-asset-image</span><br><span class="line">npm i hexo-permalink-pinyin --save</span><br><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<p>notifyのblog/node_modules/hexo-asset-image/index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#39;use strict&#39;;</span><br><span class="line">var cheerio &#x3D; require(&#39;cheerio&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; http:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;14480345&#x2F;how-to-get-the-nth-occurrence-in-a-string</span><br><span class="line">function getPosition(str, m, i) &#123;</span><br><span class="line">  return str.split(m, i).join(m).length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var version &#x3D; String(hexo.version).split(&#39;.&#39;);</span><br><span class="line">hexo.extend.filter.register(&#39;after_post_render&#39;, function(data)&#123;</span><br><span class="line">  var config &#x3D; hexo.config;</span><br><span class="line">  if(config.post_asset_folder)&#123;</span><br><span class="line">    	var link &#x3D; data.permalink;</span><br><span class="line">	if(version.length &gt; 0 &amp;&amp; Number(version[0]) &#x3D;&#x3D; 3)</span><br><span class="line">	   var beginPos &#x3D; getPosition(link, &#39;&#x2F;&#39;, 1) + 1;</span><br><span class="line">	else</span><br><span class="line">	   var beginPos &#x3D; getPosition(link, &#39;&#x2F;&#39;, 3) + 1;</span><br><span class="line">	&#x2F;&#x2F; In hexo 3.1.1, the permalink of &quot;about&quot; page is like &quot;...&#x2F;about&#x2F;index.html&quot;.</span><br><span class="line">	var endPos &#x3D; link.lastIndexOf(&#39;&#x2F;&#39;) + 1;</span><br><span class="line">    link &#x3D; link.substring(beginPos, endPos);</span><br><span class="line"></span><br><span class="line">    var toprocess &#x3D; [&#39;excerpt&#39;, &#39;more&#39;, &#39;content&#39;];</span><br><span class="line">    for(var i &#x3D; 0; i &lt; toprocess.length; i++)&#123;</span><br><span class="line">      var key &#x3D; toprocess[i];</span><br><span class="line"> </span><br><span class="line">      var $ &#x3D; cheerio.load(data[key], &#123;</span><br><span class="line">        ignoreWhitespace: false,</span><br><span class="line">        xmlMode: false,</span><br><span class="line">        lowerCaseTags: false,</span><br><span class="line">        decodeEntities: false</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      $(&#39;img&#39;).each(function()&#123;</span><br><span class="line">		if ($(this).attr(&#39;src&#39;))&#123;</span><br><span class="line">			&#x2F;&#x2F; For windows style path, we replace &#39;\&#39; to &#39;&#x2F;&#39;.</span><br><span class="line">			var src &#x3D; $(this).attr(&#39;src&#39;).replace(&#39;\\&#39;, &#39;&#x2F;&#39;);</span><br><span class="line">			if(!&#x2F;http[s]*.*|\&#x2F;\&#x2F;.*&#x2F;.test(src) &amp;&amp;</span><br><span class="line">			   !&#x2F;^\s*\&#x2F;&#x2F;.test(src)) &#123;</span><br><span class="line">			  &#x2F;&#x2F; For &quot;about&quot; page, the first part of &quot;src&quot; can&#39;t be removed.</span><br><span class="line">			  &#x2F;&#x2F; In addition, to support multi-level local directory.</span><br><span class="line">			  var linkArray &#x3D; link.split(&#39;&#x2F;&#39;).filter(function(elem)&#123;</span><br><span class="line">				return elem !&#x3D; &#39;&#39;;</span><br><span class="line">			  &#125;);</span><br><span class="line">			  var srcArray &#x3D; src.split(&#39;&#x2F;&#39;).filter(function(elem)&#123;</span><br><span class="line">				return elem !&#x3D; &#39;&#39; &amp;&amp; elem !&#x3D; &#39;.&#39;;</span><br><span class="line">			  &#125;);</span><br><span class="line">			  if(srcArray.length &gt; 1)</span><br><span class="line">				srcArray.shift();</span><br><span class="line">			  src &#x3D; srcArray.join(&#39;&#x2F;&#39;);</span><br><span class="line">			  $(this).attr(&#39;src&#39;, config.root + link + src);</span><br><span class="line">			  console.info&amp;&amp;console.info(&quot;update link as:--&gt;&quot;+config.root + link + src);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			console.info&amp;&amp;console.info(&quot;no src attr, skipped...&quot;);</span><br><span class="line">			console.info&amp;&amp;console.info($(this));</span><br><span class="line">		&#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      data[key] &#x3D; $.html();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2020/12/22/web/osi%20https/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/22/web/osi%20https/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-22T01:29:22+08:00">
                2020-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="OSI-7-层模型"><a href="#OSI-7-层模型" class="headerlink" title="OSI 7 层模型"></a>OSI 7 层模型</h1><h3 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h3><p>网络服务与最终用户的一个接口。</p>
<p>协议有：<strong>HTTP FTP TFTP SMTP SNMP DNS TELNET HTTPS POP3 DHCP</strong></p>
<h3 id="表示层"><a href="#表示层" class="headerlink" title="表示层"></a>表示层</h3><p>数据的表示、安全、压缩。（在五层模型里面已经合并到了应用层）</p>
<p>格式有，<strong>JPEG、ASCll、EBCDIC、加密格式等 [2]</strong> </p>
<h3 id="会话层"><a href="#会话层" class="headerlink" title="会话层"></a>会话层</h3><p>建立、管理、终止会话。（在五层模型里面已经合并到了应用层）</p>
<p><strong>对应主机进程，指本地主机与远程主机正在进行的会话</strong></p>
<h3 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h3><p>定义传输数据的协议端口号，以及流控和差错校验。</p>
<p>协议有：<strong>TCP UDP，数据包一旦离开网卡即进入网络传输层</strong></p>
<p>TCP位于传输层, 提供可靠的字节流服务. TCP的三次握手是指: 发送端首先发送一个带有<br>SYN标志的数据包给对方, 接受端收到后回传一个带有SYN/ACK标志的数据包表示确认信息, 最后发送<br>端再回传一个带有ACK标志的数据包, 代表”握手”结束.</p>
<h3 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h3><p>进行逻辑地址寻址，实现不同网络之间的路径选择。</p>
<p>协议有：<strong>ICMP IGMP IP（IPV4 IPV6）</strong></p>
<p>IP位于网络层. IP协议的作用是包各种数据包传送给对方, 要正确传送数据包, 需要满足<br>2个重要的条件: IP地址和MAC地址. ARP协议可以把IP地址解析成MAC地址.</p>
<h3 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h3><p>建立逻辑连接、进行硬件地址寻址、差错校验 [3] 等功能。（由底层网络定义协议）</p>
<p>将比特组合成字节进而组合成帧，用MAC地址访问介质，错误发现但不能纠正。</p>
<h3 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h3><p>建立、维护、断开物理连接。（由底层网络定义协议）</p>
<p>TCP/IP 层级模型结构，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E5%B1%82">应用层</a>之间的协议通过逐级调用<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BC%A0%E8%BE%93%E5%B1%82">传输层</a>（Transport layer）、网络层（Network Layer）和物理<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82">数据链路层</a>（Physical Data Link）而可以实现应用层的应用程序通信互联。</p>
<p>应用层需要关心应用程序的逻辑细节，而不是数据在网络中的传输活动。应用层其下三层则处理真正的通信细节。在 Internet 整个发展过程中的所有思想和着重点都以一种称为 RFC（Request For Comments）的文档格式存在。针对每一种特定的 TCP/IP 应用，有相应的 RFC [4] 文档。</p>
<p>一些典型的 TCP/IP 应用有 FTP、Telnet、SMTP、SNTP、REXEC、TFTP、LPD、SNMP、NFS、INETD 等。RFC 使一些基本相同的 TCP/IP 应用程序实现了标准化，从而使得不同厂家开发的应用程序可以互相通信</p>
<h1 id="http"><a href="#http" class="headerlink" title="http"></a>http</h1><p><strong>http协议是基于TCP/IP协议之上的应用层协议。</strong></p>
<img src="/Users/notify/OneDrive/notifyall/web/https.assets/image-20201222023705129.png" alt="image-20201222023705129" style="zoom:77%;">



<img src="/Users/notify/OneDrive/notifyall/web/https.assets/image-20201222023750411.png" alt="image-20201222023750411" style="zoom:30%;">



<p>HTTP/1.1协议中共定义了八种方法（也叫“动作”）来以不同方式操作指定的资源：</p>
<h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><p>向指定的资源发出“显示”请求。使用GET方法应该只用在读取数据，而不应当被用于产生“副作用”的操作中，例如在Web Application中。其中一个原因是GET可能会被网络蜘蛛等随意访问。</p>
<h3 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a>HEAD</h3><p>与GET方法一样，都是向服务器发出指定资源的请求。只不过服务器将不传回资源的本文部分。它的好处在于，使用这个方法可以在不必传输全部内容的情况下，就可以获取其中“关于该资源的信息”（元信息或称元数据）。</p>
<h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><p>向指定资源提交数据，请求服务器进行处理（例如提交表单或者上传文件）。数据被包含在请求本文中。这个请求可能会创建新的资源或修改现有资源，或二者皆有。</p>
<h3 id="PUT"><a href="#PUT" class="headerlink" title="PUT"></a>PUT</h3><p>向指定资源位置上传其最新内容。</p>
<h3 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h3><p>请求服务器删除Request-URI所标识的资源。</p>
<h3 id="TRACE"><a href="#TRACE" class="headerlink" title="TRACE"></a>TRACE</h3><p>回显服务器收到的请求，主要用于测试或诊断。</p>
<h3 id="OPTIONS"><a href="#OPTIONS" class="headerlink" title="OPTIONS"></a>OPTIONS</h3><p>这个方法可使服务器传回该资源所支持的所有HTTP请求方法。用’*’来代替资源名称，向Web服务器发送OPTIONS请求，可以测试服务器功能是否正常运作。</p>
<h3 id="CONNECT"><a href="#CONNECT" class="headerlink" title="CONNECT"></a>CONNECT</h3><p>HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。通常用于SSL加密服务器的链接（经由非加密的HTTP代理服务器）。</p>
<ol>
<li>方法名称是区分大小写的。当某个请求所针对的资源不支持对应的请求方法的时候，服务器应当返回状态码405（Method Not Allowed），当服务器不认识或者不支持对应的请求方法的时候，应当返回状态码501（Not Implemented）。</li>
<li>HTTP服务器至少应该实现GET和HEAD方法，其他方法都是可选的。当然，所有的方法支持的实现都应当匹配下述的方法各自的语义定义。此外，除了上述方法，特定的HTTP服务器还能够扩展自定义的方法。例如PATCH（由 RFC 5789 指定的方法）用于将局部修改应用到资源<em>。</em></li>
</ol>
<h1 id="htpps"><a href="#htpps" class="headerlink" title="htpps"></a>htpps</h1><p>HTTPS基础知识：</p>
<p>​        HTTPS (Secure Hypertext Transfer Protocol)安全超文本传输协议，是一个安全通信通道，它基于HTTP开发用于在客户计算机和服务器之间交换信息。它使用<strong>安全套接字层</strong>(SSL)进行信息交换，简单来说它是HTTP的安全版,是使用TLS/SSL加密的HTTP协议。  HTTP协议采用明文传输信息，存在信息窃听、信息篡改和信息劫持的风险，而协议TLS/SSL具有身份验证、信息加密和完整性校验的功能，可以避免此类问题发生。</p>
<p>​        <strong>TLS/SSL全称安全传输层协议Transport Layer Security, 是介于TCP和HTTP之间的一层安全协议</strong>，不影响原有的TCP协议和HTTP协议，所以使用HTTPS基本上不需要对HTTP页面进行太多的改造。</p>
<img src="/Users/notify/OneDrive/notifyall/web/https.assets/image-20201222014545667.png" alt="image-20201222014545667" style="zoom:50%;">



<h2 id="一、什么是HTTPS"><a href="#一、什么是HTTPS" class="headerlink" title="一、什么是HTTPS"></a>一、什么是HTTPS</h2><p>HTTPS是在HTTP上建立SSL加密层，并对传输数据进行加密，是HTTP协议的安全版。HTTPS主要作用是：<br>（1）对数据进行加密，并建立一个信息安全通道，来保证传输过程中的数据安全;<br>（2）对网站服务器进行真实身份认证。</p>
<h2 id="二、什么是HTTP"><a href="#二、什么是HTTP" class="headerlink" title="二、什么是HTTP"></a>二、什么是HTTP</h2><p>  HTTP是互联网上应用最为广泛的一种网络协议，是一个客户端和服务器端请求和应答的标准(TCP)，用于从WWW服务器传输超文本到本地浏览器的传输协议。HTTP是采用明文形式进行数据传输，极易被不法份子窃取和篡改。<br>三、HTTPS和HTTP的区别是什么<br>  1、HTTPS是加密传输协议，HTTP是名文传输协议;<br>  2、HTTPS需要用到SSL证书，而HTTP不用;<br>  3、HTTPS比HTTP更加安全，对搜索引擎更友好，利于SEO【参考：（1）<a target="_blank" rel="noopener" href="http://www.wosign.com/news/2015-1225-01.htm">为保护用户隐私安全,谷歌优先索引HTTPS网页</a>、（2）<a target="_blank" rel="noopener" href="http://www.wosign.com/News/baidu-https.html">百度开放收录https站点，https全网化势不可挡】</a>;<br>  4、 HTTPS标准端口443，HTTP标准端口80;<br>  5、 HTTPS基于传输层，HTTP基于应用层;<br>  6、 HTTPS在浏览器显示绿色安全锁，HTTP没有显示;<br>  总的来说HTTPS比HTTP更加安全，能够有效的保护网站用户的隐私信息安全，这也是为什么现在的HTTPS网站越来越多。如果不想你的网站因为数据泄露上头条的话，就赶快去申请一张SSL证书为自己的网站实现HTTPS加密吧!</p>
<h2 id="TLS-SSL工作原理"><a href="#TLS-SSL工作原理" class="headerlink" title="TLS/SSL工作原理"></a>TLS/SSL工作原理</h2><p>  HTTPS协议的主要功能基本都依赖于TLS/SSL协议，本节分析TLS/SSL协议工作原理。<br>  TLS/SSL的功能实现主要依赖于三类基本算法：散列函数 Hash、对称加密和非对称加密，其利用非对称加密实现身份认证和密钥协商，对称加密算法采用协商的密钥对数据加密，基于散列函数验证信息的完整性。 </p>
<p><img src="/Users/notify/OneDrive/notifyall/web/https.assets/20160908112107454.gif" alt="img"><br><strong>散列函数Hash</strong><br>  常见的有 MD5、SHA1、SHA256，该类函数特点是函数单向不可逆、对输入非常敏感、输出长度固定，针对数据的任何修改都会改变散列函数的结果，用于防止信息篡改并验证数据的完整性;<br>  在信息传输过程中，散列函数不能单独实现信息防篡改，因为明文传输，中间人可以修改信息之后重新计算信息摘要，因此需要对传输的信息以及信息摘要进行加密;<br><strong>对称加密</strong><br>  常见的有 AES-CBC、DES、3DES、AES-GCM等，相同的密钥可以用于信息的加密和解密，掌握密钥才能获取信息，能够防止信息窃听，通信方式是1对1;<br>  对称加密的优势是信息传输1对1，需要共享相同的密码，密码的安全是保证信息安全的基础，服务器和 N 个客户端通信，需要维持 N 个密码记录，且缺少修改密码的机制;<br><strong>非对称加密</strong><br>  即常见的 RSA 算法，还包括 ECC、DH 等算法，算法特点是，密钥成对出现，一般称为公钥(公开)和私钥(保密)，公钥加密的信息只能私钥解开，私钥加密的信息只能公钥解开。因此掌握公钥的不同客户端之间不能互相解密信息，只能和掌握私钥的服务器进行加密通信，服务器可以实现1对多的通信，客户端也可以用来验证掌握私钥的服务器身份。<br>  非对称加密的特点是信息传输1对多，服务器只需要维持一个私钥就能够和多个客户端进行加密通信，但服务器发出的信息能够被所有的客户端解密，且该算法的计算复杂，加密速度慢。<br>  结合三类算法的特点，TLS的基本工作方式是，客户端使用非对称加密与服务器进行通信，实现身份验证并协商对称加密使用的密钥，然后对称加密算法采用协商密钥对信息以及信息摘要进行加密通信，不同的节点之间采用的对称密钥不同，从而可以保证信息只能通信双方获取。</p>
<h2 id="KPL体系"><a href="#KPL体系" class="headerlink" title="KPL体系"></a>KPL体系</h2><p>1、RSA身份验证的隐患<br>  身份验证和密钥协商是TLS的基础功能，要求的前提是合法的服务器掌握着对应的私钥。但RSA算法无法确保服务器身份的合法性，因为公钥并不包含服务器的信息，存在安全隐患:<br>  客户端C和服务器S进行通信，中间节点M截获了二者的通信;<br>  节点M自己计算产生一对公钥pub_M和私钥pri_M;<br>  C向S请求公钥时，M把自己的公钥pub_M发给了C;<br>  C使用公钥 pub_M加密的数据能够被M解密，因为M掌握对应的私钥pri_M，而 C无法根据公钥信息判断服务器的身份，从而 C和 M之间建立了”可信”加密连接;<br>  中间节点 M和服务器S之间再建立合法的连接，因此 C和 S之间通信被M完全掌握，M可以进行信息的窃听、篡改等操作。<br>  另外，服务器也可以对自己的发出的信息进行否认，不承认相关信息是自己发出。</p>
<p>  因此该方案下至少存在两类问题：中间人攻击和信息抵赖。</p>
<p><img src="/Users/notify/OneDrive/notifyall/web/https.assets/20160908112332241.png" alt="img"></p>
<p>2、身份验证CA和证书<br>  解决上述身份验证问题的关键是确保获取的公钥途径是合法的，能够验证服务器的身份信息，为此需要引入权威的第三方机构CA(如沃通CA)。CA 负责核实公钥的拥有者的信息，并颁发认证”证书”，同时能够为使用者提供证书验证服务，即PKI体系(PKI基础知识)。<br>  基本的原理为，CA负责审核信息，然后对关键信息利用私钥进行”签名”，公开对应的公钥，客户端可以利用公钥验证签名。CA也可以吊销已经签发的证书，基本的方式包括两类 CRL 文件和 OCSP。CA使用具体的流程如下：</p>
<p><img src="/Users/notify/OneDrive/notifyall/web/https.assets/20160908112422114.png" alt="img"></p>
<p>  a.服务方S向第三方机构CA提交公钥、组织信息、个人信息(域名)等信息并申请认证;<br>  b.CA通过线上、线下等多种手段验证申请者提供信息的真实性，如组织是否存在、企业是否合法，是否拥有域名的所有权等;<br>  c.如信息审核通过，CA会向申请者签发认证文件-证书。<br>证书包含以下信息：申请者公钥、申请者的组织信息和个人信息、签发机构 CA的信息、有效时间、证书序列号等信息的明文，同时包含一个签名;<br>签名的产生算法：首先，使用散列函数计算公开的明文信息的信息摘要，然后，采用 CA的私钥对信息摘要进行加密，密文即签名;<br>  d.客户端 C 向服务器 S 发出请求时，S 返回证书文件;<br>  e.客户端 C读取证书中的相关的明文信息，采用相同的散列函数计算得到信息摘要，然后，利用对应 CA的公钥解密签名数据，对比证书的信息摘要，如果一致，则可以确认证书的合法性，即公钥合法;<br>  f.客户端然后验证证书相关的域名信息、有效时间等信息;<br>  g.客户端会内置信任CA的证书信息(包含公钥)，如果CA不被信任，则找不到对应 CA的证书，证书也会被判定非法。<br>在这个过程注意几点：<br>  a.申请证书不需要提供私钥，确保私钥永远只能服务器掌握;<br>  b.证书的合法性仍然依赖于非对称加密算法，证书主要是增加了服务器信息以及签名;<br>  c.内置 CA 对应的证书称为根证书，颁发者和使用者相同，自己为自己签名，即自签名证书（为什么说”部署自签SSL证书非常不安全”）<br>  d.证书=公钥+申请者与颁发者信息+签名;</p>
<p> <strong>★</strong>即便有人截取服务器A证书，再发给客户端，想冒充服务器A，也无法实现。因为证书和url的域名是绑定的。</p>
<p>3、证书链<br>  如 CA根证书和服务器证书中间增加一级证书机构，即中间证书，证书的产生和验证原理不变，只是增加一层验证，只要最后能够被任何信任的CA根证书验证合法即可。<br>  a.服务器证书 server.pem 的签发者为中间证书机构 inter，inter 根据证书 inter.pem 验证 server.pem 确实为自己签发的有效证书;<br>  b.中间证书 inter.pem 的签发 CA 为 root，root 根据证书 root.pem 验证 inter.pem 为自己签发的合法证书;<br>  c.客户端内置信任 CA 的 root.pem 证书，因此服务器证书 server.pem 的被信任。</p>
<p><img src="https://img-blog.csdn.net/20160908113425891" alt="img"></p>
<p>服务器证书、中间证书与根证书在一起组合成一条合法的证书链，证书链的验证是自下而上的信任传递的过程。<br>二级证书结构存在的优势：<br>  a.减少根证书结构的管理工作量，可以更高效的进行证书的审核与签发;<br>  b.根证书一般内置在客户端中，私钥一般离线存储，一旦私钥泄露，则吊销过程非常困难，无法及时补救;<br>  c.中间证书结构的私钥泄露，则可以快速在线吊销，并重新为用户签发新的证书;<br>  d.证书链四级以内一般不会对 HTTPS 的性能造成明显影响。</p>
<p><img src="https://img-blog.csdn.net/20160908113521314" alt="img"></p>
<p>证书链有以下特点：<br>  a.同一本服务器证书可能存在多条合法的证书链。<br>  因为证书的生成和验证基础是公钥和私钥对，如果采用相同的公钥和私钥生成不同的中间证书，针对被签发者而言，该签发机构都是合法的 CA，不同的是中间证书的签发机构不同;<br>  b.不同证书链的层级不一定相同，可能二级、三级或四级证书链。<br>  中间证书的签发机构可能是根证书机构也可能是另一个中间证书机构，所以证书链层级不一定相同。<br>4、证书吊销<br>  CA 机构能够签发证书，同样也存在机制宣布以往签发的证书无效。证书使用者不合法，CA 需要废弃该证书;或者私钥丢失，使用者申请让证书无效。主要存在两类机制：CRL 与 OCSP。<br>  a.CRL<br>  Certificate Revocation List, 证书吊销列表(什么是证书吊销列表(CRL)？吊销列表起什么作用)，一个单独的文件。该文件包含了 CA 已经吊销的证书序列号(唯一)与吊销日期，同时该文件包含生效日期并通知下次更新该文件的时间，当然该文件必然包含 CA 私钥的签名以验证文件的合法性。<br>证书中一般会包含一个 URL 地址 CRL Distribution Point，通知使用者去哪里下载对应的 CRL 以校验证书是否吊销。该吊销方式的优点是不需要频繁更新，但是不能及时吊销证书，因为 CRL 更新时间一般是几天，这期间可能已经造成了极大损失。<br>  b.OCSP<br>Online Certificate Status Protocol, 证书状态在线查询协议，一个实时查询证书是否吊销的方式。请求者发送证书的信息并请求查询，服务器返回正常、吊销或未知中的任何一个状态。证书中一般也会包含一个 OCSP 的 URL 地址，要求查询服务器具有良好的性能。部分 CA 或大部分的自签 CA (根证书)都是未提供 CRL 或 OCSP 地址的，对于吊销证书会是一件非常麻烦的事情。</p>
<h2 id="TLS-SSL握手过程与密钥协商过程"><a href="#TLS-SSL握手过程与密钥协商过程" class="headerlink" title="TLS/SSL握手过程与密钥协商过程"></a>TLS/SSL握手过程与密钥协商过程</h2><p><img src="/Users/notify/OneDrive/notifyall/web/https.assets/Center.png" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2020/12/16/ptmalloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/16/ptmalloc/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-16T14:34:49+08:00">
                2020-12-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">172.16.9.52   9W8K#J7v  22&#x2F;8888  5032&#x2F;6032</span><br><span class="line">172.16.9.53   9Cr3ReEc  22&#x2F;8888  5033&#x2F;6033</span><br><span class="line">student37</span><br><span class="line">ATE5GtBW</span><br><span class="line"></span><br><span class="line">ssh ctf@172.16.9.52 -p 9W8K#J7v</span><br><span class="line">ssh ctf@172.16.9.53 -p 9Cr3ReEc</span><br><span class="line">https:&#x2F;&#x2F;172.20.1.1</span><br></pre></td></tr></table></figure>





<h1 id="ptmalloc"><a href="#ptmalloc" class="headerlink" title="ptmalloc"></a>ptmalloc</h1><p>Ubuntu16:</p>
<ul>
<li>libc6_2.23-0ubuntu11.2_amd64</li>
<li>libc6_2.23-0ubuntu11.2_i386</li>
</ul>
<p>Ubuntu18:</p>
<ul>
<li>libc6_2.27-3ubuntu1.3_amd64</li>
<li>libc6_2.27-3ubuntu1.3_i386</li>
</ul>
<h2 id="32"><a href="#32" class="headerlink" title="32"></a>32</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无</span><br></pre></td></tr></table></figure>



<h2 id="64"><a href="#64" class="headerlink" title="64"></a>64</h2><p><em><strong>chunksize = 0x180 则malloc( ( 0x180 - 24, 0x180 - 8 ] )</strong></em> </p>
<p>堆块块(Chunk), 其头部保存着自身的大小等信息, 在这之后即 是用户数据。一共有 3 种类型, 它们都使用同一种数 据结构(malloc_chunk)定义。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"><span class="comment">/* Size of previous chunk (if free). */</span> </span><br><span class="line">  INTERNAL_SIZE_T prev_size;</span><br><span class="line"><span class="comment">/* Size in bytes, including overhead. */</span> </span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line"><span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"><span class="comment">/* Only used for large blocks: pointer to next larger</span></span><br><span class="line"><span class="comment">size. */</span></span><br><span class="line"><span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span> </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>具体来说, 用于管理的堆块主要分为 3 种类型。</p>
<p> Allocated Chunk: 已分配块</p>
<p><img src="/2020/12/16/ptmalloc/image-20201216143511628.png" alt="image-20201216143511628"></p>
<p> Free Chunk: 被释放块</p>
<p><img src="/Users/notify/OneDrive/notifyall/pwn/ptmalloc.assets/image-20201216143528038.png" alt="image-20201216143528038"></p>
<p> Top Chunk: 顶块</p>
<p>位于所有块之后, 保存着 未分配的所有内存, 与已分配块使用相同的域。</p>
<p>glibc 使用 size 域的最低 3 位来 存储一些其它信息。相关的掩码信息定义如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREV_INUSE 0x1  <span class="comment">//如果此位为 0 则表示上一块为被释放的块, 这个时候此块的 PREV_SIZE 域保存的是上一块的地 址以便在 free 此块时能够找到上一块的地址并进行 合并操作。</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_MMAPPED 0x2  <span class="comment">//第 2 位表示此块是否由 mmap 分配, 如果 此位为 0 则此块是由 top chunk 分裂得来, 否则是由 mmap 单独分配而来。</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_MAIN_ARENA 0x4 <span class="comment">//第 3 位表示此块是否不属于 main_arena, 在之后会提到main_arena是主线程用于保存堆状态的结构, 如果此位为 0 则表示此块是在 主线程中分配的。</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; arena   &lt;- main_arena</span><br><span class="line">&#123;</span><br><span class="line">  mutex = <span class="number">0</span>, </span><br><span class="line">  flags = <span class="number">1</span>, </span><br><span class="line">  fastbinsY = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>&#125;, </span><br><span class="line">  top = <span class="number">0x6020a0</span>, </span><br><span class="line">  last_remainder = <span class="number">0x0</span>, </span><br><span class="line">  bins = &#123;<span class="number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="number">88</span>&gt; = arena.top, <span class="number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="number">88</span>&gt;, <span class="number">0x7ffff7dd1b88</span> &lt;main_arena+<span class="number">104</span>&gt;, <span class="number">0x7ffff7dd1b88</span> &lt;main_arena+<span class="number">104</span>&gt;, <span class="number">0x7ffff7dd1b98</span> &lt;main_arena+<span class="number">120</span>&gt;, <span class="number">0x7ffff7dd1b98</span> &lt;main_arena+<span class="number">120</span>&gt;, <span class="number">0x7ffff7dd1ba8</span> &lt;main_arena+<span class="number">136</span>&gt;, <span class="number">0x7ffff7dd1ba8</span> &lt;main_arena+<span class="number">136</span>&gt;, <span class="number">0x7ffff7dd1bb8</span> &lt;main_arena+<span class="number">152</span>&gt;, <span class="number">0x7ffff7dd1bb8</span> &lt;main_arena+<span class="number">152</span>&gt;, <span class="number">0x7ffff7dd1bc8</span> &lt;main_arena+<span class="number">168</span>&gt;, <span class="number">0x7ffff7dd1bc8</span> &lt;main_arena+<span class="number">168</span>&gt;, <span class="number">0x7ffff7dd1bd8</span> &lt;main_arena+<span class="number">184</span>&gt;, <span class="number">0x7ffff7dd1bd8</span> &lt;main_arena+<span class="number">184</span>&gt;, <span class="number">0x7ffff7dd1be8</span> &lt;main_arena+<span class="number">200</span>&gt;, <span class="number">0x7ffff7dd1be8</span> &lt;main_arena+<span class="number">200</span>&gt;, <span class="number">0x7ffff7dd1bf8</span> &lt;main_arena+<span class="number">216</span>&gt;, &#125;, </span><br><span class="line">  binmap = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;, </span><br><span class="line">  next = <span class="number">0x7ffff7dd1b20</span> &lt;main_arena&gt;, </span><br><span class="line">  next_free = <span class="number">0x0</span>, </span><br><span class="line">  attached_threads = <span class="number">1</span>, </span><br><span class="line">  system_mem = <span class="number">135168</span>, </span><br><span class="line">  max_system_mem = <span class="number">135168</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fastbinsY = &#123;<span class="number">0x602020</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>&#125;,</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x602020</span> —▸ <span class="number">0x602000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Bins"><a href="#Bins" class="headerlink" title="Bins:"></a>Bins:</h2><h3 id="Fast-Bins"><a href="#Fast-Bins" class="headerlink" title="Fast Bins:"></a>Fast Bins:</h3><ul>
<li><p>单向链表</p>
</li>
<li><p>每个元素是一 条单向链表的头部</p>
</li>
<li><p>且同一条链表中块的大小相同。 主要保存大小 32 至 128 字节的块 (0x20 - 0x80).  malloc(0-0x78)</p>
</li>
<li><p>特点是当 free 时 <strong>不取消下一块的 PREV_INUSE 位, 也不检查是否能 够进行合并操作</strong></p>
</li>
<li><p> Fast bins 的取用机 制是 LIFO (Last In First Out) , 即<strong>后释放的块将先被利用</strong>。（从fastbin头开始存和取）修改 fd</p>
</li>
<li><p>Free 1 2 3  M 3 2 1</p>
</li>
<li><p>链无数量限制</p>
</li>
</ul>
<h3 id="Unsorted-Bins"><a href="#Unsorted-Bins" class="headerlink" title="Unsorted Bins"></a>Unsorted Bins</h3><p>从头开始插入, 从尾部解链分配</p>
<p>之后的 Small Bins 与 Large Bins 也是同样的机制。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> bins = &#123;<span class="number">0x602120</span>, <span class="number">0x602000</span>, <span class="number">0x7ffff7dd1b88</span> &lt;main_arena+<span class="number">104</span>&gt;, <span class="number">0x7ffff7dd1b88</span> &lt;main_arena+<span class="number">104</span>&gt;,...&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">4</span>gx <span class="number">0x602120</span> first</span><br><span class="line"><span class="number">0x602120</span>:       <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x602130</span>:       <span class="number">0x0000000000602000</span> next     <span class="number">0x00007ffff7dd1b78</span> prev</span><br><span class="line">pwndbg&gt;  x/<span class="number">4</span>gx <span class="number">0x602000</span>  last</span><br><span class="line"><span class="number">0x602000</span>:       <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x602010</span>:       <span class="number">0x00007ffff7dd1b78</span> next     <span class="number">0x0000000000602120</span> prev</span><br></pre></td></tr></table></figure>



<h3 id="Small-Bins"><a href="#Small-Bins" class="headerlink" title="Small Bins:"></a>Small Bins:</h3><ul>
<li>每个元素是一 条<strong>双向循环链表</strong>的头部</li>
<li>且同一条链表中块的<strong>大小相同</strong>。</li>
<li>主要保存大小 <strong>32 至 1024</strong> 字节的块。</li>
<li>由于是 双向链表, Small Bins 的取用机制是 FIFO (First In First Out) , 即先释放的块会先被利用, </li>
<li>Free 1 2 3  M 1 2 3</li>
</ul>
<h3 id="Large-Bins"><a href="#Large-Bins" class="headerlink" title="Large Bins"></a>Large Bins</h3><ul>
<li>每个元素是一条 双向循环链表的头部</li>
<li>同一条链表中块的<strong>大小不一 定相同</strong></li>
<li>按照<strong>从大到小</strong>的顺序排列</li>
<li>每个 bin 保存一定 大小范围的块, 主要保存大小 <strong>1024 字节以上</strong>的块。</li>
</ul>
<h2 id="malloc流程"><a href="#malloc流程" class="headerlink" title="malloc流程"></a>malloc流程</h2><p>#假设malloc一个0x80的块）</p>
<p>malloc hook指针</p>
<p>在第一次执行malloc函数时, 系统会使用brk系 统调用向操作系统扩展程序的数据区, 此时 glibc 将 初始化top chunk与main_arena, 取得132KB的空间。 如果之后所有的 malloc 操作都可以满足, 即最后总 是能在此 132KB 中找到合适的内存块返回, 则不再 使用系统调用与内核交互。这段时间, 程序的堆内存 由 glibc 管理。glibc 首先将其加上 8 字节的额外开销，再对齐32字节。</p>
<ul>
<li><p> 检查 Fast bins 如果请求大小满足 Fast bins, 则在对应的 bin 中 寻找是否有相同大小的块, 如果有则直接将其取出 返回给程序, 同时更新 fast bins 中对应 bin 存储的链 表头指针</p>
</li>
<li><p> 检查 Small bins 如果块大小符合 Small bins, 则在对应大小的 Small bin 中寻找是否有合适的块, 如果有则直接返 回, 同时更新 Small bins 中对应 bin 的链表中该块的 上一块和下一块的指针。 </p>
</li>
<li><p> 处理 Unsorted bin 如果之前没能返回恰好符合的块, 则开始处理 Unsorted bin 中的块(这里有一个例外, 如果 Unsorted bin 中只有一个块且这个块是 last_remainder, 而且大 小足够, 则优先使用此块, 分裂后将前一块返回给 用户, 剩下的一块作为新的 last_remainder 再次放入 Unsorted bin.[7]) </p>
</li>
</ul>
<ol>
<li> a) 逐个迭代Unsorted bin中的块, 如果发现块的 大小正好是需要的大小, 则迭代过程中止, 直接返 回此块;否则将此块放入到对应的 Small bin 或者 large bin 中, 这也是整个 glibc 堆管理中唯一会将块 放入 Small bins 与 large bins 中的代码。 </li>
<li> b) 迭代过程直到 Unsorted bin 中没有块或超过 最大迭代次数(10000)为止。 </li>
<li> c) 随后开始在 Small bins 与 large bins 中寻找最 合适的块(指大于请求大小的最小块), 如果能够找到, 则分裂后将前一块返回给用户, 剩下的块放入 Unsorted bin 中。 </li>
<li> d) 如果没能找到, 则回到开头, 继续迭代过程, 直到 Unsorted bin 空为止 2.2.4  使用顶块 如果之前的操作都没能找到合适的块, 将分裂 Top chunk 返回给用户, 若 Top chunk 的大小仍然不 足, 则再次执行 malloc_consolidate 函数清除 Fast bins, 若Fast bins已空, 只能使用sysmalloc函数借助 系统调用拓展空间。 </li>
</ol>
<h2 id="free流程"><a href="#free流程" class="headerlink" title="free流程"></a>free流程</h2><ol>
<li>Free 函数是 glibc 的释放接口, 将之前分配得到 的用户内存指针作为参数, glibc 会释放这一块空间。 主要的功能由_int_free 函数实现。 </li>
<li>首先, 进行一系列的检查, 包括内存地址对齐, PREV_INUSE 位是否正确等等, 能够发现一些破坏 与 double free 的问题。 </li>
<li>如果块大小满足 Fast bins, 则不取消下一块的 PREV_INUSE 位, 也不设置下一块的 prev_size 域, 直接将该块放入对应的 Fast bin 中, 且不进行相邻块 的合并操作。 </li>
<li>检查被 free 内存块的前一块(这里的前一块指连 续内存中的上一块, 通过 prev_size 域来寻找), 如果 未使用, 则合并这 2 块, 将前一块从其 bin 中移除之 后再检查其后一块, 如果发现是 Top chunk, 则最后将 合并到 Top chunk 中, 不放入任何 bin; 如果不是 Top chunk 且未使用, 则再合并这 2 块, 将后一块从其 bin 中移除, 并且将合并过的大块放入 Unsorted bin 中。 </li>
</ol>
<h2 id="heap伪代码"><a href="#heap伪代码" class="headerlink" title="heap伪代码"></a>heap伪代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">find_from_fastbin</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    bin = &amp;arena-&gt;fastbin[idx] - <span class="number">0x10</span>;</span><br><span class="line">    chunk* res = bin-&gt;fd;</span><br><span class="line">		bin-&gt;fd = res-&gt;fd;</span><br><span class="line">    <span class="comment">// 高版本有fastbin检查</span></span><br><span class="line">    vassert(res-&gt;size == idx*<span class="number">16</span>+<span class="number">0x20</span>); </span><br><span class="line">    <span class="comment">// 但这段代码没 有检查内存地址的对齐</span></span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// LIFO</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mv_to_fastbin</span><span class="params">(<span class="keyword">void</span>* chunk, <span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">   <span class="keyword">void</span>* fd = arena-&gt;fastbin[idx]-&gt;fd;</span><br><span class="line">   arena-&gt;fastbin[idx]-&gt;fd = chunk;</span><br><span class="line">   chunk-&gt;fd = fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 Small Bins 的 代码如下所示:</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">find_from_smallbin</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">   <span class="comment">// 大小相等</span></span><br><span class="line">    small_bin = &amp;arena-&gt;bins[idx] - <span class="number">16</span>;</span><br><span class="line">    chunk* victim = small_bin-&gt;bk;</span><br><span class="line">    <span class="keyword">if</span> (victim == <span class="number">0</span>)&#123;<span class="comment">/* initialization check */</span></span><br><span class="line">				malloc_consolidate(av);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    bck = victim-&gt;bk;</span><br><span class="line">    set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">		bin-&gt;bk = bck;</span><br><span class="line">  	bck-&gt;fd =  small_bin;</span><br><span class="line">		<span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">find_from_small_large</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">   <span class="comment">// 满足最小大小</span></span><br><span class="line">  	<span class="keyword">if</span> (chunk = find_it())&#123;</span><br><span class="line">       vassert(chunk-&gt;size &gt; size);</span><br><span class="line">       relloc(chunk, size);</span><br><span class="line">       <span class="keyword">return</span> chunk</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="keyword">return</span> null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FIFO double link insert</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mv_to_bins</span><span class="params">(<span class="keyword">void</span>* chunk)</span></span>&#123;</span><br><span class="line">  <span class="comment">//这也是整个 glibc 堆管理中唯一会将块 放入 Small bins 与 large bins 中的代码。</span></span><br><span class="line">    fd = bins[chunk-&gt;size/<span class="number">0x10</span>]-&gt;fd;</span><br><span class="line">    bk = bins[chunk-&gt;size/<span class="number">0x10</span>]-&gt;bk;</span><br><span class="line">    bins[chunk-&gt;size/<span class="number">0x10</span>]-&gt;fd = chunk;</span><br><span class="line">    chunk-&gt;fd = fd;</span><br><span class="line">    chunk-&gt;bk = bk;</span><br><span class="line">    fd-&gt;bk = chunk;</span><br><span class="line">    bk-&gt;fd = chunk;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// double link delete</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlink</span><span class="params">(<span class="keyword">void</span>* chunk)</span></span>&#123;</span><br><span class="line">   vassert(fd-&gt;bk == chunk &amp;&amp; bk-&gt;fd == chunk, <span class="string">&quot;unlink error&quot;</span>);<span class="comment">//早期无此检查</span></span><br><span class="line">   bk, fd = chunk-&gt;bk, chunk-&gt;fd;</span><br><span class="line">   bk-&gt;fd = fd;</span><br><span class="line">   fd-&gt;bk = bk;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlink_auto</span><span class="params">(<span class="keyword">void</span>* chunk)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(is_fastbin(chunk))&#123;</span><br><span class="line">     <span class="comment">/*遍历fastbin一条链将其删除*/</span></span><br><span class="line">    。。。。。</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     unlink(chunk)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>* __libc_malloc(<span class="keyword">size_t</span> need_size)&#123;</span><br><span class="line">    chunksize = ((need_size<span class="number">-1</span>)&amp;~<span class="number">0b1111</span>) + <span class="number">0x20</span>;</span><br><span class="line">  	<span class="keyword">int</span> idx = chunksize/<span class="number">0x10</span> - <span class="number">2</span>;  </span><br><span class="line">  	</span><br><span class="line">  	<span class="keyword">if</span>(fastbin[idx<span class="comment">/*0-6*/</span>]有空闲块 &amp;&amp; chunksize&gt;=<span class="number">0x20</span> &amp;&amp; chunksize&lt;=<span class="number">0x80</span>)  <span class="comment">//chunksize  0x20-0x80</span></span><br><span class="line">    	  <span class="keyword">return</span> find_from_fastbin(idx)</span><br><span class="line">		</span><br><span class="line">      </span><br><span class="line">		<span class="keyword">if</span>(bins[idx + <span class="number">2</span> <span class="comment">/*2-2+61*/</span>]有空闲块 &amp;&amp; chunksize&gt;=<span class="number">0x20</span> &amp;&amp; chunksize&lt;=<span class="number">0x3f0</span>)   <span class="comment">//chunksize 0x20 - 0x3f0</span></span><br><span class="line">    	  <span class="keyword">return</span> find_from_smallbin(idx + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 剩下的一块作为新的 last_remainder 再次放入 Unsorted bin</span></span><br><span class="line">    <span class="keyword">if</span>(bins[<span class="number">1</span>]-&gt;fd != &amp;bins[<span class="number">1</span>]<span class="number">-0x10</span> &amp;&amp;</span><br><span class="line">       bins[<span class="number">1</span>]-&gt;fd-&gt; == &amp;bins[<span class="number">1</span>]<span class="number">-0x10</span> &amp;&amp;     <span class="comment">// 如果 Unsorted bin 中只有一个块且这个块是 last_remainder,</span></span><br><span class="line">       &amp;&amp; last_remainder.size &gt;= chunksize)  <span class="comment">// 而且大小足够, 则优先使用此块, 分裂后将前一块返回给用户, </span></span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(last_remainder.size == chunksize) &#123; <span class="comment">// 大小足够且相等</span></span><br><span class="line">            last_remainder = <span class="literal">nullptr</span>;</span><br><span class="line">            unlink_auto(last_remainder);</span><br><span class="line">            <span class="keyword">return</span> last_remainder;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123; <span class="comment">// last_remainder需要分裂</span></span><br><span class="line">            <span class="keyword">if</span>(last_remainder-&gt;size - chunksize &gt;= <span class="number">32</span>)&#123; <span class="comment">//满足最小分裂要求</span></span><br><span class="line">               <span class="comment">// 分裂last_remainder</span></span><br><span class="line">               unlink_auto(last_remainder);</span><br><span class="line">               <span class="keyword">void</span> new_last_remainder = chunk + chunksize;</span><br><span class="line">               new_last_remainder-&gt;size = last_remainder-&gt;size - chunksize;</span><br><span class="line">               <span class="comment">// 返回last_remainder</span></span><br><span class="line">               <span class="keyword">void</span>* res = last_remainder;</span><br><span class="line">               last_remainder = new_last_remainder; <span class="comment">// 保存分裂的块</span></span><br><span class="line">               <span class="comment">//再次放入Unsorted bin</span></span><br><span class="line">               bins[<span class="number">1</span>]-&gt;fd = new_last_remainder;</span><br><span class="line">               <span class="keyword">return</span> res;</span><br><span class="line">            &#125;</span><br><span class="line">						<span class="comment">// 不满足</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 从unsorted bins</span></span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(curr = bins[<span class="number">1</span>], curr != &amp;bins[<span class="number">1</span>] - <span class="number">0x10</span> &amp;&amp; count&lt;=<span class="number">10000</span>; curr = curr-&gt;fd, count++)&#123;</span><br><span class="line">      	<span class="keyword">if</span>(curr-&gt;size == chunksize)&#123;</span><br><span class="line">            <span class="comment">//没有采用unlink，注意的是这里无unkink检查，这就很好</span></span><br><span class="line">            bck = curr-&gt;bk; </span><br><span class="line">            ...</span><br><span class="line">            unsorted_chunks (av)-&gt;bk = bck; </span><br><span class="line">            bck-&gt;fd = unsorted_chunks (av);	</span><br><span class="line">          	<span class="keyword">return</span> curr;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">//没找到</span></span><br><span class="line">           <span class="comment">// 将此块放入到对应的 Small bin 或者 large bin 中, </span></span><br><span class="line">           <span class="comment">// 这也是整个 glibc 堆管理中唯一会将块 放入 Small bins 与 large bins 中的代码。</span></span><br><span class="line">          	unlink(curr);</span><br><span class="line">           <span class="comment">// 放入Small bins or large bins</span></span><br><span class="line">            mv_to_bins(curr);</span><br><span class="line">           <span class="comment">// 从Small bins 与 large bins查找</span></span><br><span class="line">          	<span class="keyword">void</span>* ret = find_from_small_large(chunksize, idx);</span><br><span class="line">          	<span class="keyword">if</span>(ret) <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从 topchunk分裂一个</span></span><br><span class="line">  	<span class="keyword">if</span>(chunksize&lt;=topchunk-&gt;size) </span><br><span class="line">        <span class="keyword">return</span> topchunk;</span><br><span class="line">  	<span class="keyword">else</span>&#123; <span class="comment">// topchunk大小不够</span></span><br><span class="line">        <span class="comment">// 清除 Fast bins, 若 Fast bins 已空, 只能使用 sysmalloc 函数借助 系统调用拓展空间。</span></span><br><span class="line">      	<span class="keyword">void</span>* ret = malloc_consolidate(fastbins);</span><br><span class="line">        <span class="keyword">if</span> (ret)&#123;</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 若 Fast bins 已空 , 或者释放了还是不够</span></span><br><span class="line">            <span class="keyword">return</span> sys_brk()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------------------------------- free ---------------------------------</span></span><br><span class="line"><span class="keyword">void</span>* global_prev_free_fastbin = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">void</span> __libc_free(<span class="keyword">void</span>* ptr)&#123;</span><br><span class="line">  <span class="keyword">void</span>* chunk = ptr - <span class="number">0x10</span>;</span><br><span class="line">  <span class="keyword">void</span>* fd_chunk = chunk + chunk-&gt;size;</span><br><span class="line">  vassert(chunk&amp;<span class="number">0b1111</span>==<span class="number">0</span>, <span class="string">&quot;&quot;</span>);<span class="comment">//对齐检查</span></span><br><span class="line">  vassert(fd_chunk-&gt;prev_inuse == <span class="literal">true</span>, <span class="string">&quot;&quot;</span>);<span class="comment">// 下一块的 prev_inuse 检查</span></span><br><span class="line">  vassert(bins[<span class="number">1</span>]-&gt;fd-&gt;bk == &amp;bins[<span class="number">1</span>]<span class="number">-0x10</span>, <span class="string">&quot;unsorted bin 指向自身检查&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(chunk-&gt;size &gt; <span class="number">0x20</span> &amp;&amp; chunk-&gt;size&lt;=<span class="number">0x80</span>)&#123; <span class="comment">// fastbins</span></span><br><span class="line">     <span class="comment">//这种释放相当于直接把该chunk引用放到了fastbins,啥也不做，只是做下检查和链表链接</span></span><br><span class="line">     vassert(global_prev_free_fastbin!=chunk, <span class="string">&quot;double free&quot;</span>);</span><br><span class="line">     global_prev_free_fastbin = chunk;</span><br><span class="line">     mv_to_fastbin(chunk, chunk-&gt;size/<span class="number">0x10</span> - <span class="number">2</span>); <span class="comment">// 直接放入fastbin</span></span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     fd_chunk-&gt;prev_size = chunk-&gt;size; <span class="comment">// // 设置下一块 prev_size = size;</span></span><br><span class="line">     fd_chunk-&gt;prev_inuse = <span class="literal">false</span>; <span class="comment">// 设置下一块 prev_inuse 为false;</span></span><br><span class="line">     <span class="keyword">if</span> (chunk-&gt;prev_inuse == <span class="literal">false</span>)&#123; <span class="comment">// 前一块是释放了的</span></span><br><span class="line">         <span class="keyword">void</span>* bk_chunk = chunk - chunk-&gt;prev_size;</span><br><span class="line">         vassert(bk_chunk-&gt;size == chunk-&gt;prev_size, <span class="string">&quot;&quot;</span>);</span><br><span class="line">         <span class="comment">// 合并相邻的前一块</span></span><br><span class="line">         <span class="comment">// 将上一块从其所在bins移除掉</span></span><br><span class="line">         unlink(bk_chunk);</span><br><span class="line">         <span class="comment">// 上一块的 bk_chunk-&gt;size += chunk-&gt;size</span></span><br><span class="line">         <span class="comment">// 更新下一chunk 的 prev_size = bk_chunk-&gt;size</span></span><br><span class="line">         merge(bk_chunk, chunk, fd_chunk);</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">void</span>* fd_fd_chunk = fd_chunk + fd_chunk-&gt;size;</span><br><span class="line">     <span class="keyword">if</span>( fd_fd_chunk-&gt;prev_inuse == <span class="literal">false</span>)&#123; <span class="comment">// chunk的下一块为释放的块</span></span><br><span class="line">        <span class="keyword">if</span>(fd_chunk == top_chunk)<span class="comment">//发现是 Top chunk</span></span><br><span class="line">             merge(fd_chunk, top_chunk)</span><br><span class="line">         <span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">// 合并相邻的下一块</span></span><br><span class="line">           <span class="comment">// 将下一块从其所在bins移除掉</span></span><br><span class="line">         	 unlink(fd_chunk);</span><br><span class="line">           <span class="comment">// 当前chunk-&gt;size += fd_chunk-&gt;size</span></span><br><span class="line">           <span class="comment">// 更新下下一chunk 的 prev_size = bk_chunk-&gt;size</span></span><br><span class="line">           merge(chunk, fd_chunk, fd_fd_chunk);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -------------------------------- relloc ---------------------------------</span></span><br><span class="line"><span class="keyword">void</span>* __libc_relloc(<span class="keyword">void</span>* ptr, <span class="keyword">size_t</span> new_size)&#123;</span><br><span class="line">    <span class="keyword">void</span>* chunk = ptr - <span class="number">0x10</span>;</span><br><span class="line">    chunksize = ((need_size<span class="number">-1</span>)&amp;~<span class="number">0b1111</span>) + <span class="number">0x20</span>;</span><br><span class="line">    <span class="keyword">void</span> *fd_chunk = chunk + chunk-&gt;size;</span><br><span class="line">    <span class="keyword">if</span>(chunksize &lt; chunk-&gt;size)&#123; <span class="comment">// 缩容</span></span><br><span class="line">        <span class="keyword">if</span>(chunk-&gt;size - chunksize &gt;=<span class="number">32</span> )&#123;<span class="comment">// 分裂出的部分如果达到 块的最小大小(32 字节)</span></span><br><span class="line">            chunk-&gt;size = chunksize;</span><br><span class="line">            _int_free(chunk + chunk-&gt;size + <span class="number">0x10</span>);</span><br><span class="line">            <span class="keyword">return</span> chunk;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">goto</span> new_copy;</span><br><span class="line">        &#125;</span><br><span class="line">      	</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 扩容</span></span><br><span class="line">        <span class="keyword">if</span>(fd_chunk == top_chunk)&#123; <span class="comment">// 已分配的块后一块是 Top chunk</span></span><br><span class="line">            top_chunk_size = top_chunk-&gt;size - (chunksize - chunk-&gt;size);</span><br><span class="line">            top_chunk = chunk + new_size;</span><br><span class="line">            top_chunk-&gt;size = top_chunk_size;</span><br><span class="line">            top_chunk-&gt;prev_inuse = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> chunk;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">void</span>* fd_fd_chunk = fd_chunk + fd_chunk-&gt;size;</span><br><span class="line">            <span class="keyword">if</span>(fd_fd_chunk-&gt;prev_inuse == <span class="literal">false</span> &amp;&amp;                <span class="comment">// chunk的下一块为释放的块</span></span><br><span class="line">              (fd_chunk-&gt;size + chunk-&gt;size) - chunksize &gt;=<span class="number">32</span> )&#123;  <span class="comment">// 且大小满足</span></span><br><span class="line">                unlink(fd_chunk);</span><br><span class="line">                _int_free(fd_chunk);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(fd_fd_chunk-&gt;prev_inuse == <span class="literal">false</span> &amp;&amp;           <span class="comment">// chunk的下一块为释放的块</span></span><br><span class="line">                   (fd_chunk-&gt;size + chunk-&gt;size) == chunksize)&#123;  <span class="comment">// 且大小相等</span></span><br><span class="line">              	unlink(fd_chunk);</span><br><span class="line">            &#125;<span class="comment">//否则</span></span><br><span class="line">            <span class="keyword">goto</span> new_copy;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//impossible</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">new_copy:</span><br><span class="line">    <span class="keyword">void</span>* res = <span class="built_in">malloc</span>(new_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(res, ptr, chunk-&gt;size - <span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">  	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="unlink-Attack"><a href="#unlink-Attack" class="headerlink" title="unlink Attack"></a>unlink Attack</h2><img src="/2020/12/16/ptmalloc/image-20201218114127335.png" alt="image-20201218114127335" style="zoom:50%;">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F; ----------------------- unlink ---------------------------</span><br><span class="line"></span><br><span class="line">    &#x2F;*</span><br><span class="line">		fakefd-&gt;bk &#x3D;&#x3D; fake_chunk</span><br><span class="line">		fakebk-&gt;fd &#x3D;&#x3D; fake_chunk</span><br><span class="line">		&#123;</span><br><span class="line">			*ptr &#x3D;&#x3D; chunk</span><br><span class="line">			fakefd &#x3D; ptr - 0x18</span><br><span class="line">			fakebk &#x3D; ptr - 0x10</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		fakefd-&gt;bk &#x3D; fakebk</span><br><span class="line">		fakebk-&gt;fd &#x3D; fakefd;</span><br><span class="line">		&#123;</span><br><span class="line">			导致 *(ptr - 0x18 + 0x18) &#x3D; ptr - 0x10</span><br><span class="line">			导致 *(ptr - 0x10 + 0x10) &#x3D; ptr - 0x18</span><br><span class="line">			也就是 *ptr &#x3D; ptr - 0x18</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		*&#x2F;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Fastbin-attack"><a href="#Fastbin-attack" class="headerlink" title="Fastbin_attack"></a>Fastbin_attack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="The-House-of-Prime-glibc-2-3-5-2-19"><a href="#The-House-of-Prime-glibc-2-3-5-2-19" class="headerlink" title="The House of Prime glibc [2.3.5 - 2.19)"></a>The House of Prime glibc [2.3.5 - 2.19)</h2><p>此方法是利用 glibc 在判断 Fast Bins 的下标时的 一个疏忽来破坏main_arena中的数据, 在早期的glibc 2.3.5 版本中, main_arena 结构与现在有所不同:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> &#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access. */</span></span><br><span class="line">  <span class="keyword">mutex_t</span> mutex;</span><br><span class="line">  <span class="comment">// Should we have padding to move the mutex to its own cache line?</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> THREAD_STATS</span></span><br><span class="line">  <span class="comment">/* Statistics for locking. Only used if THREAD_STATS is defined. */</span></span><br><span class="line">  <span class="keyword">long</span> stat_lock_direct, stat_lock_loop, stat_lock_wait; </span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">/* The maximum chunk size to be eligible for fastbin */</span></span><br><span class="line">  INTERNAL_SIZE_T max_fast; <span class="comment">/* low 2 bits used as flags */</span></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbins[NFASTBINS]; ...</span><br></pre></td></tr></table></figure>

<p>而 glibc 在根据块大小取得 Fast bins 数组下标时 使用的宏如下面所示:</p>
<p><strong>#define fastbin_index(sz) ((((unsigned int)(sz)) &gt;&gt; 3) - 2)</strong></p>
<p>若此时的 sz 为 8, 则最后得到的下标为 (8 &gt;&gt; 3) – 2 = –1, 这就意味着若溢出时将下一块的 sz 修改为 8,则会造成 fastbins 数组的上一个域即 max_fast 变量遭到破坏。</p>
<p>但在glibc 2.19版本中, main_arena的结构已经 发生了变化, 虽然 <em>fastbin_index</em> 宏仍然存在漏洞, 但 在 fastbins 数组的前面不再是 max_fast 变量, 此变量 被移出结构体作为全局变量 global_max_fast 使用, 这样一来, 通过破坏前一个域来进行利用的方法已 不可行。</p>
<h2 id="The-House-of-Mind-当前流行的-glibc-中已不再可行"><a href="#The-House-of-Mind-当前流行的-glibc-中已不再可行" class="headerlink" title="The House of Mind.  [当前流行的 glibc 中已不再可行]"></a>The House of Mind.  [当前流行的 glibc 中已不再可行]</h2><p>此方法在当前流行的 glibc 中已不再可行, glibc 在 free 时都需要对 Unsorted bin 进行检查, 确认其中 的第一个块的后向指针是否指向自身, 如此一来若 攻击者将 Unsorted bin 指向希望控制的内存区域, 则 会导致检查失败而无法利用。</p>
<h2 id="The-House-of-Force-【需要进行heap泄露】"><a href="#The-House-of-Force-【需要进行heap泄露】" class="headerlink" title="The House of Force 【需要进行heap泄露】"></a>The House of Force 【需要进行heap泄露】</h2><p>此方法通过<strong>溢出Top chunk的size域来欺骗glibc</strong>, 使得攻击者 malloc 一个很大的数目(负有符号整数) 时能够使用 Top chunk 来进行分配, 此时 Top chunk 的位置会加上这个大数, 造成整数溢出, 结果是 Top chunk 能够被转移到堆之前的内存地址(如程序的.bss 段, .data 段, GOT 表等), 下次再执行 malloc 时, 就会 返回转移之后的地址, 攻击者即能够控制其他的内 存数据。</p>
<p><strong>32为例子</strong></p>
<ul>
<li><p>攻击者溢出 Top chunk 的上一块, 将 Topchunk 的大小修改为 0xffffffff。</p>
</li>
<li><p>攻击者需要能够控制下一次 malloc 时传入的</p>
</li>
<li><p>大小, 此时传入 0xffffffec, 经过处理得到的大小是 0xfffffff0, glibc 的大小使用的是 size_t 类型存储, 这 是一种与机器字长相等的无符号整形。故此时 glibc 认为 0xffffffff &gt; 0xfffffff0, 即 Top chunk 的空间足够, 于是使用 Top chunk 进行分配。假设 Top chunk 之前 的位置是 0x804a010 分配后, Top chunk 的地址将处 于 0x804a010 + 0xfffffff0 = 0x804a000。</p>
</li>
</ul>
<p>下次 malloc 时, 攻击者就能够取得 0x804a000 这块内存, 进一步修改就能够干扰程序的运行。</p>
<p>此方法的缺点在于, 会受到之后提到的 ASLR 技术的影响, 如果攻击者需要修改指定位置的内存, 他需要知道当前 Top chunk 的位置以构造合适的 malloc 大小来取得对应的内存。而 ASLR 开启时, glibc 的堆内存地址将会是随机的, 如果想要利用此 项技术, 则需要进行信息泄露。</p>
<h2 id="The-House-of-Lore-【可行】"><a href="#The-House-of-Lore-【可行】" class="headerlink" title="The House of Lore 【可行】"></a>The House of Lore 【可行】</h2><p>glibc 2.19也可使用，需绕过</p>
<p>此方法希望通过<strong>破坏</strong>已经放入 <strong>Small bins 中块 的 bk 指针</strong>来达到取得任意地址的目的</p>
<p>在早期的 glibc 2.3.5 版本的_int_malloc 中, 处理 Small Bins 的 代码如下所示:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参考上面的 find_from_smallbin</span></span><br><span class="line">bin = small_bin[idx] - <span class="number">0x10</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// 能够 chunk-&gt;bk = fake_chunk</span></span><br><span class="line"><span class="built_in">malloc</span>(nb)&#123;</span><br><span class="line">    <span class="comment">// fake_bck = fake_chunk-&gt;bk</span></span><br><span class="line">    <span class="comment">// 导致 bck-&gt;fd = bin;</span></span><br><span class="line">    <span class="comment">// 导致 bin-&gt;bk = fake_bck</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">malloc</span>(nb)&#123;</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即如果请求的大小符合 Small Bins, 则在对应的 bin 中寻找是否有空闲的块, 如果有就直接从 bin 的 链表中解链并返回给用户。</p>
<p>基于上面的机制, 当一个块存在于 Small Bin 的 第一个块(这里的第一块指的是在取 Small Bin 块时 选择的第一块, 即 Small Bin 的 bk 指针指向的那一块) 时, 通过溢出修改其 bk 指针指向某个地址 ptr, 当下 一次 malloc 对应大小的块时, 就有 bck = victim-&gt;bk= ptr, 且 bin-&gt;bk = bck = ptr, 这样以来就成功地将这 个 bin 的第一块指向了 ptr, 下次再 malloc 对应大小 就能够返回 ptr+16 的位置了, 这样攻击者再对取回 的块进行写入就能控制 ptr+16 的内存内容。</p>
<p>尽管在 glibc 2.19 版本的代码中, 已经加入了对 应的防御机制, <strong>通过检查 bin 中第二块的 bk (我感觉是fd) 指针是 否指向第一块</strong>, 可以发现对 Small bins 的破坏。但攻 击者如果同时伪造了 bin 中的前 2 块(<strong>smallbin-&gt;bk</strong>-&gt;bk-&gt;fd == smallbin-&gt;bk), 就可以绕过这 个检查。故此种利用方式仍然可以进行。</p>
<h2 id="The-House-of-Spirit-fastbins-attack"><a href="#The-House-of-Spirit-fastbins-attack" class="headerlink" title="The House of Spirit [fastbins attack]"></a>The House of Spirit [fastbins attack]</h2><p>此方法通过堆的Fast bin机制来辅助栈溢出的利 用, 一般的栈溢出漏洞的利用都希望能够覆盖函数 的返回地址以控制 EIP 来劫持控制流, 但若栈溢出 的长度无法覆盖返回地址, 但是能够覆盖到栈上的 一个即将被 free 的堆指针, 此时可以将这个指针改 写为栈上的地址并在相应位置构造一个 Fast bin 块的 元数据。接着在 free 操作时, 这个栈上的“堆块”即 被投入 Fast Bin 中, 下一次 malloc 对应的大小时, 由 于 Fast Bin 的机制为先进后出, 故上次 free 的栈上的 “堆块”能够被优先返回给用户, 再次写入时就可能 造成返回地址的改写, 亦可进行信息泄漏。</p>
<p>此方法的缺点与<em>The House of Force</em>方法类似, 需要对栈地址进行泄漏, 否则无法正确覆盖需要释 放的堆指针, 且在构造数据时, 需要满足对齐的要 求, 存在很多的限制。</p>
<h2 id="现代保护手段NX-ALSR-PIE-RELRO"><a href="#现代保护手段NX-ALSR-PIE-RELRO" class="headerlink" title="现代保护手段NX ALSR PIE RELRO"></a>现代保护手段NX ALSR PIE RELRO</h2><ul>
<li>不可执行位 NX Bit </li>
<li>地址空间布局随机化 ASLR</li>
<li>位置无关可执行文件 PIE </li>
<li>重定位只读 RELRO <ol>
<li>部分 RELRO: 在程序装入后, 将其中一些段 (如.dynamic)标记为只读, 防止程序的一些重定位信 息被修改。 </li>
<li>完全 RELRO: 在部分 RELRO 的基础上, 在 程序装入时, 直接解析完所有符号并填入对应的值, 此时所有的 GOT 表项都已初始化, 且不装入 link_map 与_dl_runtime_resolve 的地址(二者都是程 序动态装载的重要结构和函数)。 </li>
</ol>
</li>
</ul>
<h2 id="堆的攻击手段"><a href="#堆的攻击手段" class="headerlink" title="堆的攻击手段"></a>堆的攻击手段</h2><ol>
<li> 现代利用手段 </li>
</ol>
<ul>
<li>现代解链操作  UNLINK 攻击当前的glibc对unlink宏进行了 加固, 传统的 unlink 利用方法已不再可行。为了绕过 当前的 glibc 对 unlink 做的检查, 需要在内存中找到 指向构造的伪块的指针 </li>
<li>攻击 Fast bins </li>
<li>释放后使用漏洞的利用 </li>
<li>两次释放漏洞的利用 double-free</li>
<li>改写 Realloc Hook </li>
<li>利用单字节溢出漏洞 </li>
<li>扩展被释放块 </li>
<li>扩展已分配块 </li>
<li>收缩被释放块 </li>
<li>攻击 Unsorted Bin </li>
<li>重分配函数的利用 </li>
</ul>
<h2 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(a)</span><br><span class="line"><span class="comment">// fast -&gt; a -&gt; null</span></span><br><span class="line"><span class="built_in">free</span>(b)</span><br><span class="line"><span class="comment">// fast -&gt; b -&gt; a -&gt; null</span></span><br><span class="line"><span class="built_in">free</span>(a)</span><br><span class="line"><span class="comment">// fast -&gt; a -&gt; b -&gt; a -&gt; b</span></span><br><span class="line">d = <span class="built_in">malloc</span>() <span class="comment">// = a</span></span><br><span class="line"><span class="comment">// fast -&gt; b -&gt; a -&gt; b</span></span><br><span class="line">e = <span class="built_in">malloc</span>() <span class="comment">// = b</span></span><br><span class="line"><span class="comment">// fast -&gt; a -&gt; b</span></span><br><span class="line">change(e) &#123;<span class="comment">//就等于change b</span></span><br><span class="line">		e-&gt;fd = free_got;</span><br><span class="line">    f = <span class="built_in">malloc</span>() <span class="comment">// = a</span></span><br><span class="line">    <span class="comment">// fast -&gt; b -&gt; free_got</span></span><br><span class="line">    <span class="built_in">malloc</span>()</span><br><span class="line">    change(<span class="built_in">malloc</span>())</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="realloc-hook-fastbin-attack"><a href="#realloc-hook-fastbin-attack" class="headerlink" title="__realloc_hook [fastbin attack]"></a>__realloc_hook [fastbin attack]</h2><p>__realloc_hook 在程序启动时有一个非 0 的初 始化值, 在 64 位系统中, 这个地址将以 7f 开头</p>
<p>攻击者能够通过刻意的内存地址错位来进行 Fast Bin Attack, 从而达到改写__realloc_hook 的目的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7dd3798</span> &lt;_IO_stdfile_0_lock+<span class="number">8</span>&gt;:  <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd37a8</span> &lt;__free_hook&gt;:   <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="number">0x7ffff7dd1ae8</span> &lt;_IO_wide_data_0+<span class="number">296</span>&gt;:   <span class="number">0x0000000000000000</span>      <span class="number">0x00007ffff7dd0260</span></span><br><span class="line"><span class="number">0x7ffff7dd1af8</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x00007ffff7a92ea0</span></span><br><span class="line"><span class="number">0x7ffff7dd1b08</span> &lt;__realloc_hook&gt;:        <span class="number">0x00007ffff7a92a70</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b18</span>: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000100000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b28</span> &lt;main_arena+<span class="number">8</span>&gt;:  <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b38</span> &lt;main_arena+<span class="number">24</span>&gt;: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b48</span> &lt;main_arena+<span class="number">40</span>&gt;: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b58</span> &lt;main_arena+<span class="number">56</span>&gt;: <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000000000</span></span><br><span class="line">  </span><br><span class="line">__realloc_hook = main_arena - <span class="number">0x20</span></span><br><span class="line">__free_hook = main_arena - <span class="number">0x1c88</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 0x7fxxxxxxxx</span></span><br><span class="line">  <span class="comment">// chunk = 7fpointer - 8 + 5. size = 0x7f</span></span><br><span class="line">freed_fastchunk-&gt;fd = &amp;__realloc_hook - <span class="number">8</span> + <span class="number">5</span></span><br></pre></td></tr></table></figure>





<h2 id="Off-by-one-单字节溢出漏洞"><a href="#Off-by-one-单字节溢出漏洞" class="headerlink" title="Off-by-one 单字节溢出漏洞"></a>Off-by-one 单字节溢出漏洞</h2><p>通过溢出下一个块的size域,攻击者能够在堆中创造出重叠的内存块</p>
<h3 id="扩展被释放块"><a href="#扩展被释放块" class="headerlink" title="扩展被释放块"></a>扩展被释放块</h3><p>若溢出块的下一块为被释放的块且处于Unsorted Bin 中, 则可以通过溢出一个字节来将其大 小扩大, 下次取得此块时就意味着其后的块将被覆 盖而造成进一步的溢出。</p>
<img src="/Users/notify/OneDrive/notifyall/pwn/ptmalloc.assets/image-20201218181759112.png" alt="image-20201218181759112" style="zoom:50%;">

<h3 id="扩展已分配块"><a href="#扩展已分配块" class="headerlink" title="扩展已分配块"></a>扩展已分配块</h3><p>若溢出块的下一块为使用中的块, 则需要合理 控制溢出的字节, 使其被释放时的合并操作能够顺 利进行, 例如直接加上下一块的大小使其完全被覆 盖。下一次分配对应大小时, 即可取得已经被扩大的 块, 并造成进一步溢出。</p>
<img src="/Users/notify/OneDrive/notifyall/pwn/ptmalloc.assets/image-20201218181813210.png" alt="image-20201218181813210" style="zoom:50%;">

<h3 id="收缩被释放块"><a href="#收缩被释放块" class="headerlink" title="收缩被释放块"></a>收缩被释放块</h3><p> 此情况针对溢出的字节只能为 0 的情况, 此时</p>
<p>可以将下一个被释放块的大小缩小, 如此一来在之 后分裂此块时将无法正确更新后一块的 prev_size 域,导致释放时出现重叠的堆块。</p>
<img src="/Users/notify/OneDrive/notifyall/pwn/ptmalloc.assets/image-20201218183231401.png" alt="image-20201218183231401" style="zoom:50%;">

<p>B2为fasten</p>
<h2 id="The-House-of-Einherjar"><a href="#The-House-of-Einherjar" class="headerlink" title="The House of Einherjar"></a>The House of Einherjar</h2><p>此方法也是针对溢出字节只能为 0 的情况, 利 用的思路是不将溢出块下一块的大小缩小, 而是仅 仅更新后一块的 prev_size 域, 使其在被释放时能够 找到之前一个合法的被释放块并与其合并, 造成堆 块的重叠</p>
<img src="/Users/notify/OneDrive/notifyall/pwn/ptmalloc.assets/image-20201218183211613.png" alt="image-20201218183211613" style="zoom:50%;">

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C-&gt;prev_size = <span class="number">0x200</span></span><br><span class="line">LOWb(C-&gt;size) = <span class="number">0</span> <span class="comment">// prev_inuse = false</span></span><br><span class="line"><span class="built_in">free</span>(C);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x300</span><span class="number">-8</span>) <span class="comment">// = A+B+C</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="成功后的利用方式"><a href="#成功后的利用方式" class="headerlink" title="成功后的利用方式"></a>成功后的利用方式</h3><h4 id="malloc包含已释放块"><a href="#malloc包含已释放块" class="headerlink" title="malloc包含已释放块"></a>malloc包含已释放块</h4><p>如果是fastbin那就简单</p>
<h4 id="malloc包含已分配块"><a href="#malloc包含已分配块" class="headerlink" title="malloc包含已分配块"></a>malloc包含已分配块</h4><h2 id="攻击-Unsorted-Bin-可le-a-k"><a href="#攻击-Unsorted-Bin-可le-a-k" class="headerlink" title="攻击 Unsorted Bin [可le a k]"></a>攻击 Unsorted Bin [可le a k]</h2><p>当 Unsorted Bin 中的块恰好为分配的块大小时</p>
<p>则会直接从 Unsorted Bin 中移除 返回给用户。若不是, 则将其投入对应的 Bin 之中。</p>
<p>无论结果如何, 其最终都将从 Unsorted Bin 中移除, 而这里移除使用的方法并<strong>不是 2.3 节中释放操作使 用的 unlink 宏</strong>, 而是如下代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bck = victim-&gt;bk; </span><br><span class="line">...</span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck; </span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>

<p>不同于 unlink 宏, 这里对 Unsorted Bin 的链表完 整性并没有做检查, 导致如果能够可以修改某一个 处于 Unsorted Bin 中的块的 bk 指针, 则可以造成一 个任意内存写入, 可以将 bk + 16 的位置改写为 Unsorted Bin 的地址, 但 Unsorted Bin 的 bk 指针将被 破坏, 下一次再使用 Unsorted Bin 时, 将可能由于 bck 的位置不可写而造成程序崩溃。</p>
<p>Leak: 如果last-&gt;bk = ptr, 则malloc后， ptr-&gt;fd = unsorted_bin, 可以直接泄漏ptr-&gt;fd, 且无检查</p>
<h1 id="2-29-tcache-【无le-a-k】"><a href="#2-29-tcache-【无le-a-k】" class="headerlink" title="2.29 tcache 【无le a k】"></a>2.29 tcache 【无le a k】</h1><p>tcache全称thread local caching，是<strong>glibc2.26</strong>后新加入的一种缓存机制（在Ubuntu 18及之后的版本中应用），提升了不少性能，但是与此同时也大大牺牲了安全性，在ctf-wiki中介绍tcache的标题便是tcache makes heap exploitation easy again，与fastbin非常相似但优先级高于fastbin，且相对于fastbin来说少了很多检查，所以更加便于进行漏洞利用。</p>
<ul>
<li>可直接double free</li>
<li></li>
</ul>
<p>tcache 和 fastbin在free中并没有被清除inuse标志</p>
<ol>
<li><p>tcache机制的主体是tcache_perthread_struct结构体，其中包含单链表tcache_entry</p>
</li>
<li><p>单链表tcache_entry，也即tcache Bin的默认最大数量是<strong>64</strong>，在64位程序中申请的最小chunk size为32，之后以16字节依次递增，所以size大小范围是0x20-0x410，也就是说我们必须要malloc size≤0x408的chunk</p>
</li>
<li><p>每一个单链表tcache Bin中默认允许存放的chunk块最大数量是<strong>7</strong></p>
</li>
<li><p>在申请chunk块时，如果<code>tcache Bin</code>中有符合要求的chunk，则直接返回；</p>
<p>如果在fastbin中有符合要求的chunk，则先将对应fastbin中其他chunk加入相应的tcache Bin中，直到达到tcache Bin的数量上限，然后返回符合符合要求的chunk；</p>
<p>如果在smallbin中有符合要求的chunk，则与fastbin相似，先将双链表中的其他剩余chunk加入到tcache中，再进行返回</p>
</li>
<li><p>在释放chunk块时，如果chunk size符合tcache Bin要求且相应的tcache Bin没有装满，则直接加入相应的tcache Bin</p>
</li>
<li><p>与fastbin相似，在tcache Bin中的chunk不会进行合并，因为它们的<code>pre_inuse</code>位会置成1</p>
</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">	idx <span class="number">0</span>   bytes <span class="number">0.</span><span class="number">.24</span> (<span class="number">64</span>-bit) <span class="keyword">or</span> <span class="number">0.</span><span class="number">.12</span> (<span class="number">32</span>-bit) <span class="number">16</span></span><br><span class="line">  idx <span class="number">1</span>   bytes <span class="number">25.</span><span class="number">.40</span> <span class="keyword">or</span> <span class="number">13.</span><span class="number">.20</span> <span class="number">17</span></span><br><span class="line">  idx <span class="number">2</span>   bytes <span class="number">41.</span><span class="number">.56</span> <span class="keyword">or</span> <span class="number">21.</span><span class="number">.28</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span>        <span class="comment">//默认允许存放的chunk块最大数量是 7</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];     <span class="comment">//数组counts用于存放每个bins中的chunk数量</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">entries</span>[<span class="title">TCACHE_MAX_BINS</span>/*64*/];</span>   <span class="comment">//数组entries用于放置64个bins</span></span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">//指向chunk当中的用户内存区，第一个变量是一个指针，指向tcache的下一个chunk，</span></span><br><span class="line">	<span class="comment">//就是单链表访问</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* 这个字段是用来检测双重free释放的  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>tcache机制允许将空闲的chunk以链表的形式缓存在线程各自tcache的bin中。</p>
<p>下一次malloc时可以优先在tcache中寻找符合的chunk并提取出来。</p>
<p>他缺少充分的安全检查，如果有机会构造内部chunk数据结构的特殊字段，我们可以有机会获得任意想要的地址。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">+tcache_put (mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span><br><span class="line">+&#123;</span><br><span class="line">+  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">+  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">+  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">+  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">+  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">+&#125;</span><br><span class="line"></span><br><span class="line">+<span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line">+tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">+&#123;</span><br><span class="line">+  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">+  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">+  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">+  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">+  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">+  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">+&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">//检查bytes合法性,并获取请求的标准chunk大小</span></span><br><span class="line">  checked_request2size (bytes, tbytes);</span><br><span class="line">  <span class="comment">//获得tcache对应请求大小bin的索引</span></span><br><span class="line">  <span class="keyword">size_t</span> tc_idx = csize2tidx (tbytes);</span><br><span class="line">  <span class="comment">//如果没有初始化tcache，那么我们初始化tcache</span></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line"></span><br><span class="line">  DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">  <span class="comment">//检查tcache给定索引是否有chunk满足条件，有就直接取出来</span></span><br><span class="line">  <span class="comment">//索引大小不能超过index，并且tcache存在，并且tcache对应索引有块，初始化时不为0</span></span><br><span class="line">  <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">      <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">      &amp;&amp; tcache</span><br><span class="line">      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get (tc_idx);<span class="comment">//获取tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file:<span class="comment">///Users/notify/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/</span></span><br></pre></td></tr></table></figure>

<p>file:///Users/notify/ctf-wiki/site/pwn/linux/glibc-heap/tcache_attack-zh/index.html</p>
<ol>
<li></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2020/10/17/sdk-adb-qemu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/17/sdk-adb-qemu/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-17T19:32:00+08:00">
                2020-10-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SDK"><a href="#SDK" class="headerlink" title="SDK"></a>SDK</h1><h2 id="emulator"><a href="#emulator" class="headerlink" title="emulator"></a>emulator</h2><p>${ANDROID_SDK_HOME}/emulator</p>
<p>这个qemu是avd模拟器简化的**${ANDROID_SDK_HOME}/emulator/qemu/darwin-x86_64//qemu-system-x86_64** 不使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">emulator -list-avds</span><br><span class="line">emulator -avd Pixel_3_API_29 -writable-system -no-snapstorage</span><br></pre></td></tr></table></figure>

<p><code>avd</code>在<code>$HOME/.android/avd</code></p>
<h2 id="adb"><a href="#adb" class="headerlink" title="adb"></a>adb</h2><p>${ANDROID_SDK_HOME}/platform-tools/adb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$adb</span> start-server //启动adb</span><br><span class="line"><span class="variable">$adb</span> kill-server</span><br><span class="line"><span class="comment">#-l 锁定该程序</span></span><br><span class="line"><span class="comment">#-r 重新安装该程序，保存数据</span></span><br><span class="line"><span class="comment">#-s 安装在SD卡内，而不是设备内部存储</span></span><br><span class="line"><span class="variable">$adb</span> install -r [apk文件]</span><br><span class="line"><span class="comment">#日志</span></span><br><span class="line"><span class="variable">$adb</span> logcat | grep <span class="string">&quot;jc&quot;</span></span><br><span class="line"><span class="comment">#radio 输出通信系统的log</span></span><br><span class="line"><span class="comment">#system 输出系统组件的log</span></span><br><span class="line"><span class="comment">#events 输出event的log</span></span><br><span class="line"><span class="comment">#main 输出java层的log</span></span><br><span class="line"><span class="variable">$adb</span> logcat -b radio</span><br><span class="line"><span class="comment">#强杀</span></span><br><span class="line"><span class="variable">$adb</span> shell am force-stop &lt;packagename&gt;</span><br><span class="line"><span class="comment">#获取设备的ID和序列号</span></span><br><span class="line"><span class="variable">$adb</span> get-product </span><br><span class="line"><span class="variable">$adb</span> root</span><br><span class="line"><span class="variable">$adb</span> disable-verity</span><br><span class="line"><span class="variable">$adb</span> shell getprop ro.product.cpu.abi</span><br><span class="line"><span class="variable">$adb</span> shell <span class="string">&#x27;mount -o rw,remount -t auto /system&#x27;</span></span><br><span class="line"><span class="variable">$adb</span> forward tcp:23496 tcp:23496 </span><br><span class="line"><span class="variable">$adb</span> reboot bootloader</span><br><span class="line"><span class="comment">#通过adb启动应用程序页面</span></span><br><span class="line"><span class="variable">$adb</span> shell am start -D -n com.example.how_debug/com.example.how_debug.MainActivity</span><br><span class="line"><span class="variable">$adb</span> push <span class="string">&quot;C:\Program Files\IDA 7.0\dbgsrv\android_x64_server&quot;</span> /data/<span class="built_in">local</span>/ax64</span><br><span class="line"><span class="variable">$adb</span> shell <span class="string">&#x27;chmod +x /data/local/*&#x27;</span></span><br><span class="line"><span class="variable">$adb</span> shell <span class="string">&#x27;cd /data/local/ &amp;&amp; ./ax64&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="fastboot"><a href="#fastboot" class="headerlink" title="fastboot"></a>fastboot</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot oem unlock</span><br></pre></td></tr></table></figure>

<h1 id="other"><a href="#other" class="headerlink" title="other"></a>other</h1><h2 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o rw,remount -t auto &#x2F;system</span><br></pre></td></tr></table></figure>



<h2 id="Jeb条件"><a href="#Jeb条件" class="headerlink" title="Jeb条件"></a>Jeb条件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:debuggable&#x3D;&quot;true&quot; </span><br><span class="line">ro.debuggable&#x3D;1</span><br></pre></td></tr></table></figure>

<p>install <strong>MagiskHide Props Config</strong> and then:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb shell &#x2F;&#x2F;adb进入命令行模式</span><br><span class="line">su &#x2F;&#x2F;切换至超级用户</span><br><span class="line">magisk resetprop ro.debuggable 1  &#x2F;&#x2F;设置debuggable</span><br><span class="line">stop;start; &#x2F;&#x2F;一定要通过该方式重启</span><br></pre></td></tr></table></figure>

<p>Android手机系统的 ro.debuggable 这一配置位于 /default.prop 文件中，而 /default.prop 又来源于手机每次启动时 boot.img 中 ramdisk 的挂载，所以想要直接通过修改 /default.prop 是不可行的，但是系统文件是只读的，改了也没用。网上流传较广的是改 boot.img</p>
<h1 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yinzhengjie/p/7846595.html">https://www.cnblogs.com/yinzhengjie/p/7846595.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install qemu</span><br><span class="line">brew install libvirt</span><br><span class="line">brew services start libvirt</span><br></pre></td></tr></table></figure>



<h2 id="1-创建磁盘映像"><a href="#1-创建磁盘映像" class="headerlink" title="1.创建磁盘映像"></a>1.创建磁盘映像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$qemu</span>-img create -f qcow2 ~/qemu/images/ubuntu-desktop-18.04.qcow2 10G</span><br></pre></td></tr></table></figure>



<h2 id="2-启动附加了Ubuntu-ISO的QEMU"><a href="#2-启动附加了Ubuntu-ISO的QEMU" class="headerlink" title="2.启动附加了Ubuntu ISO的QEMU"></a>2.启动附加了Ubuntu ISO的QEMU</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -accel hvf </span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -cpu host -smp 3 -enable-kvm -machine accel=hvf -m 2048 \</span><br><span class="line">  -net user,hostfwd=tcp::2222-:22 -net nic \</span><br><span class="line">  -usb -device usb-tablet \</span><br><span class="line">  -display default,show-cursor=on \</span><br><span class="line">  -vga virtio \</span><br><span class="line">  -cdrom ~/Parallels/Parallels\ iso/ubuntu-18.04.4-desktop-amd64.iso \</span><br><span class="line">  -drive file=/Users/notify/qemu/images/ubuntu-desktop-18.04.qcow2,<span class="keyword">if</span>=virtio,index=0,format=qcow2,media=disk \</span><br><span class="line">  -boot order=dc </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">#-net user,hostfwd=tcp::4444-:5555</span></span><br><span class="line">  </span><br><span class="line">选项解释：</span><br><span class="line"><span class="comment"># cpu 内存</span></span><br><span class="line">-enable-kvm 是使用kvm内核,不用qemu的内核,开启虚拟机加速；</span><br><span class="line">-accel hvf </span><br><span class="line">-m 1024是给客户机分配1024MB内存；</span><br><span class="line">-smp 1 是给客户机分配1个CPU；</span><br><span class="line"><span class="comment"># 磁盘</span></span><br><span class="line">-boot order=dc是指定系统的启动顺序为光驱(d: CD-ROM)、硬盘(c: hard Disk)；</span><br><span class="line">-hda 是分配给客户机的IDE硬盘（即前面准备的镜像文件）；</span><br><span class="line">-boot order=dc</span><br><span class="line">-fda : (file) ;</span><br><span class="line">-fdb : (file) ; 使用指定文件（file）作为软盘镜像，</span><br><span class="line">-hda ：（file）；</span><br><span class="line">-hdb ：（file）；</span><br><span class="line">-hdc ：（file）；</span><br><span class="line">-hdd ：（file）; 使用指定file作为镜像硬盘镜像；file为/dev/fd0表示使用物理；</span><br><span class="line">-cdrom （默认占用hdc接口）是分配客户机的光驱。将file指定为/dev/cdrom可以直接使用物理光驱</span><br><span class="line">-drive：（ option[,option[,option[,.....]]]）定义一个新的硬盘设备，可用子选项有很多。</span><br><span class="line">　　file=/path/to/somefile:定义映像文件路径；</span><br><span class="line">　　<span class="keyword">if</span>=interface:指定硬盘设备所连接接口类型，即控制器类型，如</span><br><span class="line">　　ide,scsi,sd,mtd,floppy,pflash及virtio等；</span><br><span class="line">　　index=index:设定同一种控制器类型中不同设备的索引号，即标识号；</span><br><span class="line">　　media=media:定义截止类型为硬（disk）盘还是光盘（cdrom）；</span><br><span class="line">　　snapshot=snapshot:指定当前硬盘设备是否支持快照功能，on或off；</span><br><span class="line">　　cache=cache：定义如何使用物理机缓存来访问块数据，其可用值有</span><br><span class="line">　　none,writeback,unsafe和writethrough四个；</span><br><span class="line">　　format=format：指定映像文件格式，具体格式可参见qemu-img命令；</span><br><span class="line">-boot：（[order=drives][,once=drives][,menu=on|off]）定义启动设备的引导次序，每种设备使用一个字符表示，不同的架构所支持的设备及其表示字符不尽相同，在x86PC架构上,a,b表示软驱，c表示第一块硬盘，d表示第一个光驱设备，n-p表示网络适配器，默认为硬盘设备。（案例：-boot order=dc,once=d，其中order表示启动顺序，意思是先找第一个光驱设备，再去找第一块硬盘启动，而once则表示第一次启动时需要找光驱设备。）</span><br><span class="line"><span class="comment"># 其他硬件</span></span><br><span class="line"><span class="comment"># 显示</span></span><br><span class="line">-nographic : 默认情况下，qemu使用SDL来显示VGA输出；而此新选项用于禁止图形接口，此时，qemu类似一个简单的命令行程序，其仿真串口设备将被重定向到控制台；</span><br><span class="line">			ctrl a h :</span><br><span class="line">          C-a h    <span class="built_in">print</span> this <span class="built_in">help</span></span><br><span class="line">          C-a x    <span class="built_in">exit</span> emulator</span><br><span class="line">          C-a s    save disk data back to file (<span class="keyword">if</span> -snapshot)</span><br><span class="line">          C-a t    toggle console timestamps</span><br><span class="line">          C-a b    send <span class="built_in">break</span> (magic sysrq)</span><br><span class="line">          C-a c    switch between console and monitor</span><br><span class="line">          C-a C-a  sends C-a</span><br><span class="line"></span><br><span class="line">-monitor stdio:表示在标准输入输出显示monitor界面(-nographic)</span><br><span class="line">　　Ctrl-a，c:在console和monitor之间切换</span><br><span class="line">　　Ctrl-a，h：显示帮助信息。</span><br><span class="line">-curses:禁止图形接口，并使用curses/ncurses作为交互接口；</span><br><span class="line">-alt-grab:使用Ctrl+Alt+Shift组合键释放鼠标；</span><br><span class="line">-ctrl-grab:使用右Ctrl键释放鼠标；</span><br><span class="line">-sdl：启用SDL（Simple Directmedia Layer）它是用C语言编写的开源免费的多媒体程序库，它提供了一个简单的接口用于实现操作系统硬件平台的图形显示，声音，输入设备等等。目前来讲，SDL库已经被广泛应用于各个操作系统。换句话说，SDL是是能够让你的虚拟机直接在启动时在当前主机上就直接打开一个图形界面。他要求你操作系统本身要支持SDL。</span><br><span class="line">-spice：（option[,option[,......]]）启用splice远程桌面协议，其有许多子选项，具体请参考qemu-kvm的手册；</span><br><span class="line">-vga <span class="built_in">type</span> : 指定要仿真的VGA接口类型，常见的有： </span><br><span class="line">		cirrus : Cirrus Logic GD5446显示卡；</span><br><span class="line">  	std:带有Bochs VBI扩展的标准VGA显示卡；</span><br><span class="line">  	vmware:VMWare SVGA-II兼容的显示适配器；</span><br><span class="line">  	qxl:QXL半虚拟化显示卡，于VGA兼容，在Guest中安装qxl驱动后能以很好的方式工作，在使用spice协议时推荐使用此类型；</span><br><span class="line">  	none：禁用VGA卡；</span><br><span class="line">-vnc：（display[,option][,option[,......]]）默认情况下，qemu使用SDL显示VGA输出，使用VNC选项，可以让qemu监听在VNC上，并将VGA输出重定向至VNC会话，使用此选项时，必须使用-k选项指定键盘布局类型，其有许多子选项，具体请参考qemu-kvm的手册。VNC（Virtual Network Computing，应用层协议）基于RFB（远程帧缓冲）协议，来控制另外一台计算机系统，它是图像化的桌面分享系统，VNC克服了SDL只能在图形界面中运行的功能。</span><br><span class="line">	[options]:</span><br><span class="line">　　　　password：连接是需要验证密码，设置密码通过monitor接口使用change;</span><br><span class="line">　　　　reverse：“反向”连接至某出于监听状态的vncview上;</span><br><span class="line">　　　　</span><br><span class="line">		example vnc的display指定方法: </span><br><span class="line">		-vnc [ip]:[port],password   <span class="comment"># :1 表示是监听在主机的2500+N端口上！换句话说，就是监听在5901端口。</span></span><br><span class="line">				&gt; <span class="built_in">help</span> change</span><br><span class="line">		    &gt; change vnc password</span><br><span class="line">		-vnc unix:[/path/to/socket_file] <span class="comment"># 这是基于套接字进行连接，这种方式只能局限于在本机工作，无法向第一种基于IP的方式进行连接可以让其他主机来连接本地的服务。</span></span><br><span class="line">		-vnc none <span class="comment"># 表示在启动虚拟机时不启动VNC功能，将来在需要时可以在手动启动起来。</span></span><br><span class="line">				&gt; change vnc :2</span><br><span class="line">				</span><br><span class="line"></span><br><span class="line"><span class="comment"># usb</span></span><br><span class="line">-usb ：开启USB总线</span><br><span class="line">-device usb-tablet GuestOS为Windows时，tablet用于实现鼠标定位。</span><br><span class="line"></span><br><span class="line"><span class="comment"># internet</span></span><br><span class="line">-net：（tap[,valn=n][,name=name][,fd=h][,ifname=name][,script=file][,downscript=dfile]）通过物理机的TAP网络接口连接至VLAN n中，使用script=file指定的脚本（默认为/etc/qemu-ifup）来配置当前网络接口，并使用downscript=file指定的脚本（默认为/etc/qemu-ifdown）来撤销接口配置，使用script=no和downscript=no可分别用来禁止直行脚本；</span><br><span class="line">-net：（user[,option][,option][,....]）在用户模式配置网络栈，其不依赖于管理权限，有效选项有：</span><br><span class="line">  vlan=n ：连接至vlan n，默认n=0；</span><br><span class="line">  name=name：指定接口的显示名称，常用于监控模式中；</span><br><span class="line">  net=addr[/mask]：设定GuestOS可见的IP网络，掩码可选，默认为10.0.2.0/8;</span><br><span class="line">  host=addr：指定GuestOS中看到的物理机的IP地址，默认为指定网络中的第二个，即x.x.x.2;</span><br><span class="line">  dhcpstart=addr:指定DHCP服务地址池中16个地址的起始IP，默认为第16个至第31个，即x.x.x.16-x.x.x.31;</span><br><span class="line">  dns=addr:指定GuestOS可见的dns服务器地址，默认为GuestOS网络中的第三个地址,即x.x.x.3;</span><br><span class="line">  tftp=dir:激活内置的tftp服务器，并使用指定的dir作为tftp服务器的默认根目录；</span><br><span class="line">  bootfile=file：BOOTP文件名称，用于实现网络引导GuestOS，如：<span class="string">&quot;qemu -hda yinzhengjie_linux.img -boot n -net user,tftp=/tftpserver/pub,bootfile=/pxelinux.0&quot;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">扩展小知识：KVM的虚拟网络模型</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">I386平台专用选项；</span><br><span class="line">　　-no-acpi:禁用ACPI功能，GuestOS与ACPI出现兼容问题时使用此选项；</span><br><span class="line">　　-balloon none：禁用balloon设备；</span><br><span class="line">　　-balloon virtio[,addr=addr]:启用virti balloon设备；</span><br></pre></td></tr></table></figure>







<h2 id="3启动系统"><a href="#3启动系统" class="headerlink" title="3启动系统"></a>3启动系统</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">删掉cdrom</span><br></pre></td></tr></table></figure>



<h2 id="qemu配置网卡方法："><a href="#qemu配置网卡方法：" class="headerlink" title="qemu配置网卡方法："></a>qemu配置网卡方法：</h2><p><strong>不使用sdk的qemu（命令不适用）</strong></p>
<p>Brew install qemu</p>
<p>如需要使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$export</span> PATH=<span class="variable">$ANDROID_SDK_HOME</span>/emulator/qemu/darwin-x86_64:<span class="variable">$PATH</span></span><br><span class="line"><span class="variable">$export</span> DYLD_LIBRARY_PATH=<span class="variable">$ANDROID_SDK_HOME</span>/emulator/lib64/qt/lib:<span class="variable">$DYLD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure>



<p>我之前进行过相关的测试，qemu这一块的网络连接的相关方法分享一下，配置起来稍微麻烦一点，需要创建虚拟网卡；<br>如果在本地测试可以通端口映射的方式进行；方法如下：</p>
<h3 id="方法一：创建虚拟网卡"><a href="#方法一：创建虚拟网卡" class="headerlink" title="方法一：创建虚拟网卡"></a>方法一：创建虚拟网卡</h3><p>（注意本地机器上创建的虚拟网卡和qemu上的配置的地址网段的关系）</p>
<p>一、需要安装的工具软件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$apt</span>-get install bridge-utils        <span class="comment"># 虚拟网桥工具</span></span><br><span class="line"><span class="variable">$apt</span>-get install uml-utilities       <span class="comment"># UML（User-mode linux）工具</span></span><br></pre></td></tr></table></figure>

<p>二、配置虚拟网卡的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sudo</span> ifconfig tap0 down</span><br><span class="line"><span class="variable">$sudo</span> tunctl -d tap0</span><br><span class="line"><span class="variable">$sudo</span> tunctl -b -u <span class="variable">$USER</span> -t tap0</span><br><span class="line"><span class="variable">$sudo</span> ifconfig tap0 192.168.10.1 promisc up</span><br></pre></td></tr></table></figure>

<p>三、qemu启动时需要添加相关参数，启动命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$sudo</span> qemu-system-x86_64 -enable-kvm -m 1024 -smp 2  -hda qemu-test/vdisk.img -cdrom android-x86.iso -net nic,vlan=0 -net tap,vlan=0,ifname=tap0,script=no,downscript=no</span><br><span class="line"><span class="comment">#【note 起来之后在qemu中通过命令行设置ip地址】</span></span><br><span class="line"><span class="comment">#然后在宿主机上使用adb connect x.x.x.x 连接qemu中的android系统进行相关的操作；</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="方法二、在启动qemu的时候直接进行端口映射："><a href="#方法二、在启动qemu的时候直接进行端口映射：" class="headerlink" title="方法二、在启动qemu的时候直接进行端口映射："></a>方法二、在启动qemu的时候直接进行端口映射：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sudo</span> qemu-system-x86_64 -enable-kvm -m 1024 -smp 2  -hda ./vdisk.img -cdrom <span class="variable">$android_x86_64</span>.iso -redir tcp:5555::5555</span><br><span class="line"><span class="variable">$adb</span> shell</span><br></pre></td></tr></table></figure>



<h2 id="libvirt"><a href="#libvirt" class="headerlink" title="libvirt"></a>libvirt</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install qemu</span><br><span class="line">brew install libvirt</span><br><span class="line">brew services start libvirt</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#只是创建</span></span><br><span class="line">virsh define ~/qemu/images/ubuntu.xml</span><br><span class="line"><span class="comment">#创建后，虚拟机立即执行，成为活动主机</span></span><br><span class="line">virsh creat ~/qemu/images/ubuntu.xml</span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">xmlns:qemu</span>=<span class="string">&#x27;http://libvirt.org/schemas/domain/qemu/1.0&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>ubuntu<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>2005CB24-522A-4485-9B9A-E60A61D9F8CF<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;GB&#x27;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span>&gt;</span>Westmere<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpu</span>&gt;</span>2<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;q35&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bootmenu</span> <span class="attr">enable</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;localtime&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">suspend-to-mem</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">suspend-to-disk</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/local/bin/qemu-system-x86_64<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ehci&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/Users/notify/qemu/images/ubuntu-desktop-18.04.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;cdrom&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/Users/notify/Parallels/Parallels iso/ubuntu-18.04.4-desktop-amd64.iso&#x27;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;sdb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;sata&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;tablet&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;vnc&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;5900&#x27;</span> <span class="attr">listen</span>=<span class="string">&#x27;127.0.0.1&#x27;</span> <span class="attr">passwd</span>=<span class="string">&#x27;10010&#x27;</span> <span class="attr">keymap</span>=<span class="string">&#x27;en-us&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;16384&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">seclabel</span> <span class="attr">type</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:commandline</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-machine&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;type=q35,accel=hvf&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-netdev&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;user,id=n1,hostfwd=tcp::2222-:22&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-device&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;virtio-net-pci,netdev=n1,bus=pcie.0,addr=0x19&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">qemu:commandline</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><code>Ctrl+Alt+Del</code>按钮重新启动计算机，然后快速按<code>Esc</code>进入启动菜单。</p>
<table>
<thead>
<tr>
<th>c m d</th>
<th>Mean</th>
</tr>
</thead>
<tbody><tr>
<td>virsh list</td>
<td>列表</td>
</tr>
<tr>
<td>virsh start ubuntu</td>
<td>启动虚拟机</td>
</tr>
<tr>
<td>virsh suspend x</td>
<td>暂停虚拟机</td>
</tr>
<tr>
<td>virsh resume x</td>
<td>启动暂停的虚拟机</td>
</tr>
<tr>
<td>virsh shutdown x</td>
<td>正常关闭虚拟机</td>
</tr>
<tr>
<td>virsh destroy x</td>
<td>强制关闭虚拟机</td>
</tr>
<tr>
<td>virsh dominfo x</td>
<td>显示虚拟机的基本信息</td>
</tr>
<tr>
<td>virsh vncdisplay controller</td>
<td>查看该虚拟机的端口地址</td>
</tr>
<tr>
<td>virsh domname 2</td>
<td>显示id号为2的虚拟机名</td>
</tr>
<tr>
<td>virsh domid x</td>
<td>显示虚拟机id号</td>
</tr>
<tr>
<td>virsh domuuid x</td>
<td>显示虚拟机的uuid</td>
</tr>
<tr>
<td>virsh domstate x</td>
<td>显示虚拟机的当前状态</td>
</tr>
<tr>
<td>virsh dumpxml x</td>
<td>显示虚拟机的当前配置文件</td>
</tr>
<tr>
<td>virsh setmem x 512000</td>
<td>给不活动虚拟机设置内存大小</td>
</tr>
<tr>
<td>virsh edit x</td>
<td>编辑配置文件（一般是在刚定义完虚拟机之后</td>
</tr>
</tbody></table>
<p>（可能和定义虚拟机时的配置不同，因为当虚拟机启动时，需要给虚拟机分配id号、uuid、vnc端口号等等）</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2020/04/11/libfuzz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/11/libfuzz/" itemprop="url">libfuzz</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-11T12:36:21+08:00">
                2020-04-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="libfuzzer"><a href="#libfuzzer" class="headerlink" title="libfuzzer"></a>libfuzzer</h2><p>llvm、clang-3.5 是不行的，fuzz编译选项无法使用<br>多参考下 <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/src/+/master/testing/libfuzzer/">google libfuzzer</a>  学会写测试代码，其中还有大量的测试字典  <code>fuzzers/dict</code></p>
<h3 id="libfuzzer-build"><a href="#libfuzzer-build" class="headerlink" title="libfuzzer build:"></a>libfuzzer build:</h3><hr>
<p><a target="_blank" rel="noopener" href="https://github.com/Dor1s/libfuzzer-workshop">libfuzzer</a></p>
<ul>
<li><p>灵活：通过实现接口的方式使用，可以对任意函数进行fuzzing</p>
</li>
<li><p>高效：在同一进程中进行fuzzing，无需大量fork()进程</p>
</li>
<li><p>便捷：提供了API接口，便于定制化和集成</p>
<p>但是没有dirty mode，需要编译时插桩</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y make autoconf automake libtool pkg-config zlib1g-dev</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Dor1s/libfuzzer-workshop.git ~/libfuzzer</span><br><span class="line"><span class="built_in">cd</span> ~/libfuzzer/libFuzzer/ &amp;&amp; ./Fuzzer/build.sh</span><br><span class="line">当前目录生成一个 libFuzzer.a</span><br></pre></td></tr></table></figure>

<h3 id="usage"><a href="#usage" class="headerlink" title="usage"></a>usage</h3><hr>
<p><code>libFuzzer.a</code>需要被静态链接到测试程序，并且会调用入口函数</p>
<p><code>fuzzer</code>会跟踪哪些代码区域已经测试过，然后在输入数据的语料库上进行<strong>变异</strong>，来使代码覆盖率最大化。代码覆盖率的信息由 <code>LLVM</code> 的<code>SanitizerCoverage</code> 插桩提供。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LLVMFuzzerTestOneInput</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *Data, <span class="keyword">size_t</span> Size)</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">编译一个cpp</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;libFuzzer.a&quot;</span>)</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">int</span> <span class="title">LLVMFuzzerTestOneInput</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *data, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> result = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (size &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">    result = data[<span class="number">0</span>] == <span class="string">&#x27;g&#x27;</span> &amp;&amp; data[<span class="number">1</span>] == <span class="string">&#x27;o&#x27;</span> &amp;&amp; data[<span class="number">2</span>] == <span class="string">&#x27;o&#x27;</span> &amp;&amp; data[<span class="number">3</span>] == <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 代码覆盖率测试工具 -fprofile-arcs -ftest-coverage   用 afl-cov 才需要加，可不加</span></span><br><span class="line"><span class="comment">// -fsanitize-coverage=trace-pc-guard 提供代码覆盖率信息  生成 .sancov 文件才需要加</span></span><br><span class="line">clang++ -g -<span class="built_in">std</span>=c++<span class="number">11</span> -fsanitize=fuzzer,address -fprofile-arcs -ftest-coverage -fsanitize-coverage=trace-pc-guard demo.cxx ~/libfuzzer/libFuzzer/libFuzzer.a -o demo</span><br></pre></td></tr></table></figure>

<img src="/2020/04/11/libfuzz/libfuzz.assets\image-20200414104423405.png" alt="code" style="zoom: 90%;">

<p>效率感觉低了很多黄色框是检测是否错误读写，0x7fff8000是一个偏移，而不是数组。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//block_num是所有的block数量</span></span><br><span class="line"><span class="keyword">uint64_t</span> llvm_gcov_ctr[block_num];</span><br><span class="line"><span class="comment">//guard_block_num是特殊路径的block数量，也等于所有if数量+1，比如上面的 result = data[0] == &#x27;g&#x27; &amp;&amp; data[1] == &#x27;o&#x27; &amp;&amp; data[2] == &#x27;o&#x27; &amp;&amp; data[3] == &#x27;d&#x27;; 有4个if， 那么就有6个</span></span><br><span class="line"><span class="keyword">char</span> __stop___sancov_guards[guard_block_num];</span><br><span class="line"><span class="keyword">char</span> __start___sancov_cntrs[guard_block_num];</span><br><span class="line"></span><br><span class="line"><span class="comment">//伪代码</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">LLVMFuzzerTestOneInput</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *data, <span class="keyword">size_t</span> size)</span></span>&#123;</span><br><span class="line">    <span class="comment">//到达block_n的条件分支就将cmp操作数记录下来</span></span><br><span class="line">    _sanitizer_cov_trace_const_cmp4(opa, opb) <span class="comment">// -fsanitize=fuzzer</span></span><br><span class="line">    <span class="keyword">if</span>(block_n_guard_true)&#123;</span><br><span class="line">        ++_llvm_gcov_ctr[block_n];<span class="comment">//-fprofile-arcs</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="meta">#defined(FLAG(-fsanitize-coverage=trace-pc-guard))</span></span><br><span class="line">        _sanitizer_cov_trace_pc_guard(_start___sancov_guards[block_n])</span><br><span class="line">        ++__stop___sancov_guards[block_n];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(FLAG(-fsanitize=fuzzer))</span></span><br><span class="line">        ++__start___sancov_cntrs[block_n];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        ++_llvm_gcov_ctr[block_n]; <span class="comment">//-fprofile-arcs</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LLVMFuzzerTestOneInput</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *data, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line">ASAN：</span><br><span class="line"><span class="comment">//data是需要对齐的，8字节对齐. 下面的右移3，所以就是对齐8，如果右移6就是对齐64</span></span><br><span class="line"><span class="comment">//当传入 size = 4 时，那么</span></span><br><span class="line"><span class="comment">//0x7FFF8000+(data&gt;&gt;3)有如下内存值 </span></span><br><span class="line"><span class="comment">//    （Shadow bytes mask） 04 FA FA FA FA FA FA FA FA FA</span></span><br><span class="line"><span class="comment">//04就是只能访问4字节，必定==size，</span></span><br><span class="line">检测原理：</span><br><span class="line"><span class="comment">//读取1字节，当访问data[4]时，</span></span><br><span class="line"><span class="comment">//编译器加代码判断</span></span><br><span class="line"><span class="keyword">register</span> <span class="keyword">size_t</span> data_ptr = (<span class="keyword">size_t</span>)(data + <span class="number">4</span>);</span><br><span class="line"><span class="keyword">if</span>(byte(<span class="number">0x7FFF8000</span>+(data_ptr&gt;&gt;<span class="number">3</span>)) &amp;&amp;  (data_ptr&amp;<span class="number">7</span>) &gt;= byte(<span class="number">0x7FFF8000</span>+(data_ptr&gt;&gt;<span class="number">3</span>)))&#123;</span><br><span class="line">    _asan_report_load1(data_ptr);<span class="comment">//error  buffer-overflow</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取2字节，当访问((uint16_t*)data)[2]时，那么就是如下代码：</span></span><br><span class="line"><span class="keyword">register</span> <span class="keyword">size_t</span> data_ptr = (<span class="keyword">size_t</span>)(data + <span class="number">4</span>);</span><br><span class="line"><span class="keyword">if</span>(byte(<span class="number">0x7FFF8000</span>+(data_ptr&gt;&gt;<span class="number">3</span>)) &amp;&amp;  (data_ptr&amp;<span class="number">7</span>) + <span class="number">1</span> &gt;= byte(<span class="number">0x7FFF8000</span>+(data_ptr&gt;&gt;<span class="number">3</span>)))&#123;</span><br><span class="line">    _asan_report_load2(data_ptr);<span class="comment">//error  buffer-overflow</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这就是检测原理了-fsanitize=address</span></span><br><span class="line"><span class="comment">//所以crash不一定是真的crash，可能是越界读取，这并不一定造成漏洞</span></span><br></pre></td></tr></table></figure>

<p><code>libfuzzer</code>根据<code>_sanitizer_cov_trace_const_xxx</code>函数和<code> __start___sancov_cntrs</code>数组就可以很好的 构造出适合的测试数据来访问未探索的block</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (size &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="comment">//当size=3,访问了data[3]，就直接crash</span></span><br><span class="line">    result = data[<span class="number">0</span>] == <span class="string">&#x27;g&#x27;</span> &amp;&amp; data[<span class="number">1</span>] == <span class="string">&#x27;o&#x27;</span> &amp;&amp; data[<span class="number">2</span>] == <span class="string">&#x27;o&#x27;</span> &amp;&amp; data[<span class="number">3</span>] == <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ ./demo out_directory</span><br><span class="line"><span class="comment">//看下结果</span></span><br><span class="line">    </span><br><span class="line">==<span class="number">20205</span>==ABORTING</span><br><span class="line">MS: <span class="number">1</span> EraseBytes-; base unit: <span class="number">87967</span>cad164ed1722d0cbd4778fbb298016acc07</span><br><span class="line"><span class="number">0x67</span>,<span class="number">0x6f</span>,<span class="number">0x6f</span>,</span><br><span class="line">goo</span><br><span class="line">artifact_prefix=&#x27;./&#x27;; Test unit written to ./crash-3f95edc0399d06d4b84e7811dd79272c69c8ed3a</span><br><span class="line">Base64: Z29v</span><br></pre></td></tr></table></figure>

<p>那么简单的密码他能解决吗？便随手写了2个算法整个活</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;libFuzzer.a&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LLVMFuzzerTestOneInput</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *data, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"><span class="keyword">char</span> data[] = &#123; <span class="number">10</span>,<span class="number">13</span>,<span class="number">6</span>,<span class="number">28</span>,<span class="number">12</span>,<span class="number">4</span>,<span class="number">21</span>,<span class="number">57</span>,<span class="number">49</span>,<span class="number">12</span>,<span class="number">61</span>,<span class="number">49</span>,<span class="number">1</span>,<span class="number">27</span>,<span class="number">9</span>,<span class="number">125</span> &#125;;</span><br><span class="line"><span class="comment">//算法1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkinput</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* a, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!c) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span>* enc = (<span class="keyword">uint8_t</span>*)<span class="built_in">malloc</span>(c);</span><br><span class="line">    <span class="built_in">memcpy</span>(enc, a, c);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; c - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        enc[i] = enc[i] ^ enc[i + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (enc[i] != data[i]) &#123;</span><br><span class="line">            <span class="built_in">free</span>(enc);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(enc);</span><br><span class="line">    <span class="keyword">return</span> c == <span class="keyword">sizeof</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//算法2</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkinput</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* a, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>  w, i, j, k;</span><br><span class="line">    <span class="keyword">char</span> b[<span class="number">60</span>] = &#123; <span class="number">20</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">05</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">00</span>, <span class="number">20</span>, <span class="number">05</span>, <span class="number">20</span>, <span class="number">05</span> ,<span class="number">20</span>, <span class="number">05</span> ,<span class="number">05</span> ,</span><br><span class="line">        <span class="number">20</span> ,<span class="number">00</span> ,<span class="number">20</span> ,<span class="number">05</span> ,<span class="number">05</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">05</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">00</span> ,<span class="number">20</span> ,<span class="number">05</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">20</span> ,</span><br><span class="line">        <span class="number">20</span> ,<span class="number">05</span> ,<span class="number">20</span> ,<span class="number">00</span> ,<span class="number">20</span> ,<span class="number">05</span> ,<span class="number">20</span> ,<span class="number">05</span> ,<span class="number">20</span> ,<span class="number">05</span> ,<span class="number">05</span> ,<span class="number">05</span> ,<span class="number">00</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">20</span> ,</span><br><span class="line">        <span class="number">05</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">20</span> ,<span class="number">20</span> &#125;;</span><br><span class="line">    <span class="keyword">int</span> v18 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> v14 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= c - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != (c - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (a[i] == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">                v18--;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a[i] == <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">                v18++;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a[i] == <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">                v14--;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a[i] == <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">                v14++;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (((v14 * <span class="number">9</span> + v18) &lt; <span class="number">60</span>) &amp;&amp; ((v14 * <span class="number">9</span> + v18) &gt; <span class="number">-20</span>)) </span><br><span class="line">                <span class="keyword">if</span> (v18 &gt;= <span class="number">0</span> &amp;&amp; v14 &gt;= <span class="number">0</span> &amp;&amp; b[v14 * <span class="number">9</span> + v18] != <span class="number">20</span>) </span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                 <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v18 == <span class="number">7</span> &amp;&amp; v14 == <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ccount = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">LLVMFuzzerTestOneInput</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *data, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    ccount++;</span><br><span class="line">    <span class="keyword">if</span>(checkinput(data, size))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Good boy. count:%zx\n&quot;</span>, ccount);</span><br><span class="line">        <span class="keyword">int</span> t=data[<span class="number">-1</span>];<span class="comment">// 产生leak错误 作为crash</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir crackme_out <span class="comment"># fuzzer 程序可以有多个目录作为参数，此时 fuzzer 会递归遍历所有目录，把目录中的文件读入最为样本数据传给测试函数，同时会把那些可以产生新的的代码路径的样本保存到第一个目录里面。</span></span><br><span class="line">./crackme -use_cmp=1 -dump_coverage=1 -print_final_stats=1 -max_len=15 ./crackme_out <span class="comment">#不加-max_len费时几十倍</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<img src="/2020/04/11/libfuzz/libfuzz.assets\20200415053418.png" alt="out">

<p><strong>其他项目的编译方法</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用-fsanitize-coverage = trace-cmp，编译器将在比较指令和switch语句周围插入额外的工具。</span></span><br><span class="line"><span class="comment">#使用-fsanitize-coverage = trace-div，编译器将检测整数除法指令（以捕获除法的正确参数）</span></span><br><span class="line"><span class="comment">#并使用 -fsanitize-coverage = trace-gep – LLVM GEP指令 （以捕获数组索引）。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-fsanitize-coverage=[func,bb,edge]  bb:basic block</span></span><br><span class="line"><span class="comment">#With -fsanitize-coverage=trace-bb the compiler will insert __sanitizer_cov_trace_basic_block(s32 *id) before every function, basic block, or edge (depending on the value of -fsanitize-coverage=[func,bb,edge]).</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> FUZZ_CXXFLAGS=<span class="string">&quot;-O2 -fno-omit-frame-pointer -g -fsanitize=address \</span></span><br><span class="line"><span class="string">    -fsanitize-coverage=edge,indirect-calls,trace-cmp,trace-div,trace-gep,trace-pc-guard&quot;</span></span><br><span class="line">  </span><br><span class="line">CXX=<span class="string">&quot;clang++ <span class="variable">$FUZZ_CXXFLAGS</span>&quot;</span> CC=<span class="string">&quot;clang <span class="variable">$FUZZ_CXXFLAGS</span>&quot;</span> \</span><br><span class="line">    CCLD=<span class="string">&quot;clang++ <span class="variable">$FUZZ_CXXFLAGS</span>&quot;</span>  ./configure</span><br></pre></td></tr></table></figure>



<h3 id="coverage-report"><a href="#coverage-report" class="headerlink" title="coverage report"></a>coverage report</h3><p>覆盖率就是整个fuzzer一趟测试触及的 basic-block 总个数。</p>
<p>文件<code>./crackme.26107.sancov</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 转换成 .symcov</span></span><br><span class="line">sancov-8 -symbolize ./crackme crackme.26107.sancov &gt; crackme.26107.symcov</span><br></pre></td></tr></table></figure>

<p>然后使用 <a target="_blank" rel="noopener" href="http://llvm.org/svn/llvm-project/llvm/trunk/tools/sancov/coverage-report-server.py">coverage-report-server</a> 解析这个文件。这里也有<code>libfuzzer/lessons/08/coverage-report-server.py</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://llvm.org/svn/llvm-project/llvm/trunk/tools/sancov/coverage-report-server.py  -o ./coverage-report-server.py</span><br><span class="line">$ python3 ~/libfuzzer/lessons/08/coverage-report-server.py --symcov crackme.26107.symcov --srcpath ./</span><br><span class="line">Loading coverage...</span><br><span class="line">Serving at 127.0.0.1:8001</span><br></pre></td></tr></table></figure>



<img src="/2020/04/11/libfuzz/libfuzz.assets\image-20200415085429720.png" alt="cov">

<hr>
<p>算法1：事实证明它还是<strong>不能解密如算法1的简单算法</strong>，更不说解循环xor :</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">enc[i+1] &#x3D; enc[i] ^ enc[i + 1];</span><br><span class="line">enc[0] &#x3D; enc[0] ^ enc[c-1];</span><br></pre></td></tr></table></figure>

<p>原因是，它依旧不能<strong>探查前后数据的关系</strong>，<strong>几乎不可能</strong>，仅仅对一些简单条件的路径能较好的探索，一般来说足够了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./demo -<span class="built_in">help</span>=1 <span class="comment">#可以看到很多fuzz选项</span></span><br><span class="line">-use_cmp ：根据trace guard的条件追踪来引导突变</span><br><span class="line">-dump_coverage ：可视化覆盖率</span><br><span class="line">-max_len ：测试数据最大长度</span><br><span class="line">-max_total_time : 设置最长的运行时间， 单位是 秒， 这里是 300s , 也就是 5 分钟</span><br><span class="line">-print_final_stats：执行完 fuzz 后 打印统计信息</span><br><span class="line"><span class="comment">#....待补充</span></span><br></pre></td></tr></table></figure>



<p>移步【参考2】实战两个简单的CVE</p>
<h3 id="Dictionary"><a href="#Dictionary" class="headerlink" title="Dictionary"></a>Dictionary</h3><hr>
<p>就是输入的关键字合集，比如 <strong>png图片</strong> 就有 <strong>png 图片头</strong>。strcmp(phead,”xxxx”) 会直接将整个xxxx关键字替换进去，提高速度。就好比选择联想输入的候选词一样。</p>
<p><code>dictionary</code> 文件-&gt; <a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromium/src/+/master/testing/libfuzzer/fuzzers/dicts">google git</a> or <a target="_blank" rel="noopener" href="https://github.com/google/AFL/tree/master/dictionaries">google afl</a></p>
<p><code>Dictionary</code> 就是实现了这种思路。 <code>libfuzzer</code> 和 <code>afl</code> 使用的 <code>dictionary</code> 文件的语法是一样的， 所以可以直接拿 afl 里面的 <code>dictionary</code> 文件来给 <code>libfuzzer</code> 使用。</p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/docs/LibFuzzer.html#id30">libfuzzer 官网 </a></p>
<p>dict文件有用的只是由 <code>&quot;&quot;</code> 包裹的<strong>字串</strong>，<code>libfuzzer</code> 会用它们进行组合来生成样本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./program -dict=./xxx.dict -max_total_time=300 -print_final_stats=1 input_dir</span><br></pre></td></tr></table></figure>

<p>google AFL :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-x dir        - optional fuzzer dictionary (see README)</span><br></pre></td></tr></table></figure>





<h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><hr>
<p>可以使用 <code>libfuzzer</code> 把样本集进行精简。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir output_min_dir</span><br><span class="line">./program -merge=1 output_min_dir input_dir</span><br></pre></td></tr></table></figure>

<p><code>output_min_dir</code>: 精简后的样本集存放的位置<br><code>input_dir</code>: 原始样本集存放的位置</p>
<h2 id="参考-amp-推荐："><a href="#参考-amp-推荐：" class="headerlink" title="参考&amp;推荐："></a>参考&amp;推荐：</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/183307">基于Unicorn和LibFuzzer的模拟执行fuzzing</a></li>
<li><a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/71898.html">fuzz实战之libfuzzer</a></li>
<li><a target="_blank" rel="noopener" href="https://lcamtuf.blogspot.com/2015/01/afl-fuzz-making-up-grammar-with.html">Dictionary</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Dor1s/libfuzzer-workshop">libfuzzer-workshop</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-249986.htm">fuzz总结</a></li>
<li>[p1umer-2019/02/20/libfuzzer &amp; LLVM 初探](<a target="_blank" rel="noopener" href="https://p1umer.github.io/2019/02/20/libfuzzer">https://p1umer.github.io/2019/02/20/libfuzzer</a> &amp; LLVM 初探/)</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://notify-bibi.github.io/2020/04/10/afl-fuzz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="notifyのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/10/afl-fuzz/" itemprop="url">fuzz ImageMagick</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-10T12:36:21+08:00">
                2020-04-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>代码审计存在一定的局限性，一般都是静态的检测，对于复杂的算法来说，逻辑漏洞更加难以发觉，所以需要动态的代码执行技术来进行深层次的漏洞触发</code></p>
<h1 id="fuzz-的种类"><a href="#fuzz-的种类" class="headerlink" title="fuzz 的种类"></a><strong>fuzz 的种类</strong></h1><ul>
<li><code>Generation Based</code> ：通过对目标协议或文件格式建模的方法，从零开始产生测试用例，没有先前的状态</li>
<li><code>Mutation Based</code> ：基于一些规则，从已有的数据样本或存在的状态变异而来</li>
<li><code>Evolutionary</code> ：包含了上述两种，同时会根据代码覆盖率的回馈进行变异。</li>
</ul>
<h1 id="AFL"><a href="#AFL" class="headerlink" title="AFL"></a>AFL</h1><p>模糊测试（Fuzzing）技术作为漏洞挖掘最有效的手段之一。对整体程序进行Fuzzing</p>
<img src="/2020/04/10/afl-fuzz/AFL.jpg" alt="AFL" style="zoom: 40%;">

<h2 id="1，Build"><a href="#1，Build" class="headerlink" title="1，Build:"></a>1，Build:</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/google/AFL.git ~/afl-src</span><br><span class="line">cd ~/afl-src/qemu_mode</span><br><span class="line">./build_qemu_support.sh</span><br><span class="line">cd .. &amp;&amp; make install</span><br><span class="line"><span class="meta">#</span><span class="bash">开启崩溃转储，而不是交给崩溃处理程序</span></span><br><span class="line">echo core &gt;/proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure>



<h2 id="2，Build-test-target"><a href="#2，Build-test-target" class="headerlink" title="2，Build test target"></a>2，Build test target</h2><p>有两种</p>
<p>​        一种是开源项目，那么直接在源码里面插桩，使用<code>afl-clang</code>和<code>-clang++</code>（其实是将编译器编译出来的汇编文件进行插桩，使用了<code>~/afl-src/afl-as</code>，将程序的每个block都加上回调，看下一篇AFL源码解读）</p>
<p><code>-fsanitize=address</code> 就是开启<code>AddressSanitizer</code> (ASAN)内存检测工具  【参考2】<br>-g 产生符号，方便调试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clang -g -O1 -fsanitize=fuzzer                         mytarget.c <span class="comment"># Builds the fuzz target w/o sanitizers</span></span><br><span class="line">clang -g -O1 -fsanitize=fuzzer,address                 mytarget.c <span class="comment"># Builds the fuzz target with ASAN</span></span><br><span class="line">clang -g -O1 -fsanitize=fuzzer,signed-integer-overflow mytarget.c <span class="comment"># Builds the fuzz target with a part of UBSAN</span></span><br><span class="line">clang -g -O1 -fsanitize=fuzzer,memory                  mytarget.c <span class="comment"># Builds the fuzz target with MSAN</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">export LLVM_CONFIG=`which llvm-config-3.5`</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 考虑加上 --disable-shared，静态链接上去，方便模糊测试库，不然afl是不会去分析的</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -fprofile-arcs -ftest-coverage 第9点要用，不然又要编译一次</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-fsanitize-coverage=func <span class="keyword">for</span> function-level coverage (very fast).</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-fsanitize-coverage=bb <span class="keyword">for</span> basic-block-level coverage (may add up to 30% extra slowdown).</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-fsanitize-coverage=edge <span class="keyword">for</span> edge-level coverage (up to 40% slowdown).</span></span><br><span class="line"></span><br><span class="line">./configure --disable-shared CC=&quot;afl-clang&quot; CXX=&quot;afl-clang++&quot; CFLAGS=&quot;-g -fsanitize=fuzzer,address -fprofile-arcs -ftest-coverage&quot; LFLAGS=&quot;-static&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 快速编译</span> </span><br><span class="line">./configure --disable-shared CC=&quot;afl-clang-fast&quot; CXX=&quot;afl-clang-fast++&quot; CFLAGS=&quot;-g -fsanitize=fuzzer,address -fprofile-arcs -ftest-coverage&quot; LFLAGS=&quot;-static&quot;</span><br><span class="line"></span><br><span class="line">AFL_USE_ASAN=1 make</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以切换llvm版本</span></span><br><span class="line">update-alternatives </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ASAN_OPTIONS, LSAN_OPTIONS, MSAN_OPTIONS or UBSAN_OPTIONS</span></span><br><span class="line"><span class="meta">#</span><span class="bash">可以生成sancov覆盖率文件</span></span><br><span class="line">ASAN_OPTIONS=coverage=1 ./magick</span><br></pre></td></tr></table></figure>

<p>​        另一种就是闭源程序，必须要使用QEMU 运行时动态插桩，但是效率低了。方法就是afl-fuzz命令后加上-q</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#不在源程序插桩的编译，且想效率高的方法，使用clang, 比gcc好多了</span><br><span class="line">CC&#x3D;clang-3.5 CXX&#x3D;clang++-3.5 LLVM_CONFIG&#x3D;llvm-config-3.5 make</span><br></pre></td></tr></table></figure>



<p>编译好的程序在 <code>ImageMagick/utilities/.libs/magick</code><br>看下依赖情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ldd ./magick</span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007fffaef6e000)</span><br><span class="line">	libMagickCore-7.Q16HDRI.so.7 =&gt; not found</span><br><span class="line">	libMagickWand-7.Q16HDRI.so.7 =&gt; not found</span><br><span class="line">	libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007f61ceded000)</span><br></pre></td></tr></table></figure>

<p>把库<code>lnk</code>过来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#当然了，上面我们用的--disable-shared, 所以不需要了</span></span><br><span class="line"> ~/awork/ImageMagick/utilities/ [master*] ldd ./magick </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007fffcc1cc000)</span><br><span class="line">	libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007f759aa3a000)</span><br><span class="line">	libgomp.so.1 =&gt; /usr/lib/x86_64-linux-gnu/libgomp.so.1 (0x00007f759a818000)</span><br><span class="line">	libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f759a50f000)</span><br><span class="line">	libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f759a2f2000)</span><br><span class="line">	librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f759a0ea000)</span><br><span class="line">	libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f7599ee6000)</span><br><span class="line">	libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f7599cd0000)</span><br><span class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f7599906000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007f759ac54000)</span><br><span class="line"></span><br><span class="line"><span class="comment">#否则	</span></span><br><span class="line"><span class="comment">#设置库查找目录，不然ln过来还是找不到</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=./:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">ln -s  ~/awork/ImageMagick/MagickCore/.libs/libMagickCore-7.Q16HDRI.so.7.0.0 libMagickCore-7.Q16HDRI.so.7</span><br><span class="line">ln -s  ~/awork/ImageMagick/MagickWand/.libs/libMagickWand-7.Q16HDRI.so.7.0.0 libMagickWand-7.Q16HDRI.so.7</span><br><span class="line">$ ldd ./magick                                                                              </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffd2ad5d000)</span><br><span class="line">	libMagickCore-7.Q16HDRI.so.7 =&gt; ./libMagickCore-7.Q16HDRI.so.7 (0x00007f72dfe5d000)</span><br><span class="line">	libMagickWand-7.Q16HDRI.so.7 =&gt; ./libMagickWand-7.Q16HDRI.so.7 (0x00007f72df788000)</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="3，开源语料库（影响很大）"><a href="#3，开源语料库（影响很大）" class="headerlink" title="3，开源语料库（影响很大）"></a>3，开源语料库（影响很大）</h2><ul>
<li><a target="_blank" rel="noopener" href="http://lcamtuf.coredump.cx/afl/demo/">afl generated image test sets</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/fuzzer-test-suite">fuzzer-test-suite</a></li>
<li><a target="_blank" rel="noopener" href="https://samples.libav.org/">libav samples</a></li>
<li><a target="_blank" rel="noopener" href="http://samples.ffmpeg.org/">ffmpeg samples</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MozillaSecurity/fuzzdata">fuzzdata</a> 【推荐】</li>
<li><a target="_blank" rel="noopener" href="https://gitlab.anu.edu.au/lunar/moonshine">moonshine</a></li>
</ul>
<p>AFL给出的建议是最好小于1 KB，但其实可以根据自己测试的程序权衡，这在AFL文档的<code>perf_tips.txt</code>中有具体说明。</p>
<h2 id="4，Extract"><a href="#4，Extract" class="headerlink" title="4，Extract"></a>4，Extract</h2><p>测试文件太多建议先筛选，不然太慢了</p>
<h3 id="样本多样性-AFL-CMIN-移除执行相同代码的输入文件"><a href="#样本多样性-AFL-CMIN-移除执行相同代码的输入文件" class="headerlink" title="样本多样性   AFL-CMIN   移除执行相同代码的输入文件"></a>样本多样性   AFL-CMIN   移除执行相同代码的输入文件</h3><p>&emsp;&emsp;人工增加样本多样性的方法中，最简单且明显的就是搜集下载样本，放进输入文件夹。这个过程是对样本进行丰富的过程，它非常重要，但这个过程也常常引入样本的冗余，降低fuzz的效率。为了解决这个问题，需要从大量的样本中筛掉无用的样本。</p>
<p>cmin操作的是文件集合，输出的也是文件集合。</p>
<p>可能几千个文件和f一个文件来fuzz都是一样的结果，如果不进行cmin，非常低效。</p>
<p>cmin也是成功使用afl-fuzz中必不可少的一步。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#把所有图放一个文件夹samples里面</span></span><br><span class="line">afl-cmin -i ~/fuzzdata/samples/ -o output_cmin -- ./magick convert @@ /dev/null</span><br><span class="line"></span><br><span class="line">找了10分钟错误，看了afl-cmin代码好像是分配空间不足导致，不要怕用 -m none </span><br><span class="line">Error: no instrumentation output detected (perhaps crash or timeout).</span><br><span class="line"></span><br><span class="line">[+] Narrowed down to 65 files, saved <span class="keyword">in</span> <span class="string">&#x27;output_cmin&#x27;</span>.</span><br></pre></td></tr></table></figure>



<h3 id="样本复杂度-AFL-TMIN-减小单个输入文件的大小"><a href="#样本复杂度-AFL-TMIN-减小单个输入文件的大小" class="headerlink" title="样本复杂度  AFL-TMIN    减小单个输入文件的大小"></a>样本复杂度  AFL-TMIN    减小单个输入文件的大小</h3><p>&emsp;&emsp;基于字长+步长的形式，逐字节删除，然后通过插装反馈得出样本改变是否导致了程序运行路径发生了变化。若没有发生变化，可以认为删去的字节是冗余的，只用于一个指定的文件。为了使每一个test case达到表示与原始测试用例相同的代码路径所需的最小值，afl-tmin遍历test case的实际字节，逐步删除很小的数据块，直到删除任意字节都会影响到代码路径表示。</p>
<p>tmin操作的是单个文件，输出单个文件；</p>
<p>对于有效地fuzzing来说，这都是很重要的步骤，也是需要理解的重要概念</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># instrumented mode(默认)</span></span><br><span class="line">afl-tmin -i input_file -o output_file -- /path/to/program [params] @@ </span><br><span class="line"><span class="comment"># crash mode  -x 直接把非返回0的导致程序非正常退出的都作为crash。</span></span><br><span class="line">afl-tmin -x -i input_file -o output_file -- /path/to/program [params] @@</span><br><span class="line">afl-tmin -x -i output_cmin -o output_tmain -- ./magick convert @@ xx.png</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># afl-tmin 接受单个文件输入，如果语料库中文件数量特别多</span></span><br><span class="line">mkdir -p tmin_output_cmin</span><br><span class="line"><span class="comment">#速度太慢</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> output_cmin/*; <span class="keyword">do</span> afl-tmin -i <span class="variable">$i</span> -o ./tmin_<span class="variable">$i</span> -- ./magick convert @@ xx2.png; <span class="keyword">done</span>;</span><br><span class="line"><span class="comment">#建议使用下面的大佬的并发bash脚本</span></span><br><span class="line">screen ~/afl-src/afl-ptmin 8 ./queue_cmin ./output_tmin/ <span class="string">&quot;./magick convert @@ xx3.png&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#0字节文件考虑：加 -m none</span></span><br><span class="line">[!] WARNING: Down to zero bytes - check the <span class="built_in">command</span> line and mem <span class="built_in">limit</span>!</span><br></pre></td></tr></table></figure>





<h2 id="5，Usage"><a href="#5，Usage" class="headerlink" title="5，Usage:"></a>5，Usage:</h2><h3 id="fuzz"><a href="#fuzz" class="headerlink" title="fuzz"></a>fuzz</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">下载fuzz样本集</span></span><br><span class="line">git clone https://github.com/MozillaSecurity/fuzzdata.git ~/fuzz/fuzzdata</span><br><span class="line"><span class="meta">#</span><span class="bash">@@就是拿来代替-i目录的文件路径，相当于以命令行参数方式输入magick。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-t 防止大型程序执行过慢，被放到 total hangs【无响应】</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-m 内存大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash">/dev/null 不要输出文件</span></span><br><span class="line">afl-fuzz  -t 300000 -m none -i ~/fuzz/fuzzdata/fuzzdata/samples/png -o output -- ./magick convert @@ /dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash">没插桩就加上-q, 使用qemu</span></span><br></pre></td></tr></table></figure>



<h3 id="白盒"><a href="#白盒" class="headerlink" title="白盒"></a>白盒</h3><p>执行一个单例， 测试程序的插桩</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">afl-showmap -m none -o ./output.tuples -- ./magick convert ./jj.png cjj,jpg</span><br><span class="line"></span><br><span class="line">*] Executing <span class="string">&#x27;./magick&#x27;</span>...</span><br><span class="line"></span><br><span class="line">-- Program output begins --</span><br><span class="line">-- Program output ends --</span><br><span class="line">[+] Captured 3848 tuples <span class="keyword">in</span> <span class="string">&#x27;./output.tuples&#x27;</span>.</span><br><span class="line"></span><br><span class="line">执行程序打印捕获的元组（tuples），衡量衡量程序覆盖情况（分支信息）</span><br></pre></td></tr></table></figure>

<h3 id="黑盒"><a href="#黑盒" class="headerlink" title="黑盒"></a>黑盒</h3><p>就是使用QEMU模式，加上-Q</p>
<h2 id="6，加速-SCREEN"><a href="#6，加速-SCREEN" class="headerlink" title="6，加速 SCREEN"></a>6，加速 SCREEN</h2><p>还可以这样.  转自【参考4】</p>
<p><img src="/2020/04/10/afl-fuzz/image-20200413024247769.png" alt="image-20200413024247769"></p>
<h3 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h3><p>-M 参数指定一个主Fuzzer(<code>Master Fuzzer</code>)<br>-S 参数指定多个从Fuzzer(<code>Slave Fuzzer</code>)</p>
<p><code>Master Fuzzer</code>进行确定性测试（deterministic ）即对输入文件进行一些特殊而非随机的的变异；<br><code>Slave Fuzzer</code>  进行完全随机的变异。</p>
<p>我试了下，3000ms已经足够了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ screen afl-fuzz -m none -t 3000 -i ./output_tmin -o sync_dir/ -M master -- ./magick convert @@ xx3.png</span><br><span class="line">$ screen afl-fuzz -m none -t 3000 -i ./output_tmin -o sync_dir/ -S slave1 -- ./magick convert @@ xx3.png</span><br><span class="line">$ screen afl-fuzz -m none -t 3000 -i ./output_tmin -o sync_dir/ -S slave2 -- ./magick convert @@ xx3.png</span><br><span class="line">$ screen afl-fuzz -m none -t 3000 -i ./output_tmin -o sync_dir/ -S slave3 -- ./magick convert @@ xx3.png</span><br><span class="line">  ...</span><br><span class="line">分别ctrl+a+d 挂起状态,放入后台</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看所有会话</span></span><br><span class="line">screen -ls</span><br><span class="line"><span class="meta">#</span><span class="bash">进入会话</span></span><br><span class="line">screen -r session_name</span><br><span class="line"><span class="meta">#</span><span class="bash">进入会话</span></span><br><span class="line">screen -x session_name</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">kill</span></span></span><br><span class="line">screen -X -S 28006 quit</span><br><span class="line">tmux      # starts a new tmux session</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在Session下，使用ctrl+a(C-a) </span><br><span class="line">ctrl-b c  # new tab</span><br><span class="line">ctrl-b 0  # switch to tab 0</span><br><span class="line">ctrl-b d  # detach</span><br><span class="line">tmux a    # re-attach to your previous session</span><br><span class="line">ctrl-b ?  # for help</span><br></pre></td></tr></table></figure>

<p>这并不是一个很理想的解决方案，</p>
<p>&emsp;&emsp;因为这样的条件下，运行前期master fuzzer的deterministic进程太慢，而slave随机产生新的样本后，master进程的deterministic变异进程总是来不及处理；而各slave进程重复概率大，需要的同步开销过大，导致afl-fuzz的处理速度并不是线性增长。</p>
<p>&emsp;&emsp;将会在sync_dir文件夹建立master、slave1、slave2三个文件夹，三个 fuzzer各使用一个CPU。在fuzz过程中，各 fuzzer在空闲时可以读取其他文件夹中的新文件，然后对自己的queue文件进行同步和更新。</p>
<p><strong><code>afl-whatsup</code>  工具可以查看每个fuzzer的运行状态和总体运行概况，加上-s选项只显示概况，其中的数据都是所有fuzzer的总和。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-whatsup sync_dir</span><br></pre></td></tr></table></figure>

<p><code>afl-gotcpu</code>工具可以查看每个核心使用状态。</p>
<img src="/2020/04/10/afl-fuzz/afl_multi.jpg" alt="AFL" style="zoom: 48%;">

<p>【参考1】cp“ 可以看到这里的<code>-o</code>指定的是一个同步目录，并行测试中所有的Fuzzer将相互协作，在找到新的代码路径时，相互传递新的测试用例，如下图中以Fuzzer0的角度来看，它查看其它fuzzer的语料库，并通过比较id来同步感兴趣的测试用例。</p>
<h3 id="多系统"><a href="#多系统" class="headerlink" title="多系统"></a>多系统</h3><p>没有多系统先8学了</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mirrorer/afl/blob/master/docs/parallel_fuzzing.txt">官方详解</a></p>
<p>大佬方案请看【参考1】最后</p>
<h2 id="7，-When-to-stop-and-prune"><a href="#7，-When-to-stop-and-prune" class="headerlink" title="7，!!! When to stop and prune  !!!"></a>7，!!! When to stop and prune  !!!</h2><p><img src="/2020/04/10/afl-fuzz/status.png" alt="image-20200412161130767"></p>
<p>&emsp;&emsp;<em>cycles done</em> 随着周期数不断增大，其颜色也会由洋红色，逐步变为黄色、蓝色、绿色。当其变为绿色时，继续Fuzzing下去也很难有新的发现了。如上所示，fuzz程序发生异常，但是这个crash无论如何都不能触发漏洞，fuzz为什么会把它放过来？</p>
<p>&emsp;&emsp;一旦master fuzzer完成了它的第一个周期，我们可以继续并停止我们的afl-fuzz实例。我们需要合并和最小化每个实例的队列queue，并重新启动fuzzing。当使用多个fuzzing实例运行时，AFL将在根目录的syncdir目录里，根据传给afl-fuzz的参数（<strong>fuzzer的名称</strong>），为每个fuzzer维护一个独立的、同步目录。每个单独的fuzzer syncdir目录都包含一个队列queue目录，其中包含AFL能够生成的所有导致新的代码路径被检测出来的测试用例。</p>
<p>   我们需要合并每个fuzz实例的队列目录，但是因为其中会有很多重叠，我们应该尽量最小化这个新的语料库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls sync_dir</span><br><span class="line">master slave1 slave2</span><br><span class="line">mkdir queue_all</span><br><span class="line">cp sync_dir/slave*/queue/* queue_all</span><br><span class="line">cp sync_dir/master/queue/* queue_all</span><br><span class="line">afl-cmin -m none -t 3000 -i queue_all -o queue_cmin_all -- ../magick convert @@ xx3.png</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;一旦我们通过afl-cmin运行生成的队列，我们需要最小化每个结果文件，以使我们不在我们不需要的字节上浪费CPU周期。<br>&emsp;&emsp;贴一个大佬写的写的小bash脚本，称为<code>afl-ptmin</code>，它将<code>afl-tmin</code>并行化到一定数量的进程中，并证明在最小化过程中显著地提升了速度。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cores=<span class="variable">$1</span></span><br><span class="line">inputdir=<span class="variable">$2</span></span><br><span class="line">outputdir=<span class="variable">$3</span></span><br><span class="line">pids=<span class="string">&quot;&quot;</span></span><br><span class="line">total=`ls <span class="variable">$inputdir</span> | wc -l`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> `seq 1 <span class="variable">$cores</span> <span class="variable">$total</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> `seq 0 $(expr <span class="variable">$cores</span> - 1)`</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    file=`ls -Sr <span class="variable">$inputdir</span> | sed $(expr <span class="variable">$i</span> + <span class="variable">$k</span>)<span class="string">&quot;q;d&quot;</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$file</span></span><br><span class="line">    afl-tmin -m none -t 3000 -i <span class="variable">$inputdir</span>/<span class="variable">$file</span> -o <span class="variable">$outputdir</span>/<span class="variable">$file</span> -- <span class="variable">$4</span> &amp;</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">wait</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chmod +x ~/afl-src/afl-ptmin </span><br><span class="line">mkdir -m 777 queue</span><br><span class="line">screen ~/afl-src/afl-ptmin 8 ./queue_cmin_all ./queue/ <span class="string">&quot;./magick convert @@ xx3.png&quot;</span></span><br></pre></td></tr></table></figure>



<p>&emsp;&emsp;即使有并行化，这个过程仍然需要一段时间。完成后，从<code>sync_dirs</code>目录中各个<code>fuzzer</code>目录下删除以前的队列<code>queue</code>目录<strong>（/syncdirs/fuzzer1/queue/）</strong> ，然后复制**/sync_dirs/queue/**文件夹以替换旧的队列文件夹。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rm -rf sync_dir/master/queue </span><br><span class="line">rm -rf sync_dir/slave1/queue </span><br><span class="line">rm -rf sync_dir/slave2/queue </span><br><span class="line">cp -r queue/ sync_dir/master/queue </span><br><span class="line">cp -r queue/ sync_dir/slave1/queue </span><br><span class="line">cp -r queue/ sync_dir/slave2/queue</span><br></pre></td></tr></table></figure>

<p>   使用最新的最小化队列queue，我们可以在之前离开的地方继续fuzzing。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">screen afl-fuzz -m none -t 3000 -i- -o sync_dir/ -M master -- magick convert @@ xx1.png</span><br><span class="line">screen afl-fuzz -m none -t 3000 -i- -o sync_dir/ -S slave1 -- magick convert @@ xx2.png</span><br><span class="line">screen afl-fuzz -m none -t 3000 -i- -o sync_dir/ -S slave2 -- magick convert @@ xx3.png</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>   一个 -i- ,  这告诉AFL只使用syncdir中的queue/目录作为该fuzzer的种子目录，然后从那里重新启动。</p>
<h2 id><a href="#" class="headerlink" title></a></h2><h2 id="8，crashesdump-处理测试结果"><a href="#8，crashesdump-处理测试结果" class="headerlink" title="8，crashesdump 处理测试结果"></a>8，crashesdump 处理测试结果</h2><p>分类</p>
<h4 id="1-crash-exploration-mode-变异"><a href="#1-crash-exploration-mode-变异" class="headerlink" title="1. crash exploration mode 变异"></a>1. crash exploration mode 变异</h4><p>可以快速地产生很多和输入crash相关、但稍有些不同的crashes，从而判断漏洞是否足以利用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -m none -C -i poc -o peruvian-were-rabbit_out -- ~/src/LuPng/a.out @@ out.png</span><br></pre></td></tr></table></figure>

<h4 id="2-triage-crashes-信号量判断"><a href="#2-triage-crashes-信号量判断" class="headerlink" title="2.triage_crashes 信号量判断"></a>2.triage_crashes 信号量判断</h4><p>11代表了SIGSEGV信号，有可能是因为缓冲区溢出导致进程引用了无效的内存；<br>06代表了SIGABRT信号，可能是执行了abort\assert函数或double free导致;<br>….后面再收集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/afl-src/experimental/crash_triage/triage_crashes.sh fuzz_out program @@ 2&gt;&amp;1 | grep SIGNAL</span><br></pre></td></tr></table></figure>



<h4 id="3：crashwalk"><a href="#3：crashwalk" class="headerlink" title="3：crashwalk "></a>3：<a target="_blank" rel="noopener" href="https://github.com/bnagy/crashwalk">crashwalk </a></h4><p>#build</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get install gdb</span><br><span class="line">mkdir ~/tools &amp;&amp; mkdir ~/tools/go</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/jfoote/exploitable.git ~/tools/</span><br><span class="line"><span class="built_in">export</span> GOPATH=<span class="string">&quot;~/tools/go&quot;</span> &amp;&amp; <span class="built_in">export</span> CW_EXPLOITABLE=<span class="string">&quot;~/tools/exploitable/exploitable/exploitable.py&quot;</span></span><br><span class="line">go get -u github.com/bnagy/crashwalk/cmd/...</span><br></pre></td></tr></table></figure>

<p>#use<br>crashwalk支持AFL/Manual两种模式。</p>
<p>#Manual Mode  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/tools/go/bin/cwtriage -root syncdir/master/crashes/ -match id -~/program @@</span><br></pre></td></tr></table></figure>

<p>#AFL Mode   读取<strong>crashes/README.txt</strong>文件获得目标的执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/tools/go/bin/cwtriage -root syncdir -afl</span><br></pre></td></tr></table></figure>



<h4 id="4：afl-collect"><a href="#4：afl-collect" class="headerlink" title="4：afl-collect"></a>4：afl-collect</h4><p>项目地址: <a target="_blank" rel="noopener" href="https://github.com/rc0r/afl-utils">https://github.com/rc0r/afl-utils</a></p>
<p>它是<em>afl-utils</em>套件中的一个工具，同样也是基于exploitable来检查crashes的可利用性。<br>它可以自动删除无效的crash样本、删除重复样本以及自动化样本分类</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/rc0r/afl-utils</span><br><span class="line">cd afl-utils</span><br><span class="line">python3 setup.py install</span><br><span class="line"></span><br><span class="line">看输出提示，注意设置</span><br><span class="line">echo &quot;source /usr/lib/python3.5/site-packages/exploitable-1.32_rcor-py3.5.egg/exploitable/exploitable.py&quot; &gt;&gt; ~/.gdbinit</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-collect -j 8 -d crashes.db -e gdb_script ./sync_dir ./collection_dir --  /path/to/target --target-opts</span><br></pre></td></tr></table></figure>

<p>还有其他很多功能多留意，后面我再来补充</p>
<p><code>afl-collect</code><br><code>afl-cron</code><br><code>afl-minimize </code><br><code>afl-multicore </code><br><code>afl-multikill</code><br><code>afl-stats</code><br><code>afl-sync</code><br><code>afl-vcrash </code></p>
<h4 id="5：手动看异常-AddressSanitizer-ASAN"><a href="#5：手动看异常-AddressSanitizer-ASAN" class="headerlink" title="5：手动看异常  (AddressSanitizer )(ASAN)"></a>5：手动看异常  (AddressSanitizer )(ASAN)</h4><p>我们上面编译测试程序编译就开了ASAN，可以很好的分析展示出错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./magick convert crash/xxxxxxx output</span><br><span class="line"></span><br><span class="line">ERROR: AddressSanitizer:  [内存漏洞分析]</span><br><span class="line">--buffer-overflow  [stack and heap]</span><br><span class="line">--SEGV [Null point reference]</span><br><span class="line">ERROR: LeakSanitizer:  [内存泄漏分析]</span><br><span class="line">--Direct leak</span><br><span class="line">--Indirect leak</span><br></pre></td></tr></table></figure>



<h2 id="9，code-coverage-代码覆盖率"><a href="#9，code-coverage-代码覆盖率" class="headerlink" title="9，code coverage 代码覆盖率"></a>9，code coverage 代码覆盖率</h2><p>&emsp;&emsp;由于不能量化在二进制文件中执行可用的代码路径的程度，你会丢失很多信息。通过确定你没有到达代码库的哪些部分，你可以更好地调整你的测试用例种子，以便于达到更高的测试完整度。</p>
<ul>
<li>​    工具之一是<strong>GCOV</strong>，它随gcc一起发布，所以不需要再单独安装，和afl-gcc插桩编译的原理一样，gcc编译时生成插桩的程序，用于在执行时生成代码覆盖率信息。</li>
<li>​    另外一个工具是<strong>LCOV</strong>，它是GCOV的图形前端，可以收集多个源文件的gcov数据，并创建包含使用覆盖率信息注释的源代码HTML页面。</li>
<li>​    最后一个工具是<a target="_blank" rel="noopener" href="https://github.com/mrash/afl-cov">afl-cov</a>，也是一个python脚本，可以快速帮助我们调用前面两个工具处理来自afl-fuzz测试用例的代码覆盖率结果。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apt-get install lcov</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/mrash/afl-cov.git ~/afl-cov</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ~/afl-cov/afl-cov -V</span></span><br></pre></td></tr></table></figure>



<p>一，CFLAGS中添加<code>&quot;-fprofile-arcs&quot;</code>和<code>&quot;-ftest-coverage&quot;</code>选项，<br><code>--prefix</code>指定一个新的目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/xxx/build/ </span><br><span class="line">make clean</span><br><span class="line">./configure --prefix=./build-cov CC=<span class="string">&quot;clang&quot;</span> CXX=<span class="string">&quot;clang++&quot;</span> CFLAGS=<span class="string">&quot;-fprofile-arcs -ftest-coverage -g -fsanitize=address&quot;</span> --disable-shared</span><br><span class="line">AFL_USE_ASAN=1 make</span><br><span class="line"></span><br><span class="line"><span class="comment">#上面加了-fprofile-arcs -ftest-coverage参数了，所以不需要</span></span><br></pre></td></tr></table></figure>

<p>二，有了新程序，afl-cov可以将在给定输入的二进制程序中采用的代码路径与文件系统上的代码库链接起来。执行afl-cov。当afl-fuzz停止时，afl-cov将退出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">AFL_FILE和afl中的”@@”类似</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-d选项指定afl-fuzz输出目录；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">—live用于处理一个还在实时更新的AFL目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash">LD_LIBRARY_PATH 指定程序的库文件搜索路径</span></span><br><span class="line"><span class="meta">#</span><span class="bash">–enable-branch-coverage用于开启边缘覆盖率（分支覆盖率）统计</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-c用于指定源码目录；</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-e选项用来设置要执行的程序和参数</span></span><br><span class="line"></span><br><span class="line">screen ~/afl-cov/afl-cov -d ~/sync_dir/ --live --coverage-cmd --code-dir program/ -e &quot;magick convert AFL_FILE /dev/null&quot; </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">需要链接库时</span></span><br><span class="line">screen ~/afl-cov/afl-cov -d ~/sync_dir --live --enable-branch-coverage -c . -e &quot;cat AFL_FILE | LD_LIBRARY_PATH=./build-cov/lib magick convert AFL_FILE /dev/null&quot;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;完成后，afl-cov在sync_dir目录下的名为cov的目录中生成报告信息。 其中包括可以在Web浏览器中轻松查看的HTML文件，详细说明命中了哪些函数和哪行代码，以及未命中的函数和代码行。</p>
<p>当然使用afl去fuzz chrome, 如v8引擎的js编译基本可以放弃了，因为就简单的关键字function ，那要产生多少err才能通过啊。几乎不太可能去生成有效的js语法，会卡在语法parser那里。</p>
<h2 id="参考-amp-推荐："><a href="#参考-amp-推荐：" class="headerlink" title="参考&amp;推荐："></a>参考&amp;推荐：</h2><ol>
<li><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/191536.html">AFL漏洞挖掘技术漫谈（一）：用AFL开始你的第一次Fuzzing</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/lcatro/Fuzzing-ImageMagick/blob/master/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Fuzzing%E6%8C%96%E6%8E%98ImageMagick%E7%9A%84%E6%BC%8F%E6%B4%9E.md">Fuzzing-ImageMagick</a> （魔鬼！不到2天光爆破一个程序就十几个cve !）</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://foxglovesecurity.com/2016/03/15/fuzzing-workflows-a-fuzz-job-from-start-to-finish/">fuzz</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://dwfault.github.io/2019/12/20/afl-fuzz%E6%9A%B4%E5%8A%9B%E6%95%88%E7%8E%87%E6%B5%81%E5%AE%9E%E8%B7%B5/">AFL-FUZZ暴力效率流实践</a> 大佬对fuzz进行了改造，值得深究嗷</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://releases.llvm.org/4.0.1/tools/clang/SanitizerCoverage.html#sancov-tool">SanitizerCoverage</a> clang的官方文档，讲了本节很多要了解的编译参数</p>
</li>
</ol>
<p><em>这些项目必学一下，afl官方停止更新了</em></p>
<p>winafl、afl-go、WinAFL、afl-cov、kafl、android-afl</p>
<p>  <a target="_blank" rel="noopener" href="https://github.com/google/AFL/blob/master/docs/sister_projects.txt">afl衍生品</a></p>
<h2 id="下面计划学习libFuzzer"><a href="#下面计划学习libFuzzer" class="headerlink" title="下面计划学习libFuzzer"></a>下面计划学习libFuzzer</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/notify-bibi" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:qq2496424084@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://driverxdw.github.io/" title="driverxdwのblog" target="_blank">driverxdwのblog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">notify</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
